{% extends "plantilla.html" %}
{% load static %}

{% block title %}
    Estadísticas | SIAPE
{% endblock %}

{% block extra_head %}
    <link rel="stylesheet" href="{% static 'CSS/dashboard.css' %}">
    <link rel="stylesheet" href="{% static 'CSS/estadisticas_director.css' %}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="main-content"> 
    
    <nav class="dashboard-nav">
        <a href="{% url 'dashboard_director' %}" class="nav-item">
            <i class="fas fa-user-tie"></i>
            Panel Principal
        </a>
        <a href="{% url 'casos_generales' %}" class="nav-item">
            <i class="fas fa-folder-open"></i>
            Casos
        </a>
        <a href="{% url 'estadisticas_director' %}" class="nav-item active">
            <i class="fas fa-chart-bar"></i>
            Estadísticas
        </a>
        <a href="{% url 'carreras_director' %}" class="nav-item">
            <i class="fas fa-graduation-cap"></i>
            Mis Carreras
        </a>
        <a href="{% url 'gestion_asignaturas_director' %}" class="nav-item">
            <i class="fas fa-book"></i>
            Asignaturas
        </a>
        <a href="{% url 'gestion_carga_masiva_director' %}" class="nav-item">
            <i class="fas fa-file-upload"></i>
            Carga Masiva
        </a>
    </nav>

    <h1 class="page-title"><i class="fas fa-chart-line"></i> Estadísticas de Mis Carreras</h1>
    <p class="text-muted" style="margin-bottom: 30px;">Vista completa de estadísticas y métricas de las carreras que gestionas</p>

    <!-- KPIs Principales -->
    <section class="kpi-container kpi-container-asesor">
        <div class="kpi-card">
            <div class="kpi-icon icon-solicitudes">
                <i class="fas fa-file-medical"></i>
            </div>
            <div class="kpi-info">
                <span class="kpi-value">{{ total_casos|default:0 }}</span>
                <span class="kpi-label">Total Casos</span>
            </div>
        </div>

        <div class="kpi-card">
            <div class="kpi-icon icon-resueltos">
                <i class="fas fa-check-circle"></i>
            </div>
            <div class="kpi-info">
                <span class="kpi-value">{{ casos_aprobados|default:0 }}</span>
                <span class="kpi-label">Aprobados</span>
            </div>
        </div>

        <div class="kpi-card">
            <div class="kpi-icon icon-proceso">
                <i class="fas fa-clock"></i>
            </div>
            <div class="kpi-info">
                <span class="kpi-value">{{ casos_pendientes|default:0 }}</span>
                <span class="kpi-label">Pendientes</span>
            </div>
        </div>

        <div class="kpi-card">
            <div class="kpi-icon icon-proceso">
                <i class="fas fa-tools"></i>
            </div>
            <div class="kpi-info">
                <span class="kpi-value">{{ total_ajustes|default:0 }}</span>
                <span class="kpi-label">Total Ajustes</span>
            </div>
        </div>

        <div class="kpi-card">
            <div class="kpi-icon icon-resueltos">
                <i class="fas fa-check"></i>
            </div>
            <div class="kpi-info">
                <span class="kpi-value">{{ ajustes_aprobados|default:0 }}</span>
                <span class="kpi-label">Ajustes Aprobados</span>
            </div>
        </div>

        <div class="kpi-card">
            <div class="kpi-icon kpi-icon-danger">
                <i class="fas fa-times"></i>
            </div>
            <div class="kpi-info">
                <span class="kpi-value">{{ ajustes_rechazados|default:0 }}</span>
                <span class="kpi-label">Ajustes Rechazados</span>
            </div>
        </div>

        <div class="kpi-card">
            <div class="kpi-icon icon-proceso">
                <i class="fas fa-percentage"></i>
            </div>
            <div class="kpi-info">
                <span class="kpi-value">{{ tasa_aprobacion|default:0 }}%</span>
                <span class="kpi-label">Tasa Aprobación</span>
            </div>
        </div>

        <div class="kpi-card">
            <div class="kpi-icon icon-solicitudes">
                <i class="fas fa-calendar-week"></i>
            </div>
            <div class="kpi-info">
                <span class="kpi-value">{{ casos_nuevos_semana|default:0 }}</span>
                <span class="kpi-label">Nuevos (Semana)</span>
            </div>
        </div>
    </section>

    <!-- Selector de Rango de Tiempo y Generación de Reportes -->
    <section class="filters-section">
        <form method="GET" action="{% url 'estadisticas_director' %}">
            <div>
                <label for="rango">Rango de Tiempo:</label>
                <select name="rango" id="rango" onchange="this.form.submit()">
                    <option value="mes" {% if rango_seleccionado == 'mes' %}selected{% endif %}>Último Mes</option>
                    <option value="semestre" {% if rango_seleccionado == 'semestre' %}selected{% endif %}>Último Semestre</option>
                    <option value="año" {% if rango_seleccionado == 'año' %}selected{% endif %}>Último Año</option>
                    <option value="historico" {% if rango_seleccionado == 'historico' %}selected{% endif %}>Histórico Completo</option>
                </select>
            </div>
            <span class="info-text">
                <i class="fas fa-info-circle"></i> Mostrando: <strong>{{ rango_nombre }}</strong>
            </span>
        </form>
        
        <!-- Botones de Generación de Reportes -->
        <div class="report-buttons">
            <span>Generar Reporte:</span>
            <a href="{% url 'generar_reporte_pdf_director' %}?rango={{ rango_seleccionado }}" 
               class="btn btn-primary"
               target="_blank">
                <i class="fas fa-file-pdf"></i> PDF
            </a>
            <a href="{% url 'generar_reporte_excel_director' %}?rango={{ rango_seleccionado }}" 
               class="btn btn-secondary"
               download>
                <i class="fas fa-file-excel"></i> Excel
            </a>
        </div>
    </section>

    <!-- Datos JSON para los gráficos (ocultos) -->
    <script type="application/json" id="tendencia-data">{{ chart_tendencia_json|safe }}</script>
    <script type="application/json" id="ajustes-data">{{ pie_chart_data_json|safe }}</script>
    <script type="application/json" id="tipos-data">{{ bar_chart_tipos_json|safe }}</script>
    <script type="application/json" id="secciones-data">{{ bar_chart_secciones_json|safe }}</script>

    <!-- Gráficos de Tendencias -->
    <div class="charts-grid">
        <!-- Tendencia de Casos -->
        <section class="table-container">
            <div class="table-header">
                <h3>
                    <i class="fas fa-chart-line"></i> 
                    {% if rango_seleccionado == 'mes' %}
                        Casos por Día ({{ rango_nombre }})
                    {% elif rango_seleccionado == 'semestre' or rango_seleccionado == 'año' %}
                        Casos por Mes ({{ rango_nombre }})
                    {% else %}
                        Casos por Año ({{ rango_nombre }})
                    {% endif %}
                </h3>
            </div>
            <div class="chart-container-tendencia">
                <canvas id="graficoTendencia"></canvas>
            </div>
        </section>

        <!-- Estado de Ajustes -->
        <section class="table-container">
            <div class="table-header">
                <h3><i class="fas fa-chart-pie"></i> Estado de Ajustes</h3>
            </div>
            <div class="chart-container-ajustes">
                <canvas id="graficoAjustes"></canvas>
            </div>
        </section>
    </div>

    <!-- Gráficos de Distribución -->
    <div class="charts-grid">
        <!-- Ajustes Aprobados y Rechazados por Categoría -->
        <section class="table-container">
            <div class="table-header">
                <h3><i class="fas fa-tags"></i> Ajustes Aprobados y Rechazados por Categoría</h3>
            </div>
            <div class="chart-container">
                <canvas id="graficoTipos"></canvas>
            </div>
        </section>

        <!-- Secciones con Más Ajustes -->
        <section class="table-container">
            <div class="table-header">
                <h3><i class="fas fa-book-reader"></i> Secciones con Más Ajustes</h3>
            </div>
            <div class="chart-container">
                <canvas id="graficoSecciones"></canvas>
            </div>
        </section>
    </div>

    <!-- Tablas Detalladas -->
    <div class="tables-grid">
        <!-- Tabla de Estados -->
        <section class="table-container">
            <div class="table-header">
                <h3><i class="fas fa-list"></i> Casos por Estado</h3>
            </div>
            <table class="custom-table table-estados">
                <thead>
                    <tr>
                        <th>Estado</th>
                        <th>Cantidad</th>
                        <th>Porcentaje</th>
                    </tr>
                </thead>
                <tbody>
                    {% for estado in estados_stats %}
                    <tr>
                        <td>{{ estado.nombre }}</td>
                        <td><strong>{{ estado.cantidad }}</strong></td>
                        <td>{{ estado.porcentaje }}%</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </section>

        <!-- Tabla de Carreras -->
        <section class="table-container">
            <div class="table-header">
                <h3><i class="fas fa-graduation-cap"></i> Estadísticas por Carrera</h3>
            </div>
            <table class="custom-table table-carreras">
                <thead>
                    <tr>
                        <th>Carrera</th>
                        <th>Total</th>
                        <th>Aprobados</th>
                        <th>Tasa</th>
                    </tr>
                </thead>
                <tbody>
                    {% for carrera in carreras_stats %}
                    <tr>
                        <td>{{ carrera.nombre }}</td>
                        <td><strong>{{ carrera.total }}</strong></td>
                        <td>{{ carrera.aprobados }}</td>
                        <td>{{ carrera.tasa_aprobacion }}%</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="4" style="text-align: center; color: #999;">No hay datos disponibles</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </section>
    </div>

</div>

<script src="{% static 'JS/estadisticas_director.js' %}"></script>
{% endblock %}
