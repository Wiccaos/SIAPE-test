{% extends "plantilla.html" %}
{% load static %}

{% block title %}
    Detalle de Caso | SIAPE
{% endblock %}

{% block extra_head %}
    <link rel="stylesheet" href="{% static 'CSS/dashboard.css' %}">
{% endblock %}

{% block content %}
<div class="main-content">

    <nav class="dashboard-nav">
        {% if user.perfil.rol.nombre_rol == "Coordinadora de Inclusión" %}
            <a href="{% url 'dashboard_coordinadora' %}" class="nav-item">
                <i class="fas fa-home"></i> Panel Principal
            </a>
            <a href="{% url 'casos_generales' %}" class="nav-item active"> <i class="fas fa-folder-open"></i> Casos
            </a>
            <a href="{% url 'panel_control_coordinadora' %}" class="nav-item">
                <i class="fas fa-tachometer-alt"></i> Panel de Control
            </a>
        {% elif user.perfil.rol.nombre_rol == "Asesora Pedagógica" %}
            <a href="{% url 'dashboard_asesor' %}" class="nav-item">
                <i class="fas fa-home"></i> Panel Principal
            </a>
            <a href="{% url 'casos_generales' %}" class="nav-item active"> <i class="fas fa-folder-open"></i> Casos
            </a>
            <a href="{% url 'panel_control_coordinadora' %}" class="nav-item">
                <i class="fas fa-tachometer-alt"></i> Panel de Control
            </a>
        {% else %}
            <a href="{% url 'home' %}" class="nav-item">
                <i class="fas fa-home"></i> Panel Principal
            </a>
            <a href="{% url 'casos_generales' %}" class="nav-item active"> <i class="fas fa-folder-open"></i> Casos
            </a>
        {% endif %}
    </nav>

    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} custom-alert-{{ message.tags }}">
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}

    <div class="detalle-caso-grid">

        <div class="detalle-col-left">

            <div class="panel-section">
                <h3><i class="fas fa-user-graduate"></i> Información del Estudiante</h3>
                <div class="detalle-card-content">
                    <p><strong>Nombre:</strong> {{ estudiante.nombres }} {{ estudiante.apellidos }}</p>
                    <p><strong>RUT:</strong> {{ estudiante.rut }}</p>
                    <p><strong>Email:</strong> {{ estudiante.email }}</p>
                    <p><strong>Teléfono:</strong> {{ estudiante.numero|default:'No especificado' }}</p>
                    <p><strong>Carrera:</strong> {{ estudiante.carreras.nombre }}</p>
                </div>
            </div>

            <div class="panel-section">
                <h3><i class="fas fa-clipboard-check"></i> Estado del Caso</h3>
                <div class="detalle-card-content">
                    <p><strong>Estado Actual:</strong> 
                        {% if solicitud.estado == 'aprobado' %}
                            <span class="status status-aprobado">{{ solicitud.get_estado_display }}</span>
                        {% elif solicitud.estado == 'rechazado' %}
                            <span class="status status-rechazado">{{ solicitud.get_estado_display }}</span>
                        {% else %}
                            <span class="status status-en_proceso">{{ solicitud.get_estado_display }}</span>
                        {% endif %}
                    </p>
                    <p><strong>Asunto (Estudiante):</strong> {{ solicitud.asunto }}</p>
                    <p><strong>Fecha Solicitud:</strong> {{ solicitud.created_at|date:"d/m/Y H:i" }}</p>
                </div>
            </div>

            <div class="panel-section">
                <h3><i class="fas fa-paperclip"></i> Evidencias Adjuntas</h3>
                <div class="detalle-card-content">
                    {% if evidencias %}
                        <ul>
                        {% for evidencia in evidencias %}
                            <li>
                                <a href="{{ evidencia.archivo.url }}" target="_blank" class="link-rojo">
                                    <i class="fas fa-file-alt"></i> {{ evidencia.archivo.name|cut:"evidencias/" }}
                                </a>
                            </li>
                        {% endfor %}
                        </ul>
                    {% else %}
                        <div class="empty-state" style="padding: 10px 0;">
                            <p style="font-size: 0.9rem;">No hay evidencias adjuntas.</p>
                        </div>
                    {% endif %}
                </div>
            </div>

        </div> <div class="detalle-col-right">

            <div class="panel-section">
                <h3><i class="fas fa-comments"></i> Historial de Entrevistas</h3>
                <div class="detalle-card-content">
                    {% if entrevistas_list %}
                        {% for entrevista in entrevistas_list %}
                        <div class="detalle-sub-card">
                            <p><strong>Fecha:</strong> {{ entrevista.fecha_entrevista|date:"d/m/Y H:i" }}</p>
                            <p><strong>Modalidad:</strong> {{ entrevista.modalidad }}</p>
                            <p><strong>Estado:</strong> {{ entrevista.get_estado_display }}</p>
                            <p><strong>Realizada por:</strong> {{ entrevista.coordinadora.usuario.first_name }} {{ entrevista.coordinadora.usuario.last_name }}</p>
                            <p><strong>Notas:</strong></p>
                            <pre class="notas-box">{{ entrevista.notas|default:'Sin notas.' }}</pre>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="empty-state" style="padding: 10px 0;">
                            <p style="font-size: 0.9rem;">No hay entrevistas registradas.</p>
                        </div>
                    {% endif %}
                </div>
            </div>

            <div class="panel-section">
                <h3><i class="fas fa-tools"></i> Ajustes Asignados</h3>
                <div class="detalle-card-content">
                    {% if ajustes_asignados %}
                        {% for item in ajustes_asignados %}
                        <div class="detalle-sub-card">
                            <p><strong>Categoría:</strong> {{ item.ajuste_razonable.categorias_ajustes.nombre_categoria }}</p>
                            <p><strong>Descripción:</strong></p>
                            <pre class="notas-box">{{ item.ajuste_razonable.descripcion }}</pre>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="empty-state" style="padding: 10px 0;">
                            <p style="font-size: 0.9rem;">Aún no se han asignado ajustes.</p>
                        </div>
                    {% endif %}
                </div>
            </div>

        </div> <div class="detalle-card-full-width">
            <div class="panel-section">
                <h3>
                    <i class="fas fa-file-medical-alt"></i> Descripción del Caso (Formulación Profesional)
                </h3>
                
                <form method="POST" action="{% url 'actualizar_descripcion_caso' solicitud.id %}" class="form-descripcion-caso">
                    {% csrf_token %}
                    <div class="form-group">
                        <label for="descripcion_caso">
                            Aquí puedes registrar la descripción del caso, el análisis de la entrevista y la formulación para los siguientes roles.
                        </label>
                        <textarea name="descripcion_caso" id="descripcion_caso" rows="10">{{ solicitud.descripcion }}</textarea>
                    </div>
                    <div class="form-actions" style="justify-content: flex-end;">
                        <button type="submit" class="btn-accion btn-agendar">
                            <i class="fas fa-save"></i> Guardar Descripción
                        </button>
                    </div>
                </form>
                
                <hr style="border: 0; border-top: 1px solid #eee; margin: 25px 0;">
                
                <h3 style="border: none; margin-bottom: 15px;">Acciones del Caso</h3>
                <div class="acciones-casos">
                    <button type="button" class="btn-accion btn-agendar" onclick="abrirModalAgendar({{ solicitud.id }}, '{{ solicitud.asunto }}')">
                        <i class="fas fa-calendar-plus"></i> Agendar (Nueva) Cita
                    </button>
                    <button type="button" class="btn-accion btn-accion-green">
                        <i class="fas fa-arrow-right"></i> Enviar a Asesora Técnica
                    </button>
                </div>

            </div>
        </div>
        
        <div style="grid-column: 1 / -1; margin-top: 15px;">
            <a href="{% url 'casos_generales' %}" class="btn-volver">
                <i class="fas fa-chevron-left"></i> Volver a la lista de Casos
            </a>
        </div>

    </div> </div> {% endblock %}