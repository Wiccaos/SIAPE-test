{% extends "plantilla.html" %}
{% load static %}

{% block title %}
    Gesti√≥n de Citas - Coordinadora | SIAPE
{% endblock %}

{% block extra_head %}
    <link rel="stylesheet" href="{% static 'CSS/dashboard.css' %}">
    <link rel="stylesheet" href="{% static 'CSS/formulario.css' %}">
{% endblock %}

{% block content %}
<div class="main-content"> 
    
    <nav class="dashboard-nav">
        <a href="{% url 'dashboard_encargado_inclusion' %}" class="nav-item">
            <i class="fas fa-home"></i>
            Panel Principal
        </a>
        <a href="{% url 'casos_generales' %}" class="nav-item">
            <i class="fas fa-folder-open"></i>
            Casos
        </a>
        <a href="{% url 'panel_control_encargado_inclusion' %}" class="nav-item active">
            <i class="fas fa-calendar-alt"></i>
            Gesti√≥n de Citas
        </a>
        <a href="{% url 'gestionar_horarios_bloqueados' %}" class="nav-item">
            <i class="fas fa-ban"></i>
            Horarios Bloqueados
        </a>
    </nav>

    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} custom-alert-{{ message.tags }}">
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}

    <div class="panel-control-container casos-dos-columnas">
        
        <div class="panel-col-stack">
            
            <div class="panel-section panel-section-scrollable">
                <h3><i class="fas fa-calendar-day"></i> Citas del D√≠a</h3>
                <div class="panel-section-content">
                    {% if citas_hoy_list %}
                        {% for cita in citas_hoy_list %}
                            <div class="cal-cita-item estado-{{ cita.estado }}">
                                <span class="cal-cita-hora"><i class="fas fa-clock"></i> {{ cita.fecha_entrevista|date:"H:i" }} hrs</span>
                                <strong class="cal-cita-estudiante">{{ cita.solicitudes.estudiantes.nombres }} {{ cita.solicitudes.estudiantes.apellidos }}</strong>
                                <span class="cal-cita-asunto">{{ cita.solicitudes.asunto }}</span>
                                <span class="cal-cita-estado">Estado: {{ cita.get_estado_display }}</span>
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="empty-state p-10">
                            <i class="fas fa-check-circle text-muted"></i>
                            <p class="text-small">No hay citas programadas para hoy.</p>
                        </div>
                    {% endif %}
                </div>
            </div>

            <div class="panel-section panel-section-scrollable">
                <h3><i class="fas fa-calendar-week"></i> Pr√≥ximas Citas de la Semana</h3>
                <div class="panel-section-content">
                    {% if citas_semana_list %}
                        {% for cita in citas_semana_list %}
                            <div class="cal-cita-item estado-{{ cita.estado }}">
                                <span class="cal-cita-hora"><i class="fas fa-calendar-alt"></i> {{ cita.fecha_entrevista|date:"d/m/Y H:i" }} hrs</span>
                                <strong class="cal-cita-estudiante">{{ cita.solicitudes.estudiantes.nombres }} {{ cita.solicitudes.estudiantes.apellidos }}</strong>
                                <span class="cal-cita-asunto">{{ cita.solicitudes.asunto }}</span>
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="empty-state p-10">
                            <i class="fas fa-check-circle text-muted"></i>
                            <p class="text-small">No hay m√°s citas programadas para esta semana.</p>
                        </div>
                    {% endif %}
                </div>
            </div>

        </div> <div class="panel-section">
            <h3><i class="fas fa-calendar-alt"></i> Calendario de Citas</h3>
            
            <div class="cal-layout-container grid-single-column">
                
                <div class="cal-widget">
                    <div class="detalle-card" id="card-calendario-panel">
                        <div class="calendario-header" id="cal-header"></div>
                        <div class="cal-nav">
                            <button id="cal-prev" class="btn-accion btn-accion-gray btn-accion-small"><i class="fas fa-chevron-left"></i> Ant</button>
                            <button id="cal-today" class="btn-accion btn-accion-gray btn-accion-small">Hoy</button>
                            <button id="cal-next" class="btn-accion btn-accion-gray btn-accion-small">Sig <i class="fas fa-chevron-right"></i></button>
                        </div>
                        <div class="calendario-grid" id="cal-grid-body"></div>
                        <div class="calendario-leyenda calendario-leyenda-mt">
                            <div><span class="dot dot-entrevista"></span> D√≠a con Cita(s)</div>
                            <div><span class="dot dot-feriado"></span> Feriado</div>
                        </div>
                    </div>
                </div>

                <div class="cal-citas-list">
                    <h4 id="cal-citas-titulo">Citas del D√≠a</h4>
                    <div id="cal-citas-dia">
                        <div class="empty-state empty-state-10">
                            <i class="fas fa-calendar-day empty-state-icon"></i>
                            <p class="empty-state-text">Seleccione un d√≠a del calendario para ver las citas programadas.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div> </div> {% if citas_pendientes_confirmar %}
    <div class="panel-section citas-detalle">
        <h3><i class="fas fa-exclamation-circle icon-warning"></i> Citas Pendientes de Confirmar Asistencia</h3>
        <div class="cita-detalle-item cita-detalle-header">
            <div>Estudiante / Caso</div>
            <div>Fecha y Hora de Cita</div>
            <div>Modalidad</div>
            <div>Estado</div>
            <div>Acciones</div>
        </div>
        {% for cita in citas_pendientes_confirmar %}
            <div class="cita-detalle-item cita-detalle-item-5cols">
                <div>
                    <div class="cita-estudiante">{{ cita.solicitudes.estudiantes.nombres }} {{ cita.solicitudes.estudiantes.apellidos }}</div>
                    <div class="caso-asunto caso-asunto-small">{{ cita.solicitudes.asunto }}</div>
                </div>
                <div class="cita-fecha-hora cita-fecha-hora-pendiente">
                    <i class="fas fa-clock"></i> {{ cita.fecha_entrevista|date:"d/m/Y H:i" }}
                </div>
                <div>
                    <span class="cita-modalidad">{{ cita.modalidad }}</span>
                </div>
                <div>
                    <span class="status status-en_proceso">{{ cita.get_estado_display }}</span>
                </div>
                <div class="acciones-container">
                    <button type="button" class="btn-accion btn-asignar btn-accion-small" onclick="abrirModalConfirmar({{ cita.id }}, 'realizada', '{{ cita.solicitudes.asunto }}')">
                        <i class="fas fa-check"></i> Realizada
                    </button>
                    <button type="button" class="btn-accion btn-accion-red btn-accion-small" onclick="abrirModalConfirmar({{ cita.id }}, 'no_asistio', '{{ cita.solicitudes.asunto }}')">
                        <i class="fas fa-times"></i> No asisti√≥
                    </button>
                </div>
            </div>
        {% endfor %}
    </div>
    {% endif %}

    <div class="panel-section citas-detalle">
        <h3><i class="fas fa-history"></i> Historial de Citas (Semana Actual)</h3>
        {% if citas_pasadas_semana_list %}
            <div class="cita-detalle-item cita-detalle-header">
                <div>Estudiante / Caso</div>
                <div>Fecha y Hora</div>
                <div>Modalidad</div>
                <div>Estado</div>
                <div>Acciones</div>
            </div>
            {% for cita in citas_pasadas_semana_list %}
                <div class="cita-detalle-item cita-detalle-item-5cols">
                    <div>
                        <div class="cita-estudiante">{{ cita.solicitudes.estudiantes.nombres }} {{ cita.solicitudes.estudiantes.apellidos }}</div>
                        <div class="caso-asunto caso-asunto-small">{{ cita.solicitudes.asunto }}</div>
                    </div>
                    <div class="cita-fecha-hora {% if cita.estado == 'no_asistio' %}cita-fecha-hora-no-asistio{% endif %}">
                        <i class="fas fa-clock"></i> {{ cita.fecha_entrevista|date:"d/m/Y H:i" }}
                    </div>
                    <div>
                        <span class="cita-modalidad">{{ cita.modalidad }}</span>
                    </div>
                    <div>
                        {% if cita.estado == 'realizada' %}
                        <span class="status status-aprobado">{{ cita.get_estado_display }}</span>
                        {% else %}
                        <span class="status status-rechazado">{{ cita.get_estado_display }}</span>
                        {% endif %}
                    </div>
                    <div class="acciones-container">
                        {% if cita.estado == 'no_asistio' %}
                            <button type="button" class="btn-accion btn-agendar btn-accion-small" onclick="abrirModalReagendar({{ cita.id }}, '{{ cita.solicitudes.asunto }}', '{{ cita.modalidad }}')">
                                <i class="fas fa-redo"></i> Reagendar
                            </button>
                        {% endif %}
                        <button type="button" class="btn-accion btn-accion-gray btn-accion-small" onclick="abrirModalEditarNotas({{ cita.id }}, '{{ cita.notas|escapejs }}', '{{ cita.solicitudes.asunto }}')">
                            <i class="fas fa-edit"></i> Ver/Editar Notas
                        </button>
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <div class="empty-state">
                <i class="fas fa-calendar-times"></i>
                <p>No hay historial de citas (realizadas o no asistidas) esta semana.</p>
            </div>
        {% endif %}
    </div>

    <div id="modalConfirmar" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h4><i class="fas fa-check-circle"></i> Confirmar Cita</h4>
                <button class="close" onclick="cerrarModalConfirmar()">&times;</button>
            </div>
            <form method="post" action="" id="formConfirmar">
                {% csrf_token %}
                <input type="hidden" name="accion" id="confirmar_accion">
                
                <div class="form-group">
                    <label>Caso:</label>
                    <input type="text" id="confirmar_caso_asunto" class="input-readonly" readonly>
                </div>
                
                <div class="form-group">
                    <label for="notas_adicionales">Notas Adicionales (opcional):</label>
                    <textarea name="notas_adicionales" id="notas_adicionales" placeholder="Agregar notas sobre la confirmaci√≥n de la cita..."></textarea>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn-accion btn-accion-gray" onclick="cerrarModalConfirmar()">Cancelar</button>
                    <button type="submit" class="btn-accion btn-accion-green" id="btnConfirmarSubmit">
                        <i class="fas fa-check"></i> Confirmar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="modalEditarNotas" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h4><i class="fas fa-edit"></i> Editar Notas de la Cita</h4>
                <button class="close" onclick="cerrarModalEditarNotas()">&times;</button>
            </div>
            <form method="post" action="" id="formEditarNotas">
                {% csrf_token %}
                
                <div class="form-group">
                    <label>Caso:</label>
                    <input type="text" id="editar_notas_caso_asunto" class="input-readonly" readonly>
                </div>
                
                <div class="form-group">
                    <label for="notas">Notas:</label>
                    <textarea name="notas" id="editar_notas_textarea" required placeholder="Agregar o editar las notas de la cita..."></textarea>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn-accion btn-accion-gray" onclick="cerrarModalEditarNotas()">Cancelar</button>
                    <button type="submit" class="btn-accion btn-accion-gray">
                        <i class="fas fa-save"></i> Guardar Notas
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="modalReagendar" class="modal">
        <div class="modal-content modal-calendario">
            <div class="modal-header">
                <h4><i class="fas fa-redo"></i> Reagendar Cita</h4>
                <button class="close" onclick="cerrarModalReagendar()">&times;</button>
            </div>
            <form method="post" action="" id="formReagendar">
                {% csrf_token %}
                
                <div class="form-group">
                    <label>Caso:</label>
                    <input type="text" id="reagendar_caso_asunto" class="input-readonly" readonly>
                </div>
                
                <div class="form-group">
                    <label>
                        <strong>Seleccione Nueva Fecha y Hora:</strong>
                    </label>
                    <p class="form-hint">
                        Seleccione un d√≠a del calendario y luego el horario disponible.
                    </p>

                    <!-- Contenedor del calendario -->
                    <div class="cal-layout-container">
                        
                        <!-- Columna 1: El Calendario -->
                        <div class="cal-widget">
                            <div class="detalle-card" id="card-calendario-reagendar">
                                <div class="calendario-header" id="cal-header-reagendar">
                                    <!-- El mes se inserta aqu√≠ por JS -->
                                </div>
                                <div class="cal-nav">
                                    <button type="button" id="cal-prev-reagendar" class="btn-accion btn-accion-gray btn-accion-small"><i class="fas fa-chevron-left"></i> Ant</button>
                                    <button type="button" id="cal-today-reagendar" class="btn-accion btn-accion-gray btn-accion-small">Hoy</button>
                                    <button type="button" id="cal-next-reagendar" class="btn-accion btn-accion-gray btn-accion-small">Sig <i class="fas fa-chevron-right"></i></button>
                                </div>
                                <div class="calendario-grid" id="cal-grid-body-reagendar">
                                    <!-- Los d√≠as se insertan aqu√≠ por JS -->
                                </div>
                                <div class="calendario-leyenda calendario-leyenda-mt">
                                    <div><span class="dot dot-disponible"></span> D√≠a Disponible</div>
                                    <div><span class="dot dot-lleno"></span> D√≠a Completo</div>
                                    <div><span class="dot dot-feriado"></span> Feriado</div>
                                </div>
                            </div>
                        </div>

                        <!-- Columna 2: El Selector de Hora -->
                        <div class="cal-citas-list">
                            <h4 id="cal-citas-titulo-reagendar">Horarios Disponibles</h4>
                            <div id="cal-citas-dia-reagendar">
                                <div class="empty-state empty-state-10">
                                    <i class="fas fa-calendar-day empty-state-icon"></i>
                                    <p class="empty-state-text">Seleccione un d√≠a del calendario para ver los horarios disponibles.</p>
                                </div>
                                <div class="horarios-botones horarios-botones-hidden" id="horarios-botones-reagendar"></div>
                                <input type="hidden" id="hora_reagendar" name="hora_reagendar" required>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Input oculto para enviar la fecha seleccionada -->
                    <input type="hidden" id="fecha_reagendar" name="fecha_reagendar" required>
                </div>
                
                <div class="form-group">
                    <label for="nueva_modalidad">Modalidad:</label>
                    <select name="nueva_modalidad" id="nueva_modalidad">
                        <option value="">Seleccione una modalidad</option>
                        <option value="Presencial">Presencial</option>
                        <option value="Virtual">Virtual</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="notas_reagendamiento">Notas (opcional):</label>
                    <textarea name="notas_reagendamiento" id="notas_reagendamiento" placeholder="Agregar notas sobre el reagendamiento..."></textarea>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn-accion btn-accion-gray" onclick="cerrarModalReagendar()">Cancelar</button>
                    <button type="submit" class="btn-accion btn-agendar">
                        <i class="fas fa-save"></i> Reagendar
                    </button>
                </div>
            </form>
        </div>
    </div>

</div>

<script>
    // --- Funciones de Modales (Limpiadas) ---
    
    function abrirModalConfirmar(entrevistaId, accion, asunto) {
        document.getElementById('confirmar_accion').value = accion;
        document.getElementById('confirmar_caso_asunto').value = asunto;
        // ***** URL ACTUALIZADA *****
        document.getElementById('formConfirmar').action = '{% url "encargado_inclusion_confirmar_cita" 0 %}'.replace('0', entrevistaId);
        
        const btnSubmit = document.getElementById('btnConfirmarSubmit');
        if (accion === 'realizada') {
            btnSubmit.innerHTML = '<i class="fas fa-check"></i> Marcar como Realizada';
            btnSubmit.className = 'btn-accion btn-accion-green';
        } else {
            btnSubmit.innerHTML = '<i class="fas fa-times"></i> Marcar como No Asisti√≥';
            btnSubmit.className = 'btn-accion btn-accion-red';
        }
        
        document.getElementById('modalConfirmar').style.display = 'block';
    }

    function cerrarModalConfirmar() {
        document.getElementById('modalConfirmar').style.display = 'none';
        document.getElementById('notas_adicionales').value = '';
    }

    function abrirModalEditarNotas(entrevistaId, notas, asunto) {
        document.getElementById('editar_notas_caso_asunto').value = asunto;
        document.getElementById('editar_notas_textarea').value = notas.replace(/\\n/g, '\n');
        // ***** URL ACTUALIZADA *****
        document.getElementById('formEditarNotas').action = '{% url "encargado_inclusion_editar_notas_cita" 0 %}'.replace('0', entrevistaId);
        document.getElementById('modalEditarNotas').style.display = 'block';
    }

    function cerrarModalEditarNotas() {
        document.getElementById('modalEditarNotas').style.display = 'none';
    }

    // --- L√ìGICA DEL CALENDARIO PARA REAGENDAR CITA ---
    let navDateReagendar = new Date();
    const hoyReagendar = new Date();
    const hoyStrReagendar = `${hoyReagendar.getFullYear()}-${String(hoyReagendar.getMonth() + 1).padStart(2, '0')}-${String(hoyReagendar.getDate()).padStart(2, '0')}`;
    let diaSeleccionadoReagendar = null; 
    let diaSeleccionadoStrReagendar = null;
    let calendarioDataReagendar = {};

    const calHeaderReagendar = document.getElementById('cal-header-reagendar');
    const calGridBodyReagendar = document.getElementById('cal-grid-body-reagendar');
    const btnPrevReagendar = document.getElementById('cal-prev-reagendar');
    const btnNextReagendar = document.getElementById('cal-next-reagendar');
    const btnTodayReagendar = document.getElementById('cal-today-reagendar');
    const citasDiaContainerReagendar = document.getElementById('cal-citas-dia-reagendar');
    const citasDiaTituloReagendar = document.getElementById('cal-citas-titulo-reagendar');
    const horariosBotonesReagendar = document.getElementById('horarios-botones-reagendar');
    const fechaHiddenInputReagendar = document.getElementById('fecha_reagendar');
    const horaHiddenInputReagendar = document.getElementById('hora_reagendar');
    
    const meses = [
        "Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio",
        "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"
    ];

    async function fetchCalendarioDelMesReagendar(year, month) {
        if (!calHeaderReagendar) return;
        
        calHeaderReagendar.innerText = `Cargando ${meses[month]} ${year}...`;
        
        try {
            const monthStr = `${year}-${String(month + 1).padStart(2, '0')}`;
            const response = await fetch(`/api/calendario-disponible/?month=${monthStr}`);
            
            if (!response.ok) throw new Error('Error de red');
            
            calendarioDataReagendar = await response.json();
            renderCalendarReagendar(year, month);

        } catch (error) {
            console.error('Error fetching calendario:', error);
            if (calHeaderReagendar) calHeaderReagendar.innerText = "Error al cargar calendario";
        }
    }

    function mostrarHorariosDelDiaReagendar(fechaStr, diaEl) {
        if (!calHeaderReagendar || !horariosBotonesReagendar) return;
        
        const [year, month, day] = fechaStr.split('-');
        citasDiaTituloReagendar.innerText = `Horarios para ${day}/${month}/${year}`;

        if (diaSeleccionadoReagendar) {
            diaSeleccionadoReagendar.classList.remove('cal-day-selected');
        }
        
        if(diaEl) {
            diaEl.classList.add('cal-day-selected');
            diaSeleccionadoReagendar = diaEl;
            diaSeleccionadoStrReagendar = fechaStr;
        } else {
            diaSeleccionadoReagendar = calGridBodyReagendar.querySelector(`[data-fecha="${fechaStr}"]`);
            if (diaSeleccionadoReagendar) {
                diaSeleccionadoReagendar.classList.add('cal-day-selected');
            }
        }

        if (fechaHiddenInputReagendar) {
            fechaHiddenInputReagendar.value = fechaStr;
        }
        if (horaHiddenInputReagendar) {
            horaHiddenInputReagendar.value = '';
        }

        const slotsDisponibles = (calendarioDataReagendar && calendarioDataReagendar.slotsDetallados && calendarioDataReagendar.slotsDetallados[fechaStr]) ? calendarioDataReagendar.slotsDetallados[fechaStr] : [];
        const slotsNoDisponibles = (calendarioDataReagendar && calendarioDataReagendar.slotsNoDisponibles && calendarioDataReagendar.slotsNoDisponibles[fechaStr]) ? calendarioDataReagendar.slotsNoDisponibles[fechaStr] : [];
        
        // Asegurarse de que horariosBotonesReagendar est√© en el DOM
        if (horariosBotonesReagendar && horariosBotonesReagendar.parentElement !== citasDiaContainerReagendar) {
            citasDiaContainerReagendar.appendChild(horariosBotonesReagendar);
        }
        
        const existingEmptyStates = citasDiaContainerReagendar.querySelectorAll('.empty-state');
        existingEmptyStates.forEach(el => el.remove());
        
        horariosBotonesReagendar.innerHTML = '';
        horariosBotonesReagendar.classList.remove('horarios-botones-hidden');
        horariosBotonesReagendar.style.display = 'flex';

        const allSlots = [];
        for (let h = 9; h <= 17; h++) {
            allSlots.push(`${h.toString().padStart(2, '0')}:00`);
        }

        for (const slot of allSlots) {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'btn-horario';
            const horaInicio = parseInt(slot.split(':')[0]);
            const horaFin = horaInicio + 1;
            btn.textContent = `${slot} - ${horaFin.toString().padStart(2, '0')}:00`;
            btn.dataset.hora = slot;

            const estaDisponible = slotsDisponibles.includes(slot);
            const estaNoDisponible = slotsNoDisponibles.includes(slot);

            if (estaNoDisponible) {
                btn.disabled = true;
                btn.classList.add('no-disponible');
                btn.title = 'Hora no disponible (ya tomada o bloqueada)';
            } else if (estaDisponible) {
                btn.disabled = false;
                btn.classList.remove('no-disponible');
                btn.addEventListener('click', function() {
                    horariosBotonesReagendar.querySelectorAll('.btn-horario').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    if (horaHiddenInputReagendar) {
                        horaHiddenInputReagendar.value = slot;
                    }
                });
            } else {
                btn.disabled = true;
                btn.classList.add('no-disponible');
                btn.title = 'Hora no disponible';
            }
            
            horariosBotonesReagendar.appendChild(btn);
        }
        
        if (slotsDisponibles.length === 0) {
            horariosBotonesReagendar.insertAdjacentHTML('afterend', `
                <div class="empty-state empty-state-10" style="margin-top: 15px;">
                    <i class="fas fa-calendar-times"></i>
                    <p class="empty-state-text">No hay horarios disponibles para este d√≠a.</p>
                </div>
            `);
        }
    }
    
    function renderCalendarReagendar(year, month) {
        if (!calHeaderReagendar) return;
        
        calHeaderReagendar.innerText = `${meses[month]} ${year}`;
        
        calGridBodyReagendar.innerHTML = `
            <div class="cal-day-header">L</div>
            <div class="cal-day-header">M</div>
            <div class="cal-day-header">X</div>
            <div class="cal-day-header">J</div>
            <div class="cal-day-header">V</div>
            <div class="cal-day-header">S</div>
            <div class="cal-day-header">D</div>
        `;
        
        const primerDiaDelMes = new Date(year, month, 1);
        const ultimoDiaDelMes = new Date(year, month + 1, 0);
        const ultimoDiaNum = ultimoDiaDelMes.getDate();
        let diaInicioSemana = (primerDiaDelMes.getDay() + 6) % 7;
        const ultimoDiaMesAnterior = new Date(year, month, 0).getDate();

        for (let i = diaInicioSemana; i > 0; i--) {
            const dia = ultimoDiaMesAnterior - i + 1;
            const dayDiv = document.createElement('div');
            dayDiv.classList.add('cal-day', 'other-month');
            dayDiv.innerText = dia;
            calGridBodyReagendar.appendChild(dayDiv);
        }

        for (let dia = 1; dia <= ultimoDiaNum; dia++) {
            const dayDiv = document.createElement('div');
            dayDiv.classList.add('cal-day');
            dayDiv.innerText = dia;

            const fechaStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(dia).padStart(2, '0')}`;
            dayDiv.dataset.fecha = fechaStr;

            const fechaDate = new Date(year, month, dia);
            const diaSemana = fechaDate.getDay();
            const esFinDeSemana = diaSemana === 0 || diaSemana === 6;
            const hoyDate = new Date(hoyReagendar.getFullYear(), hoyReagendar.getMonth(), hoyReagendar.getDate());
            const esDiaPasado = fechaDate < hoyDate;
            const esSeleccionable = !esFinDeSemana && !esDiaPasado;

            if (fechaStr === hoyStrReagendar) {
                dayDiv.classList.add('day-today');
            }

            // Verificar si es feriado
            const feriadoInfo = calendarioDataReagendar.feriados?.find(f => f.fecha === fechaStr);
            const esFeriado = !!feriadoInfo;
            
            if (esFeriado) {
                dayDiv.classList.add('day-feriado');
                dayDiv.title = feriadoInfo.nombre;
            } else if (esSeleccionable) {
                if (calendarioDataReagendar.fechasConDisponibilidad?.includes(fechaStr)) {
                    dayDiv.classList.add('day-disponible');
                } else if (calendarioDataReagendar.diasCompletos?.includes(fechaStr)) {
                    dayDiv.classList.add('day-lleno');
                }
            } else if (esFinDeSemana) {
                dayDiv.classList.add('day-inabil');
            } else if (esDiaPasado) {
                dayDiv.classList.add('day-inabil');
            }

            if (esSeleccionable) {
                dayDiv.addEventListener('click', () => {
                    mostrarHorariosDelDiaReagendar(fechaStr, dayDiv);
                });
            }
            
            calGridBodyReagendar.appendChild(dayDiv);
        }

        const totalDiasGrid = calGridBodyReagendar.children.length;
        const diasSiguientes = (7 - (totalDiasGrid % 7)) % 7;
        for (let i = 1; i <= diasSiguientes; i++) {
            const dayDiv = document.createElement('div');
            dayDiv.classList.add('cal-day', 'other-month');
            dayDiv.innerText = i;
            calGridBodyReagendar.appendChild(dayDiv);
        }
        
        // Si hay un d√≠a seleccionado y est√° en el mes actual, mostrar sus horarios
        if (diaSeleccionadoStrReagendar && calendarioDataReagendar && calendarioDataReagendar.slotsDetallados) {
            const [selYear, selMonth] = diaSeleccionadoStrReagendar.split('-');
            if (parseInt(selYear) === year && parseInt(selMonth) === (month + 1)) {
                // El d√≠a seleccionado est√° en el mes actual, mostrar sus horarios
                mostrarHorariosDelDiaReagendar(diaSeleccionadoStrReagendar, null);
            } else {
                // El d√≠a seleccionado no est√° en el mes actual, limpiar selecci√≥n
                diaSeleccionadoReagendar = null;
                diaSeleccionadoStrReagendar = null;
                if (citasDiaTituloReagendar) citasDiaTituloReagendar.innerText = `Horarios Disponibles`;
                if (citasDiaContainerReagendar) {
                    // Asegurarse de que horariosBotonesReagendar est√© dentro del contenedor antes de limpiar
                    if (horariosBotonesReagendar && horariosBotonesReagendar.parentElement === citasDiaContainerReagendar) {
                        // No hacer nada, horariosBotonesReagendar ya est√° en el DOM
                    }
                    citasDiaContainerReagendar.innerHTML = `
                        <div class="empty-state empty-state-10">
                            <i class="fas fa-calendar-day empty-state-icon"></i>
                            <p class="empty-state-text">Seleccione un d√≠a del calendario para ver los horarios disponibles.</p>
                        </div>
                    `;
                    // Re-agregar horariosBotonesReagendar al contenedor despu√©s de limpiar
                    if (horariosBotonesReagendar) {
                        citasDiaContainerReagendar.appendChild(horariosBotonesReagendar);
                    }
                }
                if (horariosBotonesReagendar) {
                    horariosBotonesReagendar.classList.add('horarios-botones-hidden');
                    horariosBotonesReagendar.style.display = 'none';
                    horariosBotonesReagendar.innerHTML = '';
                }
                if (horaHiddenInputReagendar) horaHiddenInputReagendar.value = '';
                if (fechaHiddenInputReagendar) fechaHiddenInputReagendar.value = '';
            }
        } else {
            // No hay d√≠a seleccionado o no hay datos del calendario, mostrar estado inicial
            if (citasDiaTituloReagendar) citasDiaTituloReagendar.innerText = `Horarios Disponibles`;
            if (citasDiaContainerReagendar) {
                // Asegurarse de que horariosBotonesReagendar est√© dentro del contenedor
                if (horariosBotonesReagendar && horariosBotonesReagendar.parentElement !== citasDiaContainerReagendar) {
                    citasDiaContainerReagendar.appendChild(horariosBotonesReagendar);
                }
                // Verificar si ya hay un empty-state, si no, agregarlo
                const existingEmptyState = citasDiaContainerReagendar.querySelector('.empty-state');
                if (!existingEmptyState) {
                    citasDiaContainerReagendar.innerHTML = `
                        <div class="empty-state empty-state-10">
                            <i class="fas fa-calendar-day empty-state-icon"></i>
                            <p class="empty-state-text">Seleccione un d√≠a del calendario para ver los horarios disponibles.</p>
                        </div>
                    `;
                    if (horariosBotonesReagendar) {
                        citasDiaContainerReagendar.appendChild(horariosBotonesReagendar);
                    }
                }
            }
            if (horariosBotonesReagendar) {
                horariosBotonesReagendar.classList.add('horarios-botones-hidden');
                horariosBotonesReagendar.style.display = 'none';
            }
        }
    }

    if (btnPrevReagendar) {
        btnPrevReagendar.addEventListener('click', () => {
            navDateReagendar.setMonth(navDateReagendar.getMonth() - 1);
            fetchCalendarioDelMesReagendar(navDateReagendar.getFullYear(), navDateReagendar.getMonth());
        });
    }

    if (btnNextReagendar) {
        btnNextReagendar.addEventListener('click', () => {
            navDateReagendar.setMonth(navDateReagendar.getMonth() + 1);
            fetchCalendarioDelMesReagendar(navDateReagendar.getFullYear(), navDateReagendar.getMonth());
        });
    }

    if (btnTodayReagendar) {
        btnTodayReagendar.addEventListener('click', () => {
            navDateReagendar = new Date();
            // Limpiar selecci√≥n previa al cambiar a hoy
            diaSeleccionadoReagendar = null;
            diaSeleccionadoStrReagendar = null;
            fetchCalendarioDelMesReagendar(navDateReagendar.getFullYear(), navDateReagendar.getMonth());
        });
    }

    function abrirModalReagendar(entrevistaId, asunto, modalidad) {
        document.getElementById('reagendar_caso_asunto').value = asunto;
        document.getElementById('nueva_modalidad').value = modalidad;
        // ***** URL ACTUALIZADA *****
        document.getElementById('formReagendar').action = '{% url "encargado_inclusion_reagendar_cita" 0 %}'.replace('0', entrevistaId);
        document.getElementById('modalReagendar').style.display = 'block';
        // Inicializar calendario cuando se abre el modal
        if (calHeaderReagendar) {
            navDateReagendar = new Date();
            fetchCalendarioDelMesReagendar(navDateReagendar.getFullYear(), navDateReagendar.getMonth());
        }
    }

    function cerrarModalReagendar() {
        document.getElementById('modalReagendar').style.display = 'none';
        document.getElementById('fecha_reagendar').value = '';
        document.getElementById('hora_reagendar').value = '';
        document.getElementById('notas_reagendamiento').value = '';
        // Limpiar calendario
        diaSeleccionadoReagendar = null;
        diaSeleccionadoStrReagendar = null;
        const citasDiaContainer = document.getElementById('cal-citas-dia-reagendar');
        if (citasDiaContainer) {
            citasDiaContainer.innerHTML = `
                <div class="empty-state empty-state-10">
                    <i class="fas fa-calendar-day empty-state-icon"></i>
                    <p class="empty-state-text">Seleccione un d√≠a del calendario para ver los horarios disponibles.</p>
                </div>
            `;
        }
        const horariosBotones = document.getElementById('horarios-botones-reagendar');
        if (horariosBotones) {
            horariosBotones.classList.add('horarios-botones-hidden');
            horariosBotones.style.display = 'none';
        }
    }

    // Validaci√≥n del formulario de reagendar
    const formReagendar = document.getElementById('formReagendar');
    if (formReagendar) {
        formReagendar.addEventListener('submit', function(e) {
            if (!fechaHiddenInputReagendar || !fechaHiddenInputReagendar.value) {
                e.preventDefault();
                alert('Por favor, seleccione una fecha del calendario.');
                return false;
            }
            if (!horaHiddenInputReagendar || !horaHiddenInputReagendar.value) {
                e.preventDefault();
                alert('Por favor, seleccione un horario disponible.');
                return false;
            }
        });
    }

    // Cerrar modales al hacer clic fuera de ellos
    window.onclick = function(event) {
        const modalConfirmar = document.getElementById('modalConfirmar');
        const modalEditarNotas = document.getElementById('modalEditarNotas');
        const modalReagendar = document.getElementById('modalReagendar');
        
        if (event.target == modalConfirmar) { cerrarModalConfirmar(); }
        if (event.target == modalEditarNotas) { cerrarModalEditarNotas(); }
        if (event.target == modalReagendar) { cerrarModalReagendar(); }
    }

    // --- C√ìDIGO DEL CALENDARIO (Sin cambios) ---
    document.addEventListener('DOMContentLoaded', function() {
        const fechasConCitas = JSON.parse('{{ fechas_citas_json|escapejs }}' || "[]");
        const todasLasCitas = JSON.parse('{{ citas_data_json|escapejs }}' || "[]");
        const feriados = JSON.parse('{{ feriados_json|escapejs }}' || "[]");

        let navDate = new Date();
        const hoy = new Date();
        const hoyStr = `${hoy.getFullYear()}-${String(hoy.getMonth() + 1).padStart(2, '0')}-${String(hoy.getDate()).padStart(2, '0')}`;
        let diaSeleccionado = null; 
        let diaSeleccionadoStr = null;
        
        // Funci√≥n para obtener feriados del mes actual
        let feriadosCache = {};
        async function obtenerFeriadosDelMes(year, month) {
            const monthKey = `${year}-${String(month + 1).padStart(2, '0')}`;
            
            // Verificar cache
            if (feriadosCache[monthKey]) {
                return feriadosCache[monthKey];
            }
            
            try {
                const response = await fetch(`/api/calendario-disponible/?month=${monthKey}`);
                if (response.ok) {
                    const data = await response.json();
                    const feriados = data.feriados || [];
                    feriadosCache[monthKey] = feriados;
                    return feriados;
                }
            } catch (error) {
                console.error('Error al obtener feriados:', error);
            }
            return [];
        }

        const calHeader = document.getElementById('cal-header');
        const calGridBody = document.getElementById('cal-grid-body');
        const btnPrev = document.getElementById('cal-prev');
        const btnNext = document.getElementById('cal-next');
        const btnToday = document.getElementById('cal-today');
        const citasDiaContainer = document.getElementById('cal-citas-dia');
        const citasDiaTitulo = document.getElementById('cal-citas-titulo');

        const meses = [
            "Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio",
            "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"
        ];
        
        const citasPorFecha = {};
        for (const cita of todasLasCitas) {
            if (!citasPorFecha[cita.fecha]) {
                citasPorFecha[cita.fecha] = [];
            }
            citasPorFecha[cita.fecha].push(cita);
        }

        async function mostrarCitasDelDia(fechaStr, diaEl) {
            const [year, month, day] = fechaStr.split('-');
            citasDiaTitulo.innerText = `Citas para ${day}/${month}/${year}`;

            if (diaSeleccionado) {
                diaSeleccionado.classList.remove('cal-day-selected');
            }
            
            if(diaEl) {
                diaEl.classList.add('cal-day-selected');
                diaSeleccionado = diaEl;
                diaSeleccionadoStr = fechaStr;
            } else {
                diaSeleccionado = calGridBody.querySelector(`[data-fecha="${fechaStr}"]`);
                if (diaSeleccionado) {
                    diaSeleccionado.classList.add('cal-day-selected');
                }
            }

            // Verificar si es feriado
            const yearNum = parseInt(year);
            const monthNum = parseInt(month);
            const feriadosMes = await obtenerFeriadosDelMes(yearNum, monthNum - 1);
            const feriadoInfo = feriadosMes.find(f => f.fecha === fechaStr);
            
            if (feriadoInfo) {
                citasDiaContainer.innerHTML = `
                    <div class="empty-state p-10">
                        <i class="fas fa-calendar-times empty-state-icon" style="color: #ffc107; font-size: 3rem;"></i>
                        <h4 style="color: #856404; margin: 15px 0 10px 0; font-size: 1.2rem;">üéâ D√≠a Feriado</h4>
                        <p class="empty-state-text" style="color: #856404; font-weight: 500; font-size: 1rem;">
                            ${feriadoInfo.nombre}
                        </p>
                        <p class="empty-state-text" style="color: #666; font-size: 0.9rem; margin-top: 10px;">
                            No hay citas programadas para este d√≠a.
                        </p>
                    </div>
                `;
                return;
            }

            const citas = citasPorFecha[fechaStr] || [];
            
            if (citas.length === 0) {
                citasDiaContainer.innerHTML = `
                    <div class="empty-state p-10">
                        <i class="fas fa-calendar-check empty-state-icon"></i>
                        <p class="empty-state-text">No hay citas programadas para este d√≠a.</p>
                    </div>
                `;
                return;
            }

            let html = '';
            for (const cita of citas) {
                html += `
                    <div class="cal-cita-item estado-${cita.estado_key}">
                        <span class="cal-cita-hora"><i class="fas fa-clock"></i> ${cita.hora}</span>
                        <strong class="cal-cita-estudiante">${cita.estudiante}</strong>
                        <span class="cal-cita-asunto">${cita.asunto}</span>
                        <span class="cal-cita-estado">Estado: ${cita.estado}</span>
                    </div>
                `;
            }
            citasDiaContainer.innerHTML = html;
        }

        async function renderCalendar() {
            const year = navDate.getFullYear();
            const month = navDate.getMonth();
            calHeader.innerText = `${meses[month]} ${year}`;
            
            // Obtener feriados del mes actual
            const feriadosMes = await obtenerFeriadosDelMes(year, month);
            
            calGridBody.innerHTML = `
                <div class="cal-day-header">L</div>
                <div class="cal-day-header">M</div>
                <div class="cal-day-header">X</div>
                <div class="cal-day-header">J</div>
                <div class="cal-day-header">V</div>
                <div class="cal-day-header">S</div>
                <div class="cal-day-header">D</div>
            `;
            
            const primerDiaDelMes = new Date(year, month, 1);
            const ultimoDiaDelMes = new Date(year, month + 1, 0);
            const ultimoDiaNum = ultimoDiaDelMes.getDate();
            let diaInicioSemana = (primerDiaDelMes.getDay() + 6) % 7;
            const ultimoDiaMesAnterior = new Date(year, month, 0).getDate();

            for (let i = diaInicioSemana; i > 0; i--) {
                const dia = ultimoDiaMesAnterior - i + 1;
                const dayDiv = document.createElement('div');
                dayDiv.classList.add('cal-day', 'other-month');
                dayDiv.innerText = dia;
                calGridBody.appendChild(dayDiv);
            }

            for (let dia = 1; dia <= ultimoDiaNum; dia++) {
                const dayDiv = document.createElement('div');
                dayDiv.classList.add('cal-day');
                dayDiv.innerText = dia;

                const fechaStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(dia).padStart(2, '0')}`;
                dayDiv.dataset.fecha = fechaStr;

                // Verificar si es feriado
                const feriadoInfo = feriadosMes.find(f => f.fecha === fechaStr);
                const esFeriado = !!feriadoInfo;

                if (fechaStr === hoyStr) {
                    dayDiv.classList.add('day-today');
                }

                if (fechasConCitas.includes(fechaStr)) {
                    dayDiv.classList.add('day-entrevista');
                }
                
                if (esFeriado) {
                    dayDiv.classList.add('day-feriado');
                    dayDiv.title = feriadoInfo.nombre; // Mostrar nombre del feriado al pasar el mouse
                }
                
                dayDiv.addEventListener('click', () => {
                    mostrarCitasDelDia(fechaStr, dayDiv).catch(err => console.error('Error al mostrar citas:', err));
                });
                calGridBody.appendChild(dayDiv);
            }

            const totalDiasGrid = calGridBody.children.length;
            const diasSiguientes = (7 - (totalDiasGrid % 7)) % 7;
            for (let i = 1; i <= diasSiguientes; i++) {
                const dayDiv = document.createElement('div');
                dayDiv.classList.add('cal-day', 'other-month');
                dayDiv.innerText = i;
                calGridBody.appendChild(dayDiv);
            }
            
            if (diaSeleccionadoStr) {
                const [selYear, selMonth] = diaSeleccionadoStr.split('-');
                if (parseInt(selYear) === year && parseInt(selMonth) === (month + 1)) {
                    mostrarCitasDelDia(diaSeleccionadoStr, null).catch(err => console.error('Error al mostrar citas:', err));
                } else {
                    diaSeleccionado = null;
                    diaSeleccionadoStr = null;
                    citasDiaTitulo.innerText = `Citas del D√≠a`;
                    citasDiaContainer.innerHTML = `
                        <div class="empty-state p-10">
                            <i class="fas fa-calendar-day empty-state-icon"></i>
                            <p class="empty-state-text">Seleccione un d√≠a del calendario para ver las citas programadas.</p>
                        </div>
                    `;
                }
            }
        }

        btnPrev.addEventListener('click', () => {
            navDate.setMonth(navDate.getMonth() - 1);
            renderCalendar();
        });

        btnNext.addEventListener('click', () => {
            navDate.setMonth(navDate.getMonth() + 1);
            renderCalendar();
        });

        btnToday.addEventListener('click', () => {
            navDate = new Date();
            renderCalendar();
        });

        renderCalendar();
    });
</script>
{% endblock %}