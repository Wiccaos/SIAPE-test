{% extends 'plantilla.html' %}
{% load static %}

{% comment %} Bloque para el título de la página {% endcomment %}
{% block title %}Solicitud de Apoyo | SIAPE{% endblock %}

{% comment %} 
  Bloque para los estilos CSS específicos de esta página.
{% endcomment %}
{% block extra_head %}
    <script src="{% static 'JS/rut_validator.js' %}"></script>
    <!-- 
      Asegúrate de que base.css se cargue primero (desde plantilla.html)
      y que formulario.css contenga los estilos del calendario.
    -->
    <link rel="stylesheet" href="{% static 'css/formulario.css' %}">
{% endblock %}


{% comment %} Bloque para el contenido principal de la página {% endcomment %}
{% block content %}
    <div class="form-container">
        
        <div class="form-header">
            <h1>Solicitud de Entrevista de Apoyo</h1>
            <p>Ingresa tu RUT para verificar tus datos en el sistema, luego completa el asunto para agendar una entrevista con la Encargada de Inclusión.</p>
        </div>

        <form id="solicitud-form" enctype="multipart/form-data">
            {% csrf_token %}

            <!-- Búsqueda por RUT -->
            <div class="rut-search-section">
                <div class="form-group form-group-rut">
                    <label for="rut">Ingresa tu RUT <span>*</span></label>
                    <div class="rut-input-wrapper">
                        <input type="text" id="rut" name="rut" placeholder="Ej: 12345678-K" required>
                        <button type="button" id="btn-buscar-rut" class="btn btn-secondary">
                            <i class="fas fa-search"></i> Buscar
                        </button>
                    </div>
                    <small class="form-hint">Ingresa tu RUT y presiona "Buscar" para autocompletar tus datos.</small>
                </div>
                
                <!-- Mensaje de estado de búsqueda -->
                <div id="rut-search-status" class="rut-status" style="display: none;"></div>
            </div>

            <!-- Datos del estudiante ENCONTRADO (solo lectura para verificación) -->
            <div id="datos-estudiante-verificacion" style="display: none;">
                <h3 class="section-title"><i class="fas fa-user-check"></i> Verifica tus Datos</h3>
                <p class="form-hint">Por favor, verifica que estos son tus datos correctos. Si hay algún error, contacta a tu Director de Carrera.</p>
                
                <div class="datos-verificacion-card">
                    <div class="dato-item">
                        <span class="dato-label"><i class="fas fa-user"></i> Nombre completo</span>
                        <span class="dato-valor" id="display-nombre-completo">-</span>
                    </div>
                    <div class="dato-item">
                        <span class="dato-label"><i class="fas fa-id-card"></i> RUT</span>
                        <span class="dato-valor" id="display-rut">-</span>
                    </div>
                    <div class="dato-item">
                        <span class="dato-label"><i class="fas fa-envelope"></i> Correo electrónico</span>
                        <span class="dato-valor" id="display-email">-</span>
                    </div>
                    <div class="dato-item">
                        <span class="dato-label"><i class="fas fa-graduation-cap"></i> Carrera</span>
                        <span class="dato-valor" id="display-carrera">-</span>
                    </div>
                    <div class="dato-item">
                        <span class="dato-label"><i class="fas fa-phone"></i> Teléfono</span>
                        <span class="dato-valor" id="display-telefono">No registrado</span>
                    </div>
                </div>
                
                <!-- Campos ocultos para enviar los datos -->
                <input type="hidden" id="nombres" name="nombres">
                <input type="hidden" id="apellidos" name="apellidos">
                <input type="hidden" id="email" name="email">
                <input type="hidden" id="carrera_id" name="carrera_id">
                <input type="hidden" id="numero" name="numero">
            </div>

            <!-- Mensaje cuando el estudiante NO está registrado -->
            <div id="estudiante-no-encontrado" style="display: none;">
                <div class="no-encontrado-card">
                    <div class="no-encontrado-icon">
                        <i class="fas fa-user-times"></i>
                    </div>
                    <h3>No estás registrado en el sistema</h3>
                    <p>Tu RUT no se encuentra en nuestra base de datos. Para poder realizar una solicitud, debes estar registrado como estudiante.</p>
                    <p><strong>¿Qué puedes hacer?</strong></p>
                    <ul>
                        <li>Verifica que hayas escrito correctamente tu RUT</li>
                        <li>Contacta a tu Director de Carrera para que te registre en el sistema</li>
                    </ul>
                </div>
            </div>
            

            <!-- Asunto (Ancho completo) -->
            <div class="form-group">
                <label for="asunto">Asunto o Motivo de la Solicitud <span>*</span></label>
                <input type="text" id="asunto" name="asunto" placeholder="Ej: Dificultades de concentración, Apoyo por discapacidad auditiva" required>
            </div>
            
            <!-- EL CAMPO 'descripcion' SE ELIMINA DE AQUÍ -->

            <!-- === SECCIÓN DE AGENDAMIENTO (NUEVA CON CALENDARIO) === -->
            <div class="form-group">
                <label>Agendamiento de Entrevista</label>
                <p class="form-hint">
                    Por favor, selecciona un día y hora para tu entrevista con la Encargado de Inclusión.
                    (Horario de Lunes a Viernes, de 9:00 a 18:00).
                </p>

                <!-- Contenedor copiado de 'panel_control_asesor.html' -->
                <div class="cal-layout-container">
                    
                    <!-- Columna 1: El Calendario -->
                    <div class="cal-widget">
                        <div class="detalle-card" id="card-calendario-panel">
                            <div class="calendario-header" id="cal-header">
                                <!-- El mes se inserta aquí por JS -->
                            </div>
                            <!-- Navegación movida encima de la grilla -->
                            <div class="cal-nav">
                                <button type="button" id="cal-prev" class="btn-accion btn-accion-gray btn-accion-small"><i class="fas fa-chevron-left"></i> Ant</button>
                                <button type="button" id="cal-today" class="btn-accion btn-accion-gray btn-accion-small">Hoy</button>
                                <button type="button" id="cal-next" class="btn-accion btn-accion-gray btn-accion-small">Sig <i class="fas fa-chevron-right"></i></button>
                            </div>
                            <div class="calendario-grid" id="cal-grid-body">
                                <!-- Los días se insertan aquí por JS -->
                            </div>
                            <div class="calendario-leyenda calendario-leyenda-mt">
                                <div><span class="dot dot-disponible"></span> Día Disponible</div>
                                <div><span class="dot dot-lleno"></span> Día Completo</div>
                            </div>
                        </div>
                    </div>

                    <!-- Columna 2: El Selector de Hora -->
                    <div class="cal-citas-list">
                        <h4 id="cal-citas-titulo">Horarios Disponibles</h4>
                        <div id="cal-citas-dia">
                            <!-- El contenido se inserta aquí por JS -->
                            <div class="empty-state empty-state-10">
                                <i class="fas fa-calendar-day empty-state-icon"></i>
                                <p class="empty-state-text">Seleccione un día del calendario para ver los horarios disponibles.</p>
                            </div>
                            <div class="horarios-botones horarios-botones-hidden" id="horarios-botones"></div>
                            <input type="hidden" id="hora_cita" name="hora_cita" required>
                        </div>
                    </div>
                </div>
                
                <!-- Input oculto para enviar la fecha seleccionada -->
                <input type="hidden" id="fecha_cita" name="fecha_cita">
                </div>
                
                <div class="form-group form-group-spacing">
                    <label for="modalidad">Modalidad de la Cita <span>*</span></label>
                    <select id="modalidad" name="modalidad" required>
                        <option value="">-- Selecciona la modalidad --</option>
                        <option value="Presencial">Presencial</option>
                        <option value="Virtual">Virtual</option>
                    </select>
                </div>
            <!-- === FIN SECCIÓN DE AGENDAMIENTO === -->


            <!-- Zona de Carga de Archivos (Opcional) -->
            <div class="form-group">
                <label>Documentos de Apoyo (Opcional)</label>
                <div class="drop-zone" id="drop-zone">
                    <input type="file" id="documentos_adjuntos" name="documentos_adjuntos" multiple>
                    <p class="drop-zone__prompt">Arrastra archivos aquí o <strong>haz clic para seleccionar</strong></p>
                    <small>Si ya tienes un diagnóstico o informe, puedes adjuntarlo aquí.</small>
                </div>
                <div id="file-list"></div>
            </div>

            <!-- Autorización -->
            <div class="auth-group">
                <input type="checkbox" id="autorizacion_datos" name="autorizacion_datos" required>
                <label for="autorizacion_datos">
                    Autorizo el tratamiento de mis datos personales de acuerdo con la Política de Privacidad y acepto los Términos y Condiciones del servicio. <span>*</span>
                </label>
            </div>

            <!-- Caja de Información -->
            <div class="info-box">
                <h4>Importante:</h4>
                <ul>
                    <li>Tu solicitud y entrevista quedarán agendadas al enviar este formulario.</li>
                    <li>Recibirás una confirmación por correo electrónico.</li>
                    <li>La información proporcionada debe ser veraz y completa.</li>
                </ul>
            </div>

            <!-- Botones de Acción -->
            <div class="button-group">
                <button type="submit" id="submit-button" class="btn btn-primary">Enviar Solicitud y Agendar</button>
            </div>
        </form>

        <div id="mensaje"></div>
    </div>

    <!-- El script se queda aquí, al final del bloque de contenido -->
    <script>
        // --- LÓGICA DE BÚSQUEDA POR RUT (Sección 0) ---
        
        // Variables para el estado del estudiante
        let estudianteEncontrado = null;
        
        // Elementos del DOM para búsqueda por RUT
        const rutInput = document.getElementById('rut');
        const btnBuscarRut = document.getElementById('btn-buscar-rut');
        const rutSearchStatus = document.getElementById('rut-search-status');
        
        // Secciones de datos
        const seccionVerificacion = document.getElementById('datos-estudiante-verificacion');
        const seccionNoEncontrado = document.getElementById('estudiante-no-encontrado');
        
        // Campos ocultos (para estudiante encontrado)
        const nombresHidden = document.getElementById('nombres');
        const apellidosHidden = document.getElementById('apellidos');
        const emailHidden = document.getElementById('email');
        const carreraHidden = document.getElementById('carrera_id');
        const numeroHidden = document.getElementById('numero');
        
        // Displays de verificación
        const displayNombreCompleto = document.getElementById('display-nombre-completo');
        const displayRut = document.getElementById('display-rut');
        const displayEmail = document.getElementById('display-email');
        const displayCarrera = document.getElementById('display-carrera');
        const displayTelefono = document.getElementById('display-telefono');
        
        // Función para buscar estudiante por RUT
        async function buscarEstudiantePorRut() {
            const rut = rutInput.value.trim();
            
            if (!rut) {
                mostrarEstadoRut('Por favor, ingresa tu RUT', 'warning');
                return;
            }
            
            // Validar RUT antes de buscar
            const validacion = validarRUTChileno(rut);
            if (!validacion.esValido) {
                mostrarEstadoRut(`<i class="fas fa-exclamation-triangle"></i> ${validacion.mensajeError}`, 'error');
                rutInput.classList.add('error');
                return;
            }
            
            rutInput.classList.remove('error');
            mostrarEstadoRut('<i class="fas fa-spinner fa-spin"></i> Buscando...', 'loading');
            btnBuscarRut.disabled = true;
            
            try {
                const response = await fetch(`/api/buscar-estudiante/?rut=${encodeURIComponent(rut)}`);
                const data = await response.json();
                
                if (response.status === 404 || data.error) {
                    // RUT válido pero no encontrado en el sistema
                    estudianteEncontrado = null;
                    mostrarNoEncontrado();
                    mostrarEstadoRut(
                        '<i class="fas fa-times-circle"></i> RUT no encontrado en el sistema.',
                        'error'
                    );
                } else if (data.encontrado) {
                    estudianteEncontrado = data.estudiante;
                    
                    // Mostrar datos en modo verificación
                    mostrarDatosVerificacion(data.estudiante);
                    
                    mostrarEstadoRut(
                        `<i class="fas fa-check-circle"></i> ¡Datos encontrados! Verifica que son correctos.`,
                        'success'
                    );
                } else {
                    estudianteEncontrado = null;
                    mostrarNoEncontrado();
                    mostrarEstadoRut(
                        '<i class="fas fa-times-circle"></i> RUT no encontrado en el sistema.',
                        'error'
                    );
                }
            } catch (error) {
                console.error('Error buscando estudiante:', error);
                mostrarEstadoRut(
                    '<i class="fas fa-exclamation-triangle"></i> Error de conexión. Intenta de nuevo.',
                    'error'
                );
            }
            
            btnBuscarRut.disabled = false;
        }
        
        // Mostrar estado de búsqueda
        function mostrarEstadoRut(mensaje, tipo) {
            rutSearchStatus.innerHTML = mensaje;
            rutSearchStatus.className = 'rut-status ' + tipo;
            rutSearchStatus.style.display = 'block';
        }
        
        // Mostrar datos en modo verificación (solo lectura)
        function mostrarDatosVerificacion(estudiante) {
            // Llenar los displays de verificación
            displayNombreCompleto.textContent = `${estudiante.nombres} ${estudiante.apellidos}`;
            displayRut.textContent = estudiante.rut;
            displayEmail.textContent = estudiante.email;
            displayCarrera.textContent = estudiante.carrera_nombre;
            displayTelefono.textContent = estudiante.numero || 'No registrado';
            
            // Llenar los campos ocultos para el envío
            nombresHidden.value = estudiante.nombres;
            apellidosHidden.value = estudiante.apellidos;
            emailHidden.value = estudiante.email;
            carreraHidden.value = estudiante.carrera_id;
            numeroHidden.value = estudiante.numero || '';
            
            // Mostrar sección de verificación, ocultar no encontrado
            seccionVerificacion.style.display = 'block';
            seccionNoEncontrado.style.display = 'none';
        }
        
        // Mostrar mensaje de no encontrado
        function mostrarNoEncontrado() {
            // Ocultar verificación, mostrar mensaje de no encontrado
            seccionVerificacion.style.display = 'none';
            seccionNoEncontrado.style.display = 'block';
            
            // Limpiar campos ocultos
            nombresHidden.value = '';
            apellidosHidden.value = '';
            emailHidden.value = '';
            carreraHidden.value = '';
            numeroHidden.value = '';
        }
        
        // Resetear a estado inicial
        function resetearEstadoEstudiante() {
            estudianteEncontrado = null;
            seccionVerificacion.style.display = 'none';
            seccionNoEncontrado.style.display = 'none';
            rutSearchStatus.style.display = 'none';
            
            // Limpiar campos ocultos
            nombresHidden.value = '';
            apellidosHidden.value = '';
            emailHidden.value = '';
            carreraHidden.value = '';
            numeroHidden.value = '';
        }
        
        // Event listeners para búsqueda por RUT
        if (btnBuscarRut) {
            btnBuscarRut.addEventListener('click', buscarEstudiantePorRut);
        }
        
        if (rutInput) {
            // Buscar al presionar Enter en el campo RUT
            rutInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    buscarEstudiantePorRut();
                }
            });
            
            // Limpiar estado cuando cambia el RUT
            rutInput.addEventListener('input', () => {
                if (estudianteEncontrado || seccionNoEncontrado.style.display === 'block') {
                    resetearEstadoEstudiante();
                }
            });
        }
        
        // --- LÓGICA DEL CALENDARIO (Sección 1) - Se ejecuta primero ---
        
        // Variables globales del calendario
        let navDate = new Date();
        const hoy = new Date();
        const hoyStr = `${hoy.getFullYear()}-${String(hoy.getMonth() + 1).padStart(2, '0')}-${String(hoy.getDate()).padStart(2, '0')}`;
        let diaSeleccionado = null; 
        let diaSeleccionadoStr = null;
        let calendarioData = {}; // Guardará la data de la API

        // Elementos del DOM del calendario
        const calHeader = document.getElementById('cal-header');
        const calGridBody = document.getElementById('cal-grid-body');
        const btnPrev = document.getElementById('cal-prev');
        const btnNext = document.getElementById('cal-next');
        const btnToday = document.getElementById('cal-today');
        const citasDiaContainer = document.getElementById('cal-citas-dia');
        const citasDiaTitulo = document.getElementById('cal-citas-titulo');
        const horariosBotones = document.getElementById('horarios-botones');
        const fechaHiddenInput = document.getElementById('fecha_cita');
        
        // Verificar que los elementos esenciales del calendario existan
        const calendarioDisponible = calHeader && calGridBody && btnPrev && btnNext && btnToday && 
            citasDiaContainer && citasDiaTitulo && horariosBotones && fechaHiddenInput;
        
        if (!calendarioDisponible) {
            console.warn('Advertencia: No se encontraron todos los elementos del calendario. El calendario no se inicializará.');
        }

        const meses = [
            "Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio",
            "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"
        ];

        // 1. Función para buscar datos del mes
        async function fetchCalendarioDelMes(year, month) {
            if (!calendarioDisponible) return;
            
            calHeader.innerText = `Cargando ${meses[month]} ${year}...`;
            
            try {
                const monthStr = `${year}-${String(month + 1).padStart(2, '0')}`;
                const response = await fetch(`/api/calendario-disponible/?month=${monthStr}`);
                
                if (!response.ok) throw new Error('Error de red');
                
                calendarioData = await response.json();
                renderCalendar(year, month);

            } catch (error) {
                console.error('Error fetching calendario:', error);
                if (calHeader) calHeader.innerText = "Error al cargar calendario";
            }
        }

        // 2. Función para mostrar los horarios de un día
        function mostrarHorariosDelDia(fechaStr, diaEl) {
            console.log('=== mostrarHorariosDelDia llamada ===');
            console.log('fechaStr:', fechaStr);
            console.log('diaEl:', diaEl);
            console.log('calendarioDisponible:', calendarioDisponible);
            console.log('horariosBotones:', horariosBotones);
            console.log('calendarioData:', calendarioData);
            
            if (!calendarioDisponible) {
                console.warn('No se puede mostrar horarios: calendario no disponible');
                return;
            }
            
            // Verificar que horariosBotones exista
            if (!horariosBotones) {
                console.error('No se puede mostrar horarios: elemento horariosBotones no encontrado');
                return;
            }
            
            // calendarioData puede estar vacío inicialmente, pero aún así podemos mostrar los botones
            // (todos aparecerán como no disponibles si no hay datos)
            
            // Actualizar título
            const [year, month, day] = fechaStr.split('-');
            citasDiaTitulo.innerText = `Horarios para ${day}/${month}/${year}`;

            // Resaltar día seleccionado
            if (diaSeleccionado) {
                diaSeleccionado.classList.remove('cal-day-selected');
            }
            
            if(diaEl) {
                diaEl.classList.add('cal-day-selected');
                diaSeleccionado = diaEl;
                diaSeleccionadoStr = fechaStr;
            } else {
                diaSeleccionado = calGridBody.querySelector(`[data-fecha="${fechaStr}"]`);
                if (diaSeleccionado) {
                    diaSeleccionado.classList.add('cal-day-selected');
                }
            }

            // Guardar fecha en el input oculto
            if (fechaHiddenInput) {
                fechaHiddenInput.value = fechaStr;
            }
            const horaCitaInput = document.getElementById('hora_cita');
            if (horaCitaInput) {
                horaCitaInput.value = '';
            }

            // Obtener los slots disponibles y no disponibles del calendario
            // Si no hay datos para este día, usar arrays vacíos (todos los horarios aparecerán como no disponibles)
            const slotsDisponibles = (calendarioData && calendarioData.slotsDetallados && calendarioData.slotsDetallados[fechaStr]) ? calendarioData.slotsDetallados[fechaStr] : [];
            const slotsNoDisponibles = (calendarioData && calendarioData.slotsNoDisponibles && calendarioData.slotsNoDisponibles[fechaStr]) ? calendarioData.slotsNoDisponibles[fechaStr] : [];
            
            // Debug: Log para verificar los datos recibidos
            console.log('Fecha:', fechaStr);
            console.log('Slots disponibles:', slotsDisponibles);
            console.log('Slots no disponibles:', slotsNoDisponibles);
            console.log('CalendarioData completo:', calendarioData);
            
            // Limpiar contenido previo - remover todos los empty-state
            // IMPORTANTE: No usar innerHTML porque elimina horariosBotones del DOM
            const existingEmptyStates = citasDiaContainer.querySelectorAll('.empty-state');
            console.log('Empty states encontrados:', existingEmptyStates.length);
            existingEmptyStates.forEach(el => {
                console.log('Removiendo empty-state:', el);
                el.remove();
            });
            
            // Asegurarse de que horariosBotones esté en el DOM
            // Si no tiene parentElement, significa que fue eliminado o nunca fue agregado
            if (!horariosBotones.parentElement) {
                console.warn('horariosBotones no está en el DOM, agregándolo...');
                citasDiaContainer.appendChild(horariosBotones);
            }
            
            // Limpiar botones previos (solo el contenido, no el elemento)
            console.log('Limpiando botones previos. Botones actuales:', horariosBotones.children.length);
            horariosBotones.innerHTML = '';
            console.log('Botones limpiados');
            console.log('horariosBotones parent después de verificar:', horariosBotones.parentElement);
            
            // Asegurarse de que horariosBotones esté visible
            horariosBotones.classList.remove('horarios-botones-hidden');
            horariosBotones.style.display = 'flex';

            // Generar todos los slots de 9:00 a 17:00
            const allSlots = [];
            for (let h = 9; h <= 17; h++) {
                allSlots.push(`${h.toString().padStart(2, '0')}:00`);
            }

            // Mostrar botones siempre, incluso si no hay disponibles
            console.log('Antes de remover clase hidden. Clases actuales:', horariosBotones.className);
            horariosBotones.classList.remove('horarios-botones-hidden');
            console.log('Después de remover clase hidden. Clases actuales:', horariosBotones.className);
            horariosBotones.style.display = 'flex';
            console.log('Display establecido a flex');
            
            console.log('Creando botones de horarios para fecha:', fechaStr);
            console.log('horariosBotones encontrado:', horariosBotones);
            console.log('horariosBotones parent:', horariosBotones.parentElement);

            // Crear botones para cada horario
            for (const slot of allSlots) {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'btn-horario';
                const horaInicio = parseInt(slot.split(':')[0]);
                const horaFin = horaInicio + 1;
                btn.textContent = `${slot} - ${horaFin.toString().padStart(2, '0')}:00`;
                btn.dataset.hora = slot;

                // Verificar si el slot está disponible o no
                // Un slot está disponible SOLO si está en slotsDisponibles Y NO está en slotsNoDisponibles
                const estaDisponible = slotsDisponibles.includes(slot);
                const estaNoDisponible = slotsNoDisponibles.includes(slot);

                // Lógica mejorada: un slot solo está disponible si:
                // 1. Está explícitamente en la lista de disponibles
                // 2. Y NO está en la lista de no disponibles
                // Si está en ambas listas, priorizamos "no disponible" (más seguro)
                if (estaNoDisponible) {
                    // Si está en la lista de no disponibles, definitivamente no está disponible
                    btn.disabled = true;
                    btn.classList.add('no-disponible');
                    btn.title = 'Hora no disponible (ya tomada o fuera de horario)';
                    console.log(`Slot ${slot} marcado como NO disponible (está en slotsNoDisponibles)`);
                } else if (estaDisponible) {
                    // Si está en la lista de disponibles y no en no disponibles, está disponible
                    btn.disabled = false;
                    btn.classList.remove('no-disponible');
                    btn.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        // Remover selección de todos los botones
                        horariosBotones.querySelectorAll('.btn-horario').forEach(b => {
                            b.classList.remove('selected');
                        });
                        // Agregar selección al botón clickeado
                        btn.classList.add('selected');
                        // Establecer el valor en el input
                        const horaCitaInput = document.getElementById('hora_cita');
                        if (horaCitaInput) {
                            horaCitaInput.value = slot;
                            console.log('Hora seleccionada:', slot, 'Input value:', horaCitaInput.value);
                        }
                        // Ocultar mensajes de error
                        const mensajeDiv = document.getElementById('mensaje');
                        if (mensajeDiv) mensajeDiv.style.display = 'none';
                    });
                    console.log(`Slot ${slot} marcado como disponible`);
                } else {
                    // Si no está en ninguna lista, por defecto no está disponible (más seguro)
                    btn.disabled = true;
                    btn.classList.add('no-disponible');
                    btn.title = 'Hora no disponible';
                    console.log(`Slot ${slot} marcado como NO disponible (no está en ninguna lista)`);
                }
                horariosBotones.appendChild(btn);
            }
            
            console.log('Total de botones creados:', horariosBotones.children.length);
            console.log('horariosBotones display:', window.getComputedStyle(horariosBotones).display);
            console.log('horariosBotones visibility:', window.getComputedStyle(horariosBotones).visibility);
            console.log('horariosBotones offsetHeight:', horariosBotones.offsetHeight);
            console.log('horariosBotones offsetWidth:', horariosBotones.offsetWidth);
            
            // Asegurar que los botones sean visibles
            horariosBotones.style.display = 'flex';
            horariosBotones.style.visibility = 'visible';
            horariosBotones.style.opacity = '1';
            
            // Si no hay slots disponibles, mostrar mensaje adicional DESPUÉS de los botones
            if (slotsDisponibles.length === 0) {
                // Insertar el mensaje después del contenedor de botones, no antes
                horariosBotones.insertAdjacentHTML('afterend', `
                    <div class="empty-state empty-state-10 empty-state-error" style="margin-top: 15px;">
                        <i class="fas fa-calendar-times empty-state-error-icon"></i>
                        <p class="empty-state-error-text">No hay horarios disponibles para este día. Todos los horarios están ocupados.</p>
                    </div>
                `);
            }
        }
        
        // 3. Función principal para renderizar el calendario
        function renderCalendar(year, month) {
            if (!calendarioDisponible) return;
            
            calHeader.innerText = `${meses[month]} ${year}`;
            
            // Limpiamos la grilla e inyectamos los encabezados
            calGridBody.innerHTML = `
                <div class="cal-day-header">L</div>
                <div class="cal-day-header">M</div>
                <div class="cal-day-header">X</div>
                <div class="cal-day-header">J</div>
                <div class="cal-day-header">V</div>
                <div class="cal-day-header">S</div>
                <div class="cal-day-header">D</div>
            `;
            
            const primerDiaDelMes = new Date(year, month, 1);
            const ultimoDiaDelMes = new Date(year, month + 1, 0);
            const ultimoDiaNum = ultimoDiaDelMes.getDate();
            let diaInicioSemana = (primerDiaDelMes.getDay() + 6) % 7;
            const ultimoDiaMesAnterior = new Date(year, month, 0).getDate();

            // Días del mes anterior
            for (let i = diaInicioSemana; i > 0; i--) {
                const dia = ultimoDiaMesAnterior - i + 1;
                const dayDiv = document.createElement('div');
                dayDiv.classList.add('cal-day', 'other-month');
                dayDiv.innerText = dia;
                calGridBody.appendChild(dayDiv);
            }

            // Días del mes actual
            for (let dia = 1; dia <= ultimoDiaNum; dia++) {
                const dayDiv = document.createElement('div');
                dayDiv.classList.add('cal-day');
                dayDiv.innerText = dia;

                const fechaStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(dia).padStart(2, '0')}`;
                dayDiv.dataset.fecha = fechaStr;

                const fechaDate = new Date(year, month, dia);
                const diaSemana = fechaDate.getDay(); // 0 = Domingo, 6 = Sábado
                const esFinDeSemana = diaSemana === 0 || diaSemana === 6;
                const hoyDate = new Date(hoy.getFullYear(), hoy.getMonth(), hoy.getDate());
                const esDiaPasado = fechaDate < hoyDate;
                
                // Verificar si es feriado
                const feriadoInfo = calendarioData.feriados?.find(f => f.fecha === fechaStr);
                const esFeriado = !!feriadoInfo;
                
                const esSeleccionable = !esFinDeSemana && !esDiaPasado && !esFeriado;

                if (fechaStr === hoyStr) {
                    dayDiv.classList.add('day-today');
                }

                // Colorear según disponibilidad (solo días hábiles)
                if (esSeleccionable) {
                    if (calendarioData.fechasConDisponibilidad?.includes(fechaStr)) {
                        dayDiv.classList.add('day-disponible');
                    } else if (calendarioData.diasCompletos?.includes(fechaStr)) {
                        dayDiv.classList.add('day-lleno');
                    }
                } else if (esFeriado) {
                    // Feriados no disponibles
                    dayDiv.classList.add('day-feriado');
                    dayDiv.title = feriadoInfo.nombre; // Mostrar nombre del feriado al pasar el mouse
                } else if (esFinDeSemana) {
                    // Fines de semana no disponibles
                    dayDiv.classList.add('day-inabil');
                } else if (esDiaPasado) {
                    // Días pasados no disponibles
                    dayDiv.classList.add('day-inabil');
                }

                // Solo permitir seleccionar días hábiles futuros o hoy
                if (esSeleccionable) {
                    dayDiv.addEventListener('click', () => {
                        console.log('Click en día:', fechaStr);
                        mostrarHorariosDelDia(fechaStr, dayDiv);
                    });
                }
                
                calGridBody.appendChild(dayDiv);
            }

            // Días del mes siguiente
            const totalDiasGrid = calGridBody.children.length;
            const diasSiguientes = (7 - (totalDiasGrid % 7)) % 7;
            for (let i = 1; i <= diasSiguientes; i++) {
                const dayDiv = document.createElement('div');
                dayDiv.classList.add('cal-day', 'other-month');
                dayDiv.innerText = i;
                calGridBody.appendChild(dayDiv);
            }
            
            // Al re-renderizar, si un día estaba seleccionado, lo volvemos a mostrar
            if (diaSeleccionadoStr && calendarioData && calendarioData.slotsDetallados) {
                const [selYear, selMonth] = diaSeleccionadoStr.split('-');
                if (parseInt(selYear) === year && parseInt(selMonth) === (month + 1)) {
                    // Intentar mostrar los horarios del día seleccionado
                    // La función mostrarHorariosDelDia manejará el caso si no hay datos para ese día
                    mostrarHorariosDelDia(diaSeleccionadoStr, null);
                } else {
                    // El día seleccionado no está en el mes actual, limpiar selección
                    diaSeleccionado = null;
                    diaSeleccionadoStr = null;
                    if (citasDiaTitulo) citasDiaTitulo.innerText = `Horarios Disponibles`;
                    if (citasDiaContainer) {
                        // Limpiar solo los empty-states existentes
                        const existingEmptyStates = citasDiaContainer.querySelectorAll('.empty-state');
                        existingEmptyStates.forEach(el => el.remove());
                        
                        // Agregar nuevo empty-state
                        const emptyState = document.createElement('div');
                        emptyState.className = 'empty-state empty-state-10';
                        emptyState.innerHTML = `
                            <i class="fas fa-calendar-day empty-state-icon"></i>
                            <p class="empty-state-text">Seleccione un día del calendario para ver los horarios disponibles.</p>
                        `;
                        citasDiaContainer.appendChild(emptyState);
                        
                        // Asegurarse de que horariosBotones esté en el DOM pero oculto
                        if (horariosBotones && !citasDiaContainer.contains(horariosBotones)) {
                            citasDiaContainer.appendChild(horariosBotones);
                        }
                    }
                    if (horariosBotones) {
                        horariosBotones.classList.add('horarios-botones-hidden');
                        horariosBotones.style.display = 'none';
                        horariosBotones.innerHTML = ''; // Limpiar botones
                    }
                    const horaCitaInput = document.getElementById('hora_cita');
                    if (horaCitaInput) horaCitaInput.value = '';
                    if (fechaHiddenInput) fechaHiddenInput.value = '';
                }
            } else {
                // No hay día seleccionado o no hay datos del calendario
                if (citasDiaTitulo) citasDiaTitulo.innerText = `Horarios Disponibles`;
                if (citasDiaContainer) {
                    // Limpiar solo los empty-states existentes
                    const existingEmptyStates = citasDiaContainer.querySelectorAll('.empty-state');
                    existingEmptyStates.forEach(el => el.remove());
                    
                    // Agregar nuevo empty-state
                    const emptyState = document.createElement('div');
                    emptyState.className = 'empty-state empty-state-10';
                    emptyState.innerHTML = `
                        <i class="fas fa-calendar-day empty-state-icon"></i>
                        <p class="empty-state-text">Seleccione un día del calendario para ver los horarios disponibles.</p>
                    `;
                    citasDiaContainer.appendChild(emptyState);
                    
                    // Asegurarse de que horariosBotones esté en el DOM pero oculto
                    if (horariosBotones && !citasDiaContainer.contains(horariosBotones)) {
                        citasDiaContainer.appendChild(horariosBotones);
                    }
                }
                if (horariosBotones) {
                    horariosBotones.classList.add('horarios-botones-hidden');
                    horariosBotones.style.display = 'none';
                    horariosBotones.innerHTML = ''; // Limpiar botones
                }
            }
        }

        // 4. Event Listeners para navegación (solo si el calendario está disponible)
        if (calendarioDisponible) {
            if (btnPrev) {
                btnPrev.addEventListener('click', () => {
                    navDate.setMonth(navDate.getMonth() - 1);
                    fetchCalendarioDelMes(navDate.getFullYear(), navDate.getMonth());
                });
            }

            if (btnNext) {
                btnNext.addEventListener('click', () => {
                    navDate.setMonth(navDate.getMonth() + 1);
                    fetchCalendarioDelMes(navDate.getFullYear(), navDate.getMonth());
                });
            }

            if (btnToday) {
                btnToday.addEventListener('click', () => {
                    navDate = new Date();
                    fetchCalendarioDelMes(navDate.getFullYear(), navDate.getMonth());
                });
            }

            // 5. Carga inicial del calendario
            fetchCalendarioDelMes(navDate.getFullYear(), navDate.getMonth());
        }

        // --- LÓGICA DEL FORMULARIO (Sección 2) ---
        const form = document.getElementById('solicitud-form');
        const mensajeDiv = document.getElementById('mensaje');
        const submitButton = document.getElementById('submit-button');
        const csrfTokenElement = document.querySelector('[name=csrfmiddlewaretoken]');
        
        if (!form || !mensajeDiv || !submitButton || !csrfTokenElement) {
            console.error('Error: No se encontraron elementos esenciales del formulario');
        } else {
            const csrfToken = csrfTokenElement.value;
            
            // --- Lógica de Drag & Drop ---
            const dropZone = document.getElementById('drop-zone');
            const fileInput = document.getElementById('documentos_adjuntos');
            const fileList = document.getElementById('file-list');
            let droppedFiles = [];
            
            if (dropZone && fileInput) {
                dropZone.addEventListener('click', () => fileInput.click());
                fileInput.addEventListener('change', () => {
                    droppedFiles = Array.from(fileInput.files);
                    updateFileList();
                });
                dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
                dropZone.addEventListener('dragleave', (e) => { e.preventDefault(); dropZone.classList.remove('dragover'); });
                dropZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    dropZone.classList.remove('dragover');
                    droppedFiles = Array.from(e.dataTransfer.files);
                    updateFileList();
                });
            }
            
            function updateFileList() {
                if (fileList) {
                    fileList.innerHTML = '';
                    if (droppedFiles.length > 0) {
                        fileList.innerHTML = '<strong>Archivos seleccionados:</strong>';
                        droppedFiles.forEach(file => {
                            const fileItem = document.createElement('div');
                            fileItem.textContent = file.name;
                            fileList.appendChild(fileItem);
                        });
                    }
                }
            }

            // --- LÓGICA DE ENVÍO ---
            form.addEventListener('submit', async function(e) {
                e.preventDefault(); // Prevenir envío por defecto primero
                
                // Validar que el estudiante haya sido encontrado
                if (!estudianteEncontrado) {
                    mensajeDiv.className = 'error';
                    mensajeDiv.innerHTML = '<strong>Error:</strong><ul><li>Debes buscar tu RUT primero y estar registrado en el sistema para enviar una solicitud.</li></ul>';
                    mensajeDiv.style.display = 'block';
                    rutInput.focus();
                    return;
                }
                
                // Validar que se haya seleccionado una hora
                const horaCitaInput = document.getElementById('hora_cita');
                const fechaCitaInput = document.getElementById('fecha_cita');
                
                // Verificar también si hay un botón seleccionado
                const botonSeleccionado = horariosBotones?.querySelector('.btn-horario.selected');
                
                if (!horaCitaInput || !horaCitaInput.value) {
                    // Si no hay valor en el input, verificar si hay un botón seleccionado
                    if (botonSeleccionado && !botonSeleccionado.disabled) {
                        // Si hay un botón seleccionado disponible, establecer el valor
                        const horaSeleccionada = botonSeleccionado.dataset.hora;
                        if (horaSeleccionada && horaCitaInput) {
                            horaCitaInput.value = horaSeleccionada;
                        } else {
                            mensajeDiv.className = 'error';
                            mensajeDiv.innerHTML = '<strong>Error de Validación:</strong><ul><li><strong>HORA_CITA:</strong> Debe seleccionar un horario disponible.</li></ul>';
                            mensajeDiv.style.display = 'block';
                            return;
                        }
                    } else {
                        mensajeDiv.className = 'error';
                        mensajeDiv.innerHTML = '<strong>Error de Validación:</strong><ul><li><strong>HORA_CITA:</strong> Debe seleccionar un horario disponible.</li></ul>';
                        mensajeDiv.style.display = 'block';
                        return;
                    }
                }
                
                // Validar también que el botón seleccionado no esté deshabilitado
                if (botonSeleccionado && botonSeleccionado.disabled) {
                    mensajeDiv.className = 'error';
                    mensajeDiv.innerHTML = '<strong>Error de Validación:</strong><ul><li><strong>HORA_CITA:</strong> El horario seleccionado no está disponible. Por favor, seleccione otro horario.</li></ul>';
                    mensajeDiv.style.display = 'block';
                    return;
                }
                
                // Validar que se haya seleccionado una fecha
                if (!fechaCitaInput || !fechaCitaInput.value) {
                    mensajeDiv.className = 'error';
                    mensajeDiv.innerHTML = '<strong>Error de Validación:</strong><ul><li><strong>FECHA_CITA:</strong> Debe seleccionar una fecha.</li></ul>';
                    mensajeDiv.style.display = 'block';
                    return;
                }

                submitButton.disabled = true;
                submitButton.innerText = "Enviando Solicitud, espere...";
                mensajeDiv.style.display = 'none';

                const formData = new FormData(form);

                // --- Lógica para archivos ---
                formData.delete('documentos_adjuntos'); 
                for (const file of droppedFiles) {
                    formData.append('documentos_adjuntos', file);
                }

                try {
                    const response = await fetch('/SIAPE/solicitud-publica/', {
                        method: 'POST',
                        body: formData,
                        headers: { 'X-CSRFToken': csrfToken }
                    });

                    const data = await response.json();

                    if (response.ok) { 
                        mensajeDiv.className = 'exito';
                        mensajeDiv.innerHTML = `<strong>¡Solicitud enviada con éxito!</strong> El proceso ha iniciado. Tu <strong>ID de seguimiento de caso es: ${data.solicitud_id}</strong>.`;
                        mensajeDiv.style.display = 'block';
                        form.reset();
                        // Resetear estado del estudiante
                        resetearEstadoEstudiante();
                        // Resetear el checkbox de autorización manualmente si existe
                        const autorizacionCheckbox = document.getElementById('autorizacion_datos');
                        if (autorizacionCheckbox) {
                            autorizacionCheckbox.checked = false;
                        }
                        droppedFiles = [];
                        updateFileList();

                        // Resetear calendario
                        const fechaHiddenInputReset = document.getElementById('fecha_cita');
                        const horaCitaInputReset = document.getElementById('hora_cita');
                        if (fechaHiddenInputReset) fechaHiddenInputReset.value = '';
                        if (horaCitaInputReset) horaCitaInputReset.value = '';
                        diaSeleccionado = null;
                        diaSeleccionadoStr = null;
                        if (citasDiaTitulo) citasDiaTitulo.innerText = `Horarios Disponibles`;
                        if (citasDiaContainer) {
                            // Limpiar solo los empty-states existentes (NO usar innerHTML)
                            const existingEmptyStates = citasDiaContainer.querySelectorAll('.empty-state');
                            existingEmptyStates.forEach(el => el.remove());
                            
                            // Agregar nuevo empty-state
                            const emptyState = document.createElement('div');
                            emptyState.className = 'empty-state empty-state-10';
                            emptyState.innerHTML = `
                                <i class="fas fa-calendar-day empty-state-icon"></i>
                                <p class="empty-state-text">Seleccione un día del calendario para ver los horarios disponibles.</p>
                            `;
                            citasDiaContainer.appendChild(emptyState);
                            
                            // Asegurarse de que horariosBotones esté en el DOM pero oculto
                            const horariosBotonesReset = document.getElementById('horarios-botones');
                            if (horariosBotonesReset) {
                                if (!citasDiaContainer.contains(horariosBotonesReset)) {
                                    citasDiaContainer.appendChild(horariosBotonesReset);
                                }
                                horariosBotonesReset.classList.add('horarios-botones-hidden');
                                horariosBotonesReset.style.display = 'none';
                                horariosBotonesReset.innerHTML = ''; // Limpiar botones
                            }
                            // Asegurarse de que el input hora_cita esté en el DOM
                            if (horaCitaInputReset && !citasDiaContainer.contains(horaCitaInputReset)) {
                                citasDiaContainer.appendChild(horaCitaInputReset);
                            }
                        }
                        if (horariosBotones) {
                            horariosBotones.classList.add('horarios-botones-hidden');
                            horariosBotones.style.display = 'none';
                        }
                        // Recargar el mes actual
                        if (calendarioDisponible) {
                            navDate = new Date();
                            fetchCalendarioDelMes(navDate.getFullYear(), navDate.getMonth());
                        }

                    } else {
                        // Error de validación (HTTP 400)
                        mensajeDiv.className = 'error';
                        let errores = "<strong>Error de Validación:</strong><ul>";

                        // Manejo del error de "hora tomada" (race condition)
                        if (data.non_field_errors) {
                             errores += `<li><strong>HORA:</strong> ${data.non_field_errors[0]}</li>`;
                             // Refrescar el mes, porque la data está desactualizada
                             if (calendarioDisponible) {
                                 fetchCalendarioDelMes(navDate.getFullYear(), navDate.getMonth());
                             }
                             const horaCitaInputError = document.getElementById('hora_cita');
                             if (horaCitaInputError) horaCitaInputError.value = '';
                        }

                        for (const [campo, mensajes] of Object.entries(data)) {
                            if (campo !== 'non_field_errors') {
                               errores += `<li><strong>${campo.toUpperCase()}:</strong> ${mensajes[0]}</li>`;
                            }
                        }
                        errores += "</ul>";
                        mensajeDiv.innerHTML = errores;
                        mensajeDiv.style.display = 'block';
                    }

                } catch (error) {
                    mensajeDiv.className = 'error';
                    mensajeDiv.innerText = 'Error de conexión con el servidor. Inténtalo de nuevo.';
                    mensajeDiv.style.display = 'block';
                    console.error('Error:', error);
                }

                submitButton.disabled = false;
                submitButton.innerText = "Enviar Solicitud y Agendar";
            });
        }
    </script>
{% endblock %}
