{% extends 'plantilla.html' %}
{% load static %}

{% comment %} Bloque para el título de la página {% endcomment %}
{% block title %}Solicitud de Apoyo | SIAPE{% endblock %}

{% comment %} 
  Bloque para los estilos CSS específicos de esta página.
{% endcomment %}
{% block extra_head %}
    <!-- 
      Asegúrate de que base.css se cargue primero (desde plantilla.html)
      y que formulario.css contenga los estilos del calendario.
    -->
    <link rel="stylesheet" href="{% static 'css/formulario.css' %}">
{% endblock %}


{% comment %} Bloque para el contenido principal de la página {% endcomment %}
{% block content %}
    <div class="form-container">
        
        <div class="form-header">
            <h1>Solicitud de Entrevista de Apoyo</h1>
            <p>Ingresa tus datos y el asunto para agendar una entrevista con la Coordinación de Inclusión.</p>
        </div>

        <form id="solicitud-form" enctype="multipart/form-data">
            {% csrf_token %}

            <!-- Campos del formulario en 2 columnas -->
            <div class="form-grid">
                
                <!-- Columna Izquierda -->
                <div class="form-group">
                    <label for="nombres">Nombres <span>*</span></label>
                    <input type="text" id="nombres" name="nombres" placeholder="Ej: Juan" required>
                </div>
                
                <div class="form-group">
                    <label for="apellidos">Apellidos <span>*</span></label>
                    <input type="text" id="apellidos" name="apellidos" placeholder="Ej: Pérez González" required>
                </div>

                
                <div class="form-group">
                    <label for="carrera_id">Tu Carrera <span>*</span></label>
                    <select id="carrera_id" name="carrera_id" required>
                        <option value="">-- Selecciona tu carrera --</option>
                        {% for c in carreras %}
                            <option value="{{ c.id }}">{{ c.nombre }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Columna Derecha -->
                <div class="form-group">
                    <label for="email">Correo Electrónico <span>*</span></label>
                    <input type="email" id="email" name="email" placeholder="juan.perez@estudiante.edu" required>
                </div>

                <div class="form-group">
                    <label for="rut">RUT<span>*</span></label>
                    <input type="text" id="rut" name="rut" placeholder="Ej: 12345678-K" required>
                </div>

                <div class="form-group">
                    <label for="numero">Teléfono de Contacto (Opcional)</label>
                    <input type="text" id="numero" name="numero" placeholder="Ej: +56 9 1234 5678">
                </div>
            </div>

            <!-- Asunto (Ancho completo) -->
            <div class="form-group">
                <label for="asunto">Asunto o Motivo de la Solicitud <span>*</span></label>
                <input type="text" id="asunto" name="asunto" placeholder="Ej: Dificultades de concentración, Apoyo por discapacidad auditiva" required>
            </div>
            
            <!-- EL CAMPO 'descripcion' SE ELIMINA DE AQUÍ -->

            <!-- === SECCIÓN DE AGENDAMIENTO (NUEVA CON CALENDARIO) === -->
            <div class="form-group">
                <label>Agendamiento de Entrevista</label>
                <p style="font-size: 0.9em; color: #555; margin-top: -10px;">
                    Por favor, selecciona un día y hora para tu entrevista con la Coordinadora de Inclusión.
                    (Horario de Lunes a Viernes, de 9:00 a 18:00).
                </p>

                <!-- Contenedor copiado de 'panel_control_asesor.html' -->
                <div class="cal-layout-container">
                    
                    <!-- Columna 1: El Calendario -->
                    <div class="cal-widget">
                        <div class="detalle-card" id="card-calendario-panel">
                            <div class="calendario-header" id="cal-header">
                                Cargando mes...
                            </div>
                            <div class="cal-nav">
                                <button type="button" id="cal-prev" class="btn-accion btn-accion-gray btn-accion-small"><i class="fas fa-chevron-left"></i> Ant</button>
                                <button type="button" id="cal-today" class="btn-accion btn-accion-gray btn-accion-small">Hoy</button>
                                <button type="button" id="cal-next" class="btn-accion btn-accion-gray btn-accion-small">Sig <i class="fas fa-chevron-right"></i></button>
                            </div>
                            <div class="calendario-grid" id="cal-grid-body">
                                <!-- Los días se insertan aquí por JS -->
                            </div>
                            <div class="calendario-leyenda calendario-leyenda-mt">
                                <div><span class="dot dot-disponible"></span> Día Disponible</div>
                                <div><span class="dot dot-lleno"></span> Día Completo</div>
                            </div>
                        </div>
                    </div>

                    <!-- Columna 2: El Selector de Hora -->
                    <div class="cal-citas-list">
                        <h4 id="cal-citas-titulo">2. Horarios disponibles</h4>
                        <div id="cal-citas-dia">
                            <div id="horario-loader" style="font-size: 0.9em; margin-top: 5px;"></div>
                            <div class="horarios-botones" id="horarios-botones"></div>
                            <input type="hidden" id="hora_cita" name="hora_cita" required>
                        </div>
                    </div>
                </div>
                
                <!-- Input oculto para enviar la fecha seleccionada -->
                <input type="hidden" id="fecha_cita" name="fecha_cita">
            </div>
            <!-- === FIN SECCIÓN DE AGENDAMIENTO === -->


            <!-- Zona de Carga de Archivos (Opcional) -->
            <div class="form-group">
                <label>Documentos de Apoyo (Opcional)</label>
                <div class="drop-zone" id="drop-zone">
                    <input type="file" id="documentos_adjuntos" name="documentos_adjuntos" multiple>
                    <p class="drop-zone__prompt">Arrastra archivos aquí o <strong>haz clic para seleccionar</strong></p>
                    <small>Si ya tienes un diagnóstico o informe, puedes adjuntarlo aquí.</small>
                </div>
                <div id="file-list"></div>
            </div>

            <!-- Autorización -->
            <div class="auth-group">
                <input type="checkbox" id="autorizacion_datos" name="autorizacion_datos" required>
                <label for="autorizacion_datos">
                    Autorizo el tratamiento de mis datos personales de acuerdo con la Política de Privacidad y acepto los Términos y Condiciones del servicio. <span>*</span>
                </label>
            </div>

            <!-- Caja de Información -->
            <div class="info-box">
                <h4>Importante:</h4>
                <ul>
                    <li>Tu solicitud y entrevista quedarán agendadas al enviar este formulario.</li>
                    <li>Recibirás una confirmación por correo electrónico.</li>
                    <li>La información proporcionada debe ser veraz y completa.</li>
                </ul>
            </div>

            <!-- Botones de Acción -->
            <div class="button-group">
                <button type="submit" id="submit-button" class="btn btn-primary">Enviar Solicitud y Agendar</button>
            </div>
        </form>

        <div id="mensaje"></div>
    </div>

    <!-- El script se queda aquí, al final del bloque de contenido -->
    <script>
        // --- LÓGICA DEL FORMULARIO (Sección 1) ---
        const form = document.getElementById('solicitud-form');
        const mensajeDiv = document.getElementById('mensaje');
        const submitButton = document.getElementById('submit-button');
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        
        // --- Lógica de Drag & Drop (se mantiene) ---
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('documentos_adjuntos');
        const fileList = document.getElementById('file-list');
        let droppedFiles = [];
        dropZone.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', () => {
            droppedFiles = Array.from(fileInput.files);
            updateFileList();
        });
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
        dropZone.addEventListener('dragleave', (e) => { e.preventDefault(); dropZone.classList.remove('dragover'); });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            droppedFiles = Array.from(e.dataTransfer.files);
            updateFileList();
        });
        function updateFileList() {
            fileList.innerHTML = '';
            if (droppedFiles.length > 0) {
                fileList.innerHTML = '<strong>Archivos seleccionados:</strong>';
                droppedFiles.forEach(file => {
                    const fileItem = document.createElement('div');
                    fileItem.textContent = file.name;
                    fileList.appendChild(fileItem);
                });
            }
        }

        // --- LÓGICA DEL CALENDARIO (Sección 2) ---
        
        // Variables globales del calendario
        let navDate = new Date();
        const hoy = new Date();
        const hoyStr = hoy.toISOString().split('T')[0]; // "YYYY-MM-DD"
        let diaSeleccionadoEl = null; 
        let calendarioData = {}; // Guardará la data de la API

        // Elementos del DOM del calendario
        const calHeader = document.getElementById('cal-header');
        const calGridBody = document.getElementById('cal-grid-body');
        const btnPrev = document.getElementById('cal-prev');
        const btnNext = document.getElementById('cal-next');
        const btnToday = document.getElementById('cal-today');
        
        // Elementos del DOM del selector de hora
        const horaSelect = document.getElementById('hora_cita');
        const horaLabel = document.getElementById('hora_label');
        const horarioLoader = document.getElementById('horario-loader');
        const fechaHiddenInput = document.getElementById('fecha_cita');

        const meses = [
            "Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio",
            "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"
        ];

        // 1. Función para buscar datos del mes
        async function fetchCalendarioDelMes(year, month) {
            calHeader.innerText = `Cargando ${meses[month]} ${year}...`;
            calGridBody.innerHTML = ''; // Limpiar
            
            try {
                const monthStr = `${year}-${String(month + 1).padStart(2, '0')}`;
                // Usamos la URL que definimos en urls.py
                const response = await fetch(`/api/calendario-disponible/?month=${monthStr}`);
                
                if (!response.ok) throw new Error('Error de red');
                
                calendarioData = await response.json();
                renderCalendar(year, month); // Llama a renderizar con los nuevos datos

            } catch (error) {
                console.error('Error fetching calendario:', error);
                calHeader.innerText = "Error al cargar calendario";
            }
        }
        
        // 2. Función para renderizar el calendario (ADAPTADA)
        function renderCalendar(year, month) {
            calHeader.innerText = `${meses[month]} ${year}`;
            calGridBody.innerHTML = `
                <div class="cal-day-header">L</div> <div class="cal-day-header">M</div>
                <div class="cal-day-header">X</div> <div class="cal-day-header">J</div>
                <div class="cal-day-header">V</div> <div class="cal-day-header">S</div>
                <div class="cal-day-header">D</div>
            `;
            const primerDiaDelMes = new Date(year, month, 1);
            const ultimoDiaDelMes = new Date(year, month + 1, 0);
            const ultimoDiaNum = ultimoDiaDelMes.getDate();
            let diaInicioSemana = (primerDiaDelMes.getDay() + 6) % 7; // Lunes=0
            const ultimoDiaMesAnterior = new Date(year, month, 0).getDate();
            // Días mes anterior
            for (let i = diaInicioSemana; i > 0; i--) {
                const dayDiv = document.createElement('div');
                dayDiv.classList.add('cal-day', 'other-month');
                dayDiv.innerText = ultimoDiaMesAnterior - i + 1;
                calGridBody.appendChild(dayDiv);
            }
            // Días mes actual (todos seleccionables, como en panel asesor)
            for (let dia = 1; dia <= ultimoDiaNum; dia++) {
                const dayDiv = document.createElement('div');
                dayDiv.classList.add('cal-day');
                dayDiv.innerText = dia;
                const fechaStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(dia).padStart(2, '0')}`;
                dayDiv.dataset.fecha = fechaStr;
                // Resaltar día actual (azul)
                if (fechaStr === hoyStr) {
                    dayDiv.classList.add('day-today');
                }
                // Resaltar día seleccionado (rojo)
                if (diaSeleccionadoEl && diaSeleccionadoEl.dataset.fecha === fechaStr) {
                    dayDiv.classList.add('cal-day-selected');
                }
                // Colorear según disponibilidad
                if (calendarioData.fechasConDisponibilidad?.includes(fechaStr)) {
                    dayDiv.classList.add('day-disponible');
                } else if (calendarioData.diasCompletos?.includes(fechaStr)) {
                    dayDiv.classList.add('day-lleno');
                }
                // Permitir seleccionar cualquier día del mes actual (no días pasados)
                if (fechaStr >= hoyStr) {
                    dayDiv.addEventListener('click', () => seleccionarDia(dayDiv, fechaStr));
                } else {
                    dayDiv.classList.add('day-inabil');
                }
                calGridBody.appendChild(dayDiv);
            }
            // Días mes siguiente
            const totalDiasGrid = calGridBody.children.length;
            const diasSiguientes = (7 - (totalDiasGrid % 7)) % 7;
            for (let i = 1; i <= diasSiguientes; i++) {
                const dayDiv = document.createElement('div');
                dayDiv.classList.add('cal-day', 'other-month');
                dayDiv.innerText = i;
                calGridBody.appendChild(dayDiv);
            }
        }

        // 3. Función para manejar el clic en un día
        function seleccionarDia(dayEl, fechaStr) {
            // Resaltar día seleccionado (rojo) y día actual (azul)
            if (diaSeleccionadoEl) {
                diaSeleccionadoEl.classList.remove('cal-day-selected');
            }
            dayEl.classList.add('cal-day-selected');
            diaSeleccionadoEl = dayEl;
            // Guardar fecha en el input oculto
            fechaHiddenInput.value = fechaStr;
            // Mostrar horarios como botones
            const horariosBotones = document.getElementById('horarios-botones');
            horariosBotones.innerHTML = '';
            const slotsDisponibles = calendarioData.slotsDetallados[fechaStr] || [];
            const allSlots = [];
            for (let h = 9; h <= 17; h++) {
                const hora = `${h.toString().padStart(2, '0')}:00`;
                allSlots.push(hora);
            }
            let hayDisponibles = false;
            let selectedHora = document.getElementById('hora_cita').value;
            for (const slot of allSlots) {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'btn-horario';
                btn.textContent = `${slot} - ${parseInt(slot.split(':')[0]) + 1}:00`;
                btn.dataset.hora = slot;
                if (slotsDisponibles.includes(slot)) {
                    btn.disabled = false;
                    hayDisponibles = true;
                    btn.addEventListener('click', function() {
                        horariosBotones.querySelectorAll('.btn-horario').forEach(b => b.classList.remove('selected'));
                        btn.classList.add('selected');
                        document.getElementById('hora_cita').value = slot;
                        console.log('[DEBUG] Hora seleccionada:', slot);
                        console.log('[DEBUG] Valor input hora_cita:', document.getElementById('hora_cita').value);
                    });
                    if (selectedHora === slot) {
                        btn.classList.add('selected');
                    }
                } else {
                    btn.disabled = true;
                    btn.classList.add('no-disponible');
                }
                horariosBotones.appendChild(btn);
            }
            if (!hayDisponibles) {
                document.getElementById('horario-loader').innerHTML = '<strong style="color: #fd7e14;">No hay horas disponibles para este día.</strong>';
            } else {
                document.getElementById('horario-loader').innerHTML = '';
            }
        }

        // 4. Listeners de navegación del calendario
        btnPrev.addEventListener('click', () => {
            navDate.setMonth(navDate.getMonth() - 1);
            fetchCalendarioDelMes(navDate.getFullYear(), navDate.getMonth());
        });
        btnNext.addEventListener('click', () => {
            navDate.setMonth(navDate.getMonth() + 1);
            fetchCalendarioDelMes(navDate.getFullYear(), navDate.getMonth());
        });
        btnToday.addEventListener('click', () => {
            navDate = new Date();
            fetchCalendarioDelMes(navDate.getFullYear(), navDate.getMonth());
        });

        // 5. Carga inicial del calendario
        fetchCalendarioDelMes(navDate.getFullYear(), navDate.getMonth());


        // --- LÓGICA DE ENVÍO (Sección 3) ---
        form.addEventListener('submit', async function(e) {
            // Validar que se haya seleccionado una hora
            console.log('[DEBUG] Valor input hora_cita al enviar:', document.getElementById('hora_cita').value);
            if (!document.getElementById('hora_cita').value) {
                mensajeDiv.className = 'error';
                mensajeDiv.innerHTML = '<strong>Error de Validación:</strong><ul><li><strong>HORA_CITA:</strong> Debe seleccionar un horario disponible.</li></ul>';
                mensajeDiv.style.display = 'block';
                e.preventDefault();
                return;
            }
            
            e.preventDefault();
            
            submitButton.disabled = true;
            submitButton.innerText = "Enviando Solicitud, espere...";
            mensajeDiv.style.display = 'none';

            const formData = new FormData(form);
            
            // --- Lógica para archivos ---
            formData.delete('documentos_adjuntos'); 
            for (const file of droppedFiles) {
                formData.append('documentos_adjuntos', file);
            }

            try {
                const response = await fetch('/SIAPE/solicitud-publica/', {
                    method: 'POST',
                    body: formData,
                    headers: { 'X-CSRFToken': csrfToken }
                });

                const data = await response.json();

                if (response.ok) { 
                    mensajeDiv.className = 'exito';
                    mensajeDiv.innerHTML = `<strong>¡Solicitud enviada con éxito!</strong> El proceso ha iniciado. Tu <strong>ID de seguimiento de caso es: ${data.solicitud_id}</strong>.`;
                    mensajeDiv.style.display = 'block';
                    form.reset(); 
                    droppedFiles = [];
                    updateFileList();
                    
                    // Resetear calendario
                    fechaHiddenInput.value = '';
                    horaSelect.innerHTML = '<option value="">-- Seleccione un día primero --</option>';
                    horaSelect.disabled = true;
                    horaLabel.innerText = "Por favor, seleccione un día disponible del calendario.";
                    if (diaSeleccionadoEl) diaSeleccionadoEl.classList.remove('cal-day-selected');
                    // Recargar el mes actual
                    fetchCalendarioDelMes(new Date().getFullYear(), new Date().getMonth());

                } else {
                    // Error de validación (HTTP 400)
                    mensajeDiv.className = 'error';
                    let errores = "<strong>Error de Validación:</strong><ul>";
                    
                    // Manejo del error de "hora tomada" (race condition)
                    if (data.non_field_errors) {
                         errores += `<li><strong>HORA:</strong> ${data.non_field_errors[0]}</li>`;
                         // Refrescar el mes, porque la data está desactualizada
                         fetchCalendarioDelMes(navDate.getFullYear(), navDate.getMonth());
                         horaSelect.innerHTML = '<option value="">-- Hora no válida --</option>';
                         horaSelect.disabled = true;
                    }

                    for (const [campo, mensajes] of Object.entries(data)) {
                        if (campo !== 'non_field_errors') {
                           errores += `<li><strong>${campo.toUpperCase()}:</strong> ${mensajes[0]}</li>`;
                        }
                    }
                    errores += "</ul>";
                    mensajeDiv.innerHTML = errores;
                    mensajeDiv.style.display = 'block';
                }

            } catch (error) {
                mensajeDiv.className = 'error';
                mensajeDiv.innerText = 'Error de conexión con el servidor. Inténtalo de nuevo.';
                mensajeDiv.style.display = 'block';
                console.error('Error:', error);
            }

            submitButton.disabled = false;
            submitButton.innerText = "Enviar Solicitud y Agendar";
        });
    </script>
{% endblock %}