{% extends 'plantilla.html' %}
{% load static %}

{% comment %} Bloque para el título de la página {% endcomment %}
{% block title %}Solicitud de Apoyo | SIAPE{% endblock %}

{% comment %} 
  Bloque para los estilos CSS específicos de esta página.
{% endcomment %}
{% block extra_head %}
    <!-- 
      Asegúrate de que base.css se cargue primero (desde plantilla.html)
      y que formulario.css contenga los estilos del calendario.
    -->
    <link rel="stylesheet" href="{% static 'css/formulario.css' %}">
{% endblock %}


{% comment %} Bloque para el contenido principal de la página {% endcomment %}
{% block content %}
    <div class="form-container">
        
        <div class="form-header">
            <h1>Solicitud de Entrevista de Apoyo</h1>
            <p>Ingresa tus datos y el asunto para agendar una entrevista con la Coordinación de Inclusión.</p>
        </div>

        <form id="solicitud-form" enctype="multipart/form-data">
            {% csrf_token %}

            <!-- Campos del formulario en 2 columnas -->
            <div class="form-grid">
                
                <!-- Columna Izquierda -->
                <div class="form-group">
                    <label for="nombres">Nombres <span>*</span></label>
                    <input type="text" id="nombres" name="nombres" placeholder="Ej: Juan" required>
                </div>
                
                <div class="form-group">
                    <label for="apellidos">Apellidos <span>*</span></label>
                    <input type="text" id="apellidos" name="apellidos" placeholder="Ej: Pérez González" required>
                </div>

                
                <div class="form-group">
                    <label for="carrera_id">Tu Carrera <span>*</span></label>
                    <select id="carrera_id" name="carrera_id" required>
                        <option value="">-- Selecciona tu carrera --</option>
                        {% for c in carreras %}
                            <option value="{{ c.id }}">{{ c.nombre }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Columna Derecha -->
                <div class="form-group">
                    <label for="email">Correo Electrónico <span>*</span></label>
                    <input type="email" id="email" name="email" placeholder="juan.perez@estudiante.edu" required>
                </div>

                <div class="form-group">
                    <label for="rut">RUT<span>*</span></label>
                    <input type="text" id="rut" name="rut" placeholder="Ej: 12345678-K" required>
                </div>

                <div class="form-group">
                    <label for="numero">Teléfono de Contacto (Opcional)</label>
                    <input type="text" id="numero" name="numero" placeholder="Ej: +56 9 1234 5678">
                </div>
            </div>

            <!-- Asunto (Ancho completo) -->
            <div class="form-group">
                <label for="asunto">Asunto o Motivo de la Solicitud <span>*</span></label>
                <input type="text" id="asunto" name="asunto" placeholder="Ej: Dificultades de concentración, Apoyo por discapacidad auditiva" required>
            </div>
            
            <!-- EL CAMPO 'descripcion' SE ELIMINA DE AQUÍ -->

            <!-- === SECCIÓN DE AGENDAMIENTO (NUEVA CON CALENDARIO) === -->
            <div class="form-group">
                <label>Agendamiento de Entrevista</label>
                <p style="font-size: 0.9em; color: #555; margin-top: -10px;">
                    Por favor, selecciona un día y hora para tu entrevista con la Coordinadora de Inclusión.
                    (Horario de Lunes a Viernes, de 9:00 a 18:00).
                </p>

                <!-- Contenedor copiado de 'panel_control_asesor.html' -->
                <div class="cal-layout-container">
                    
                    <!-- Columna 1: El Calendario -->
                    <div class="cal-widget">
                        <div class="detalle-card" id="card-calendario-panel">
                            <div class="calendario-header" id="cal-header">
                                <!-- El mes se inserta aquí por JS -->
                            </div>
                            <!-- Navegación movida encima de la grilla -->
                            <div class="cal-nav">
                                <button type="button" id="cal-prev" class="btn-accion btn-accion-gray btn-accion-small"><i class="fas fa-chevron-left"></i> Ant</button>
                                <button type="button" id="cal-today" class="btn-accion btn-accion-gray btn-accion-small">Hoy</button>
                                <button type="button" id="cal-next" class="btn-accion btn-accion-gray btn-accion-small">Sig <i class="fas fa-chevron-right"></i></button>
                            </div>
                            <div class="calendario-grid" id="cal-grid-body">
                                <!-- Los días se insertan aquí por JS -->
                            </div>
                            <div class="calendario-leyenda calendario-leyenda-mt">
                                <div><span class="dot dot-disponible"></span> Día Disponible</div>
                                <div><span class="dot dot-lleno"></span> Día Completo</div>
                            </div>
                        </div>
                    </div>

                    <!-- Columna 2: El Selector de Hora -->
                    <div class="cal-citas-list">
                        <h4 id="cal-citas-titulo">Horarios Disponibles</h4>
                        <div id="cal-citas-dia">
                            <!-- El contenido se inserta aquí por JS -->
                            <div class="empty-state empty-state-10">
                                <i class="fas fa-calendar-day" style="font-size: 2rem; margin-bottom: 10px;"></i>
                                <p style="font-size: 0.9rem;">Seleccione un día del calendario para ver los horarios disponibles.</p>
                            </div>
                            <div class="horarios-botones" id="horarios-botones" style="display: none;"></div>
                            <input type="hidden" id="hora_cita" name="hora_cita" required>
                        </div>
                    </div>
                </div>
                
                <!-- Input oculto para enviar la fecha seleccionada -->
                <input type="hidden" id="fecha_cita" name="fecha_cita">
            </div>
            <!-- === FIN SECCIÓN DE AGENDAMIENTO === -->


            <!-- Zona de Carga de Archivos (Opcional) -->
            <div class="form-group">
                <label>Documentos de Apoyo (Opcional)</label>
                <div class="drop-zone" id="drop-zone">
                    <input type="file" id="documentos_adjuntos" name="documentos_adjuntos" multiple>
                    <p class="drop-zone__prompt">Arrastra archivos aquí o <strong>haz clic para seleccionar</strong></p>
                    <small>Si ya tienes un diagnóstico o informe, puedes adjuntarlo aquí.</small>
                </div>
                <div id="file-list"></div>
            </div>

            <!-- Autorización -->
            <div class="auth-group">
                <input type="checkbox" id="autorizacion_datos" name="autorizacion_datos" required>
                <label for="autorizacion_datos">
                    Autorizo el tratamiento de mis datos personales de acuerdo con la Política de Privacidad y acepto los Términos y Condiciones del servicio. <span>*</span>
                </label>
            </div>

            <!-- Caja de Información -->
            <div class="info-box">
                <h4>Importante:</h4>
                <ul>
                    <li>Tu solicitud y entrevista quedarán agendadas al enviar este formulario.</li>
                    <li>Recibirás una confirmación por correo electrónico.</li>
                    <li>La información proporcionada debe ser veraz y completa.</li>
                </ul>
            </div>

            <!-- Botones de Acción -->
            <div class="button-group">
                <button type="submit" id="submit-button" class="btn btn-primary">Enviar Solicitud y Agendar</button>
            </div>
        </form>

        <div id="mensaje"></div>
    </div>

    <!-- El script se queda aquí, al final del bloque de contenido -->
    <script>
        // --- LÓGICA DEL FORMULARIO (Sección 1) ---
        const form = document.getElementById('solicitud-form');
        const mensajeDiv = document.getElementById('mensaje');
        const submitButton = document.getElementById('submit-button');
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        
        // --- Lógica de Drag & Drop (se mantiene) ---
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('documentos_adjuntos');
        const fileList = document.getElementById('file-list');
        let droppedFiles = [];
        dropZone.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', () => {
            droppedFiles = Array.from(fileInput.files);
            updateFileList();
        });
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
        dropZone.addEventListener('dragleave', (e) => { e.preventDefault(); dropZone.classList.remove('dragover'); });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            droppedFiles = Array.from(e.dataTransfer.files);
            updateFileList();
        });
        function updateFileList() {
            fileList.innerHTML = '';
            if (droppedFiles.length > 0) {
                fileList.innerHTML = '<strong>Archivos seleccionados:</strong>';
                droppedFiles.forEach(file => {
                    const fileItem = document.createElement('div');
                    fileItem.textContent = file.name;
                    fileList.appendChild(fileItem);
                });
            }
        }

        // --- LÓGICA DEL CALENDARIO (Sección 2) ---
        
        // Variables globales del calendario
        let navDate = new Date();
        const hoy = new Date();
        const hoyStr = `${hoy.getFullYear()}-${String(hoy.getMonth() + 1).padStart(2, '0')}-${String(hoy.getDate()).padStart(2, '0')}`;
        let diaSeleccionado = null; 
        let diaSeleccionadoStr = null;
        let calendarioData = {}; // Guardará la data de la API

        // Elementos del DOM del calendario
        const calHeader = document.getElementById('cal-header');
        const calGridBody = document.getElementById('cal-grid-body');
        const btnPrev = document.getElementById('cal-prev');
        const btnNext = document.getElementById('cal-next');
        const btnToday = document.getElementById('cal-today');
        const citasDiaContainer = document.getElementById('cal-citas-dia');
        const citasDiaTitulo = document.getElementById('cal-citas-titulo');
        const horariosBotones = document.getElementById('horarios-botones');
        const fechaHiddenInput = document.getElementById('fecha_cita');

        const meses = [
            "Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio",
            "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"
        ];

        // 1. Función para buscar datos del mes
        async function fetchCalendarioDelMes(year, month) {
            calHeader.innerText = `Cargando ${meses[month]} ${year}...`;
            
            try {
                const monthStr = `${year}-${String(month + 1).padStart(2, '0')}`;
                const response = await fetch(`/api/calendario-disponible/?month=${monthStr}`);
                
                if (!response.ok) throw new Error('Error de red');
                
                calendarioData = await response.json();
                renderCalendar(year, month);

            } catch (error) {
                console.error('Error fetching calendario:', error);
                calHeader.innerText = "Error al cargar calendario";
            }
        }

        // 2. Función para mostrar los horarios de un día
        function mostrarHorariosDelDia(fechaStr, diaEl) {
            // Actualizar título
            const [year, month, day] = fechaStr.split('-');
            citasDiaTitulo.innerText = `Horarios para ${day}/${month}/${year}`;

            // Resaltar día seleccionado
            if (diaSeleccionado) {
                diaSeleccionado.classList.remove('cal-day-selected');
            }
            
            if(diaEl) {
                diaEl.classList.add('cal-day-selected');
                diaSeleccionado = diaEl;
                diaSeleccionadoStr = fechaStr;
            } else {
                diaSeleccionado = calGridBody.querySelector(`[data-fecha="${fechaStr}"]`);
                if (diaSeleccionado) {
                    diaSeleccionado.classList.add('cal-day-selected');
                }
            }

            // Guardar fecha en el input oculto
            fechaHiddenInput.value = fechaStr;
            document.getElementById('hora_cita').value = '';

            const slotsDisponibles = calendarioData.slotsDetallados?.[fechaStr] || [];
            const slotsNoDisponibles = calendarioData.slotsNoDisponibles?.[fechaStr] || [];
            
            // Limpiar contenido previo
            const existingEmptyState = citasDiaContainer.querySelector('.empty-state');
            if (existingEmptyState) {
                existingEmptyState.remove();
            }
            horariosBotones.innerHTML = '';
            
            if (slotsDisponibles.length === 0) {
                citasDiaContainer.insertAdjacentHTML('afterbegin', `
                    <div class="empty-state empty-state-10">
                        <i class="fas fa-calendar-check" style="font-size: 2rem; margin-bottom: 10px;"></i>
                        <p style="font-size: 0.9rem;">No hay horarios disponibles para este día.</p>
                    </div>
                `);
                horariosBotones.style.display = 'none';
                return;
            }

            // Mostrar botones
            horariosBotones.style.display = 'flex';

            // Generar todos los slots de 9:00 a 17:00
            const allSlots = [];
            for (let h = 9; h <= 17; h++) {
                allSlots.push(`${h.toString().padStart(2, '0')}:00`);
            }

            // Crear botones para cada horario
            for (const slot of allSlots) {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'btn-horario';
                const horaInicio = parseInt(slot.split(':')[0]);
                const horaFin = horaInicio + 1;
                btn.textContent = `${slot} - ${horaFin.toString().padStart(2, '0')}:00`;
                btn.dataset.hora = slot;

                if (slotsDisponibles.includes(slot)) {
                    btn.disabled = false;
                    btn.addEventListener('click', function() {
                        horariosBotones.querySelectorAll('.btn-horario').forEach(b => b.classList.remove('selected'));
                        btn.classList.add('selected');
                        document.getElementById('hora_cita').value = slot;
                        mensajeDiv.style.display = 'none';
                    });
                } else {
                    btn.disabled = true;
                    btn.classList.add('no-disponible');
                    if (slotsNoDisponibles.includes(slot)) {
                        btn.title = 'Hora no disponible (ya tomada o fuera de horario)';
                    } else {
                        btn.title = 'Hora no disponible';
                    }
                }
                horariosBotones.appendChild(btn);
            }
        }
        
        // 3. Función principal para renderizar el calendario
        function renderCalendar(year, month) {
            calHeader.innerText = `${meses[month]} ${year}`;
            
            // Limpiamos la grilla e inyectamos los encabezados
            calGridBody.innerHTML = `
                <div class="cal-day-header">L</div>
                <div class="cal-day-header">M</div>
                <div class="cal-day-header">X</div>
                <div class="cal-day-header">J</div>
                <div class="cal-day-header">V</div>
                <div class="cal-day-header">S</div>
                <div class="cal-day-header">D</div>
            `;
            
            const primerDiaDelMes = new Date(year, month, 1);
            const ultimoDiaDelMes = new Date(year, month + 1, 0);
            const ultimoDiaNum = ultimoDiaDelMes.getDate();
            let diaInicioSemana = (primerDiaDelMes.getDay() + 6) % 7;
            const ultimoDiaMesAnterior = new Date(year, month, 0).getDate();

            // Días del mes anterior
            for (let i = diaInicioSemana; i > 0; i--) {
                const dia = ultimoDiaMesAnterior - i + 1;
                const dayDiv = document.createElement('div');
                dayDiv.classList.add('cal-day', 'other-month');
                dayDiv.innerText = dia;
                calGridBody.appendChild(dayDiv);
            }

            // Días del mes actual
            for (let dia = 1; dia <= ultimoDiaNum; dia++) {
                const dayDiv = document.createElement('div');
                dayDiv.classList.add('cal-day');
                dayDiv.innerText = dia;

                const fechaStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(dia).padStart(2, '0')}`;
                dayDiv.dataset.fecha = fechaStr;

                const fechaDate = new Date(year, month, dia);
                const diaSemana = fechaDate.getDay(); // 0 = Domingo, 6 = Sábado
                const esFinDeSemana = diaSemana === 0 || diaSemana === 6;
                const hoyDate = new Date(hoy.getFullYear(), hoy.getMonth(), hoy.getDate());
                const esDiaPasado = fechaDate < hoyDate;
                const esSeleccionable = !esFinDeSemana && !esDiaPasado;

                if (fechaStr === hoyStr) {
                    dayDiv.classList.add('day-today');
                }

                // Colorear según disponibilidad (solo días hábiles)
                if (esSeleccionable) {
                    if (calendarioData.fechasConDisponibilidad?.includes(fechaStr)) {
                        dayDiv.classList.add('day-disponible');
                    } else if (calendarioData.diasCompletos?.includes(fechaStr)) {
                        dayDiv.classList.add('day-lleno');
                    }
                } else if (esFinDeSemana) {
                    // Fines de semana no disponibles
                    dayDiv.classList.add('day-inabil');
                } else if (esDiaPasado) {
                    // Días pasados no disponibles
                    dayDiv.classList.add('day-inabil');
                }

                // Solo permitir seleccionar días hábiles futuros o hoy
                if (esSeleccionable) {
                    dayDiv.addEventListener('click', () => mostrarHorariosDelDia(fechaStr, dayDiv));
                }
                
                calGridBody.appendChild(dayDiv);
            }

            // Días del mes siguiente
            const totalDiasGrid = calGridBody.children.length;
            const diasSiguientes = (7 - (totalDiasGrid % 7)) % 7;
            for (let i = 1; i <= diasSiguientes; i++) {
                const dayDiv = document.createElement('div');
                dayDiv.classList.add('cal-day', 'other-month');
                dayDiv.innerText = i;
                calGridBody.appendChild(dayDiv);
            }
            
            // Al re-renderizar, si un día estaba seleccionado, lo volvemos a mostrar
            if (diaSeleccionadoStr) {
                const [selYear, selMonth] = diaSeleccionadoStr.split('-');
                if (parseInt(selYear) === year && parseInt(selMonth) === (month + 1)) {
                    mostrarHorariosDelDia(diaSeleccionadoStr, null);
                } else {
                    diaSeleccionado = null;
                    diaSeleccionadoStr = null;
                    citasDiaTitulo.innerText = `Horarios Disponibles`;
                    citasDiaContainer.innerHTML = `
                        <div class="empty-state empty-state-10">
                            <i class="fas fa-calendar-day" style="font-size: 2rem; margin-bottom: 10px;"></i>
                            <p style="font-size: 0.9rem;">Seleccione un día del calendario para ver los horarios disponibles.</p>
                        </div>
                    `;
                    horariosBotones.style.display = 'none';
                }
            }
        }

        // 4. Event Listeners para navegación
        btnPrev.addEventListener('click', () => {
            navDate.setMonth(navDate.getMonth() - 1);
            fetchCalendarioDelMes(navDate.getFullYear(), navDate.getMonth());
        });

        btnNext.addEventListener('click', () => {
            navDate.setMonth(navDate.getMonth() + 1);
            fetchCalendarioDelMes(navDate.getFullYear(), navDate.getMonth());
        });

        btnToday.addEventListener('click', () => {
            navDate = new Date();
            fetchCalendarioDelMes(navDate.getFullYear(), navDate.getMonth());
        });

        // 5. Carga inicial del calendario
        fetchCalendarioDelMes(navDate.getFullYear(), navDate.getMonth());


        // --- LÓGICA DE ENVÍO (Sección 3) ---
        form.addEventListener('submit', async function(e) {
            // Validar que se haya seleccionado una hora
            const horaCitaInput = document.getElementById('hora_cita');
            if (!horaCitaInput.value) {
                mensajeDiv.className = 'error';
                mensajeDiv.innerHTML = '<strong>Error de Validación:</strong><ul><li><strong>HORA_CITA:</strong> Debe seleccionar un horario disponible.</li></ul>';
                mensajeDiv.style.display = 'block';
                e.preventDefault();
                return;
            }

            e.preventDefault();

            submitButton.disabled = true;
            submitButton.innerText = "Enviando Solicitud, espere...";
            mensajeDiv.style.display = 'none';

            const formData = new FormData(form);

            // --- Lógica para archivos ---
            formData.delete('documentos_adjuntos'); 
            for (const file of droppedFiles) {
                formData.append('documentos_adjuntos', file);
            }

            try {
                const response = await fetch('/SIAPE/solicitud-publica/', {
                    method: 'POST',
                    body: formData,
                    headers: { 'X-CSRFToken': csrfToken }
                });

                const data = await response.json();

                if (response.ok) { 
                    mensajeDiv.className = 'exito';
                    mensajeDiv.innerHTML = `<strong>¡Solicitud enviada con éxito!</strong> El proceso ha iniciado. Tu <strong>ID de seguimiento de caso es: ${data.solicitud_id}</strong>.`;
                    mensajeDiv.style.display = 'block';
                    form.reset(); 
                    droppedFiles = [];
                    updateFileList();

                    // Resetear calendario
                    fechaHiddenInput.value = '';
                    horaCitaInput.value = '';
                    diaSeleccionado = null;
                    diaSeleccionadoStr = null;
                    citasDiaTitulo.innerText = `Horarios Disponibles`;
                    citasDiaContainer.innerHTML = `
                        <div class="empty-state empty-state-10">
                            <i class="fas fa-calendar-day" style="font-size: 2rem; margin-bottom: 10px;"></i>
                            <p style="font-size: 0.9rem;">Seleccione un día del calendario para ver los horarios disponibles.</p>
                        </div>
                    `;
                    horariosBotones.style.display = 'none';
                    // Recargar el mes actual
                    navDate = new Date();
                    fetchCalendarioDelMes(navDate.getFullYear(), navDate.getMonth());

                } else {
                    // Error de validación (HTTP 400)
                    mensajeDiv.className = 'error';
                    let errores = "<strong>Error de Validación:</strong><ul>";

                    // Manejo del error de "hora tomada" (race condition)
                    if (data.non_field_errors) {
                         errores += `<li><strong>HORA:</strong> ${data.non_field_errors[0]}</li>`;
                         // Refrescar el mes, porque la data está desactualizada
                         fetchCalendarioDelMes(navDate.getFullYear(), navDate.getMonth());
                         horaCitaInput.value = '';
                    }

                    for (const [campo, mensajes] of Object.entries(data)) {
                        if (campo !== 'non_field_errors') {
                           errores += `<li><strong>${campo.toUpperCase()}:</strong> ${mensajes[0]}</li>`;
                        }
                    }
                    errores += "</ul>";
                    mensajeDiv.innerHTML = errores;
                    mensajeDiv.style.display = 'block';
                }

            } catch (error) {
                mensajeDiv.className = 'error';
                mensajeDiv.innerText = 'Error de conexión con el servidor. Inténtalo de nuevo.';
                mensajeDiv.style.display = 'block';
                console.error('Error:', error);
            }

            submitButton.disabled = false;
            submitButton.innerText = "Enviar Solicitud y Agendar";
        });
    </script>
{% endblock %}