{% extends "plantilla.html" %}
{% load static %}

{% block title %}
    Gestión de Casos | SIAPE
{% endblock %}

{% block extra_head %}
    <link rel="stylesheet" href="{% static 'CSS/dashboard.css' %}">
{% endblock %}

{% block content %}
<div class="main-content"> 
    
    <nav class="dashboard-nav">
        {% if user.perfil.rol.nombre_rol == "Encargado de Inclusión" %}
            <a href="{% url 'dashboard_encargado_inclusion' %}" class="nav-item">
                <i class="fas fa-home"></i> Panel Principal
            </a>
            <a href="{% url 'casos_generales' %}" class="nav-item active"> 
                <i class="fas fa-folder-open"></i> Casos
            </a>
            <a href="{% url 'panel_control_encargado_inclusion' %}" class="nav-item">
                <i class="fas fa-calendar-alt"></i> Gestión de Citas
            </a>
            <a href="{% url 'gestionar_horarios_bloqueados' %}" class="nav-item">
                <i class="fas fa-ban"></i> Horarios Bloqueados
            </a>
        {% elif user.perfil.rol.nombre_rol == "Coordinador Técnico Pedagógico" %}
            <a href="{% url 'dashboard_coordinador_tecnico_pedagogico' %}" class="nav-item">
                <i class="fas fa-home"></i> Panel Principal
            </a>
            <a href="{% url 'casos_generales' %}" class="nav-item active"> 
                <i class="fas fa-folder-open"></i> Casos
            </a>
        {% elif user.perfil.rol.nombre_rol == "Asesora Pedagógica" %}
            <a href="{% url 'dashboard_asesor' %}" class="nav-item">
                <i class="fas fa-home"></i> Panel Principal
            </a>
            <a href="{% url 'casos_generales' %}" class="nav-item active"> 
                <i class="fas fa-folder-open"></i> Casos
            </a>
        {% elif user.perfil.rol.nombre_rol == "Director de Carrera" %}
            <a href="{% url 'dashboard_director' %}" class="nav-item">
                <i class="fas fa-user-tie"></i> Panel Principal
            </a>
            <a href="{% url 'casos_generales' %}" class="nav-item active"> 
                <i class="fas fa-folder-open"></i> Casos
            </a>
            <a href="{% url 'estadisticas_director' %}" class="nav-item">
                <i class="fas fa-chart-bar"></i> Estadísticas
            </a>
            <a href="{% url 'carreras_director' %}" class="nav-item">
                <i class="fas fa-graduation-cap"></i> Mis Carreras
            </a>
            <a href="{% url 'gestion_carga_masiva_director' %}" class="nav-item">
                <i class="fas fa-file-upload"></i> Carga Masiva
            </a>
        {% else %}
            <a href="{% url 'home' %}" class="nav-item">
                <i class="fas fa-home"></i> Panel Principal
            </a>
            <a href="{% url 'casos_generales' %}" class="nav-item active"> 
                <i class="fas fa-folder-open"></i> Casos
            </a>
        {% endif %}
    </nav>

    <section class="table-container p-20">
        <form method="GET" action="{% url 'casos_generales' %}">
            {% if mostrando_todos %}
                <input type="hidden" name="todos" value="1">
            {% endif %}
            
            <div class="filter-bar">
                <div class="form-group main-search-group">
                    <label for="q_nombre">Buscar por Estudiante (Nombre, Apellido o RUT):</label>
                    <input type="text" id="q_nombre" name="q_nombre" value="{{ filtros_aplicados.q_nombre }}" placeholder="Escribe un nombre, apellido o RUT...">
                </div>
                
                <button type="button" class="btn-accion btn-accion-gray btn-filter-toggle" id="toggle-filters-btn">
                    <i class="fas fa-filter"></i> Filtros
                </button>
                
                <button type="submit" class="btn-accion btn-agendar">
                    <i class="fas fa-search"></i> Buscar
                </button>
            </div>
            
            {% if not mostrando_todos and rol_usuario != "Administrador" %}
                <div class="alert alert-info" style="background-color: #e7f3ff; border-left: 4px solid #2196F3; padding: 12px 15px; margin-top: 15px; border-radius: 4px;">
                    <i class="fas fa-info-circle"></i> 
                    <strong>Filtro activo por rol:</strong> 
                    {% if rol_usuario == "Encargado de Inclusión" %}
                        Mostrando casos en estado "Pendiente de Entrevista" y "Pendiente de Formulación de Caso".
                    {% elif rol_usuario == "Coordinador Técnico Pedagógico" %}
                        Mostrando casos en estado "Pendiente de Formulación de Ajustes".
                    {% elif rol_usuario == "Asesora Pedagógica" %}
                        Mostrando casos en estado "Pendiente de Preaprobación".
                    {% elif rol_usuario == "Director de Carrera" %}
                        Mostrando casos en estado "Pendiente de Aprobación".
                    {% endif %}
                    <a href="{% url 'casos_generales' %}?todos=1" style="color: #cc0000; font-weight: bold; margin-left: 10px;">
                        <i class="fas fa-eye"></i> Ver Todos los Casos
                    </a>
                </div>
            {% elif mostrando_todos %}
                <div class="alert alert-warning" style="background-color: #fff3cd; border-left: 4px solid #ffc107; padding: 12px 15px; margin-top: 15px; border-radius: 4px;">
                    <i class="fas fa-eye"></i> 
                    <strong>Vista general:</strong> Mostrando todos los casos sin filtro por rol.
                    <a href="{% url 'casos_generales' %}" style="color: #cc0000; font-weight: bold; margin-left: 10px;">
                        <i class="fas fa-filter"></i> Ver Mis Casos
                    </a>
                </div>
            {% endif %}

            <div class="collapsible-filters" id="collapsible-filters-content">
                <div class="form-grid mb-0 padding-bottom-0">
                    <div class="form-group">
                        <label for="q_estado">Estado del Caso:</label>
                        <select id="q_estado" name="q_estado">
                            <option value="">-- Todos los estados --</option>
                            {% for estado_valor, estado_nombre in estados_disponibles %}
                            <option value="{{ estado_valor }}" {% if filtros_aplicados.q_estado == estado_valor %}selected{% endif %}>
                                {{ estado_nombre }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="q_fecha">Fecha de Solicitud:</label>
                        <input type="date" id="q_fecha" name="q_fecha" value="{{ filtros_aplicados.q_fecha }}">
                    </div>
            
                    <div class="form-group">
                        <label for="q_ajuste">Tipo de Ajuste Aplicado:</label>
                        <select id="q_ajuste" name="q_ajuste">
                            <option value="">-- Todos los tipos --</option>
                            {% for cat in categorias_ajustes %}
                            <option value="{{ cat.id }}" {% if filtros_aplicados.q_ajuste == cat.id|stringformat:"s" %}selected{% endif %}>
                                {{ cat.nombre_categoria }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="form-actions mt-15 border-top-light flex-start padding-top-15">
                    {% if not mostrando_todos and rol_usuario != "Administrador" %}
                        <a href="{% url 'casos_generales' %}?todos=1" class="btn-accion btn-accion-gray" style="background-color: #f0f0f0; border: 2px solid #2196F3; color: #2196F3; font-weight: bold;">
                            <i class="fas fa-list"></i> Ver Todos los Casos (Sin Filtro por Rol)
                        </a>
                    {% elif mostrando_todos %}
                        <a href="{% url 'casos_generales' %}" class="btn-accion btn-accion-gray" style="background-color: #f0f0f0; border: 2px solid #cc0000; color: #cc0000; font-weight: bold;">
                            <i class="fas fa-filter"></i> Aplicar Filtro por Rol
                        </a>
                    {% endif %}
                    <a href="{% url 'casos_generales' %}" class="btn-accion btn-accion-gray">Limpiar Filtros</a>
                </div>
            </div>
        </form>
    </section>
    <section class="table-container mt-20">
        <div class="table-header">
            <h2>
                Casos Encontrados
                {% if not mostrando_todos and rol_usuario != "Administrador" %}
                    <span style="font-size: 0.7em; color: #666; font-weight: normal;">
                        (Filtrado por rol: {{ rol_usuario }})
                    </span>
                {% elif mostrando_todos %}
                    <span style="font-size: 0.7em; color: #666; font-weight: normal;">
                        (Todos los casos - Sin filtro por rol)
                    </span>
                {% endif %}
            </h2>
            <p style="margin-top: 10px; font-size: 0.9em; color: #666;">
                Total: <strong>{{ total_casos }}</strong> caso{{ total_casos|pluralize }}
                {% if not mostrando_todos and rol_usuario != "Administrador" %}
                    <span style="color: #2196F3;">| Filtro activo por rol</span>
                {% endif %}
            </p>
        </div>
        
        <table class="custom-table">
            <thead>
                <tr>
                    <th>Nombre Estudiante</th>
                    <th>RUT</th>
                    <th>Fecha Solicitud</th>
                    <th>Estado</th>
                    <th>Acción</th>
                </tr>
            </thead>
            <tbody>
                {% for solicitud in solicitudes %}
                <tr>
                    <td>{{ solicitud.estudiantes.nombres }} {{ solicitud.estudiantes.apellidos }}</td>
                    <td>{{ solicitud.estudiantes.rut }}</td>
                    <td>{{ solicitud.created_at|date:"d/m/Y" }}</td>
                    <td>
                        {% if solicitud.estado == 'aprobado' %}
                            <span class="status status-aprobado">{{ solicitud.get_estado_display }}</span>
                        {% elif solicitud.estado == 'rechazado' %}
                            <span class="status status-rechazado">{{ solicitud.get_estado_display }}</span>
                        {% else %}
                            <span class="status status-en_proceso">{{ solicitud.get_estado_display }}</span>
{% endif %}
                    </td>
                    <td>
                        {% if user.perfil.rol.nombre_rol == "Coordinador Técnico Pedagógico" %}
                            <a href="{% url 'detalle_caso' solicitud.id %}" class="link-rojo">Ver más »</a>
                        {% elif user.perfil.rol.nombre_rol == "Encargado de Inclusión" %}
                            <a href="{% url 'detalle_caso' solicitud.id %}" class="link-rojo">Ver más »</a>
                        {% else %}
                            <a href="{% url 'detalle_caso' solicitud.id %}" class="link-rojo">Ver más »</a>
                        {% endif %}
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5">
                        <div class="empty-state p-20">
                            <i class="fas fa-search text-muted icon-medium"></i>
                            {% if rol_usuario == "Coordinador Técnico Pedagógico" and not mostrando_todos %}
                                <p class="text-muted">No hay casos pendientes de formulación en este momento.</p>
                                <p class="text-muted" style="margin-top: 10px;">
                                    <a href="{% url 'casos_generales' %}?todos=1" style="color: #cc0000;">Ver todos los casos</a>
                                </p>
                            {% elif rol_usuario == "Encargado de Inclusión" and not mostrando_todos %}
                                <p class="text-muted">No hay casos pendientes de entrevista o asignados a ti.</p>
                                <p class="text-muted" style="margin-top: 10px;">
                                    <a href="{% url 'casos_generales' %}?todos=1" style="color: #cc0000;">Ver todos los casos</a>
                                </p>
                            {% else %}
                                <p class="text-muted">No se encontraron solicitudes con esos filtros.</p>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <div class="table-footer">
            <span>Mostrando {{ total_casos|default:0 }} de {{ total_casos|default:0 }} entradas</span>
        </div>
    </section>

</div>

<script>
    // Script para manejar el botón de colapsar filtros
    document.addEventListener('DOMContentLoaded', function() {
        const toggleBtn = document.getElementById('toggle-filters-btn');
        const filtersContent = document.getElementById('collapsible-filters-content');

        if (toggleBtn && filtersContent) {
            toggleBtn.addEventListener('click', function() {
                filtersContent.classList.toggle('show');
            });
        }
    });
</script>

{% endblock %}