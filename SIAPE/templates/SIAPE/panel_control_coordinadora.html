{% extends "plantilla.html" %}
{% load static %}

{% block title %}
    Panel de Control - Coordinadora | SIAPE
{% endblock %}

{% block extra_head %}
    <link rel="stylesheet" href="{% static 'CSS/dashboard.css' %}">
{% endblock %}

{% block content %}
<div class="main-content"> 
    
    <nav class="dashboard-nav">
        <a href="{% url 'dashboard_coordinadora' %}" class="nav-item">
            <i class="fas fa-home"></i>
            Panel Principal
        </a>
        <a href="{% url 'casos_generales' %}" class="nav-item">
            <i class="fas fa-folder-open"></i>
            Casos
        </a>
        <a href="{% url 'panel_control_coordinadora' %}" class="nav-item active">
            <i class="fas fa-tachometer-alt"></i>
            Panel de Control
        </a>
    </nav>

    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} custom-alert-{{ message.tags }}">
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}

    <div class="panel-control-container casos-dos-columnas">
        
        <div class="panel-col-stack">
            
            <div class="panel-section">
                <h3><i class="fas fa-calendar-day"></i> Citas del Día</h3>
                {% if citas_hoy_list %}
                    {% for cita in citas_hoy_list %}
                        <div class="cal-cita-item estado-{{ cita.estado }}">
                            <span class="cal-cita-hora"><i class="fas fa-clock"></i> {{ cita.fecha_entrevista|date:"H:i" }} hrs</span>
                            <strong class="cal-cita-estudiante">{{ cita.solicitudes.estudiantes.nombres }} {{ cita.solicitudes.estudiantes.apellidos }}</strong>
                            <span class="cal-cita-asunto">{{ cita.solicitudes.asunto }}</span>
                            <span class="cal-cita-estado">Estado: {{ cita.get_estado_display }}</span>
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="empty-state p-10">
                        <i class="fas fa-check-circle text-muted"></i>
                        <p class="text-small">No hay citas programadas para hoy.</p>
                    </div>
                {% endif %}
            </div>

            <div class="panel-section">
                <h3><i class="fas fa-calendar-week"></i> Próximas Citas de la Semana</h3>
                {% if citas_semana_list %}
                    {% for cita in citas_semana_list %}
                        <div class="cal-cita-item estado-{{ cita.estado }}">
                            <span class="cal-cita-hora"><i class="fas fa-calendar-alt"></i> {{ cita.fecha_entrevista|date:"d/m/Y H:i" }} hrs</span>
                            <strong class="cal-cita-estudiante">{{ cita.solicitudes.estudiantes.nombres }} {{ cita.solicitudes.estudiantes.apellidos }}</strong>
                            <span class="cal-cita-asunto">{{ cita.solicitudes.asunto }}</span>
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="empty-state p-10">
                        <i class="fas fa-check-circle text-muted"></i>
                        <p class="text-small">No hay más citas programadas para esta semana.</p>
                    </div>
                {% endif %}
            </div>

        </div> <div class="panel-section">
            <h3><i class="fas fa-calendar-alt"></i> Calendario de Citas</h3>
            
            <div class="cal-layout-container grid-single-column">
                
                <div class="cal-widget">
                    <div class="detalle-card" id="card-calendario-panel">
                        <div class="calendario-header" id="cal-header"></div>
                        <div class="cal-nav">
                            <button id="cal-prev" class="btn-accion btn-accion-gray btn-accion-small"><i class="fas fa-chevron-left"></i> Ant</button>
                            <button id="cal-today" class="btn-accion btn-accion-gray btn-accion-small">Hoy</button>
                            <button id="cal-next" class="btn-accion btn-accion-gray btn-accion-small">Sig <i class="fas fa-chevron-right"></i></button>
                        </div>
                        <div class="calendario-grid" id="cal-grid-body"></div>
                        <div class="calendario-leyenda calendario-leyenda-mt">
                            <div><span class="dot dot-entrevista"></span> Día con Cita(s)</div>
                        </div>
                    </div>
                </div>

                <div class="cal-citas-list">
                    <h4 id="cal-citas-titulo">Citas del Día</h4>
                    <div id="cal-citas-dia">
                        <div class="empty-state empty-state-10">
                            <i class="fas fa-calendar-day empty-state-icon"></i>
                            <p class="empty-state-text">Seleccione un día del calendario para ver las citas programadas.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div> </div> {% if citas_pendientes_confirmar %}
    <div class="panel-section citas-detalle">
        <h3><i class="fas fa-exclamation-circle icon-warning"></i> Citas Pendientes de Confirmar Asistencia</h3>
        <div class="cita-detalle-item cita-detalle-header">
            <div>Estudiante / Caso</div>
            <div>Fecha y Hora de Cita</div>
            <div>Modalidad</div>
            <div>Estado</div>
            <div>Acciones</div>
        </div>
        {% for cita in citas_pendientes_confirmar %}
            <div class="cita-detalle-item cita-detalle-item-5cols">
                <div>
                    <div class="cita-estudiante">{{ cita.solicitudes.estudiantes.nombres }} {{ cita.solicitudes.estudiantes.apellidos }}</div>
                    <div class="caso-asunto caso-asunto-small">{{ cita.solicitudes.asunto }}</div>
                </div>
                <div class="cita-fecha-hora cita-fecha-hora-pendiente">
                    <i class="fas fa-clock"></i> {{ cita.fecha_entrevista|date:"d/m/Y H:i" }}
                </div>
                <div>
                    <span class="cita-modalidad">{{ cita.modalidad }}</span>
                </div>
                <div>
                    <span class="status status-en_proceso">{{ cita.get_estado_display }}</span>
                </div>
                <div class="acciones-container">
                    <button type="button" class="btn-accion btn-asignar btn-accion-small" onclick="abrirModalConfirmar({{ cita.id }}, 'realizada', '{{ cita.solicitudes.asunto }}')">
                        <i class="fas fa-check"></i> Realizada
                    </button>
                    <button type="button" class="btn-accion btn-accion-red btn-accion-small" onclick="abrirModalConfirmar({{ cita.id }}, 'no_asistio', '{{ cita.solicitudes.asunto }}')">
                        <i class="fas fa-times"></i> No asistió
                    </button>
                </div>
            </div>
        {% endfor %}
    </div>
    {% endif %}

    <div class="panel-section citas-detalle">
        <h3><i class="fas fa-history"></i> Historial de Citas (Semana Actual)</h3>
        {% if citas_pasadas_semana_list %}
            <div class="cita-detalle-item cita-detalle-header">
                <div>Estudiante / Caso</div>
                <div>Fecha y Hora</div>
                <div>Modalidad</div>
                <div>Estado</div>
                <div>Acciones</div>
            </div>
            {% for cita in citas_pasadas_semana_list %}
                <div class="cita-detalle-item cita-detalle-item-5cols">
                    <div>
                        <div class="cita-estudiante">{{ cita.solicitudes.estudiantes.nombres }} {{ cita.solicitudes.estudiantes.apellidos }}</div>
                        <div class="caso-asunto caso-asunto-small">{{ cita.solicitudes.asunto }}</div>
                    </div>
                    <div class="cita-fecha-hora {% if cita.estado == 'no_asistio' %}cita-fecha-hora-no-asistio{% endif %}">
                        <i class="fas fa-clock"></i> {{ cita.fecha_entrevista|date:"d/m/Y H:i" }}
                    </div>
                    <div>
                        <span class="cita-modalidad">{{ cita.modalidad }}</span>
                    </div>
                    <div>
                        {% if cita.estado == 'realizada' %}
                        <span class="status status-aprobado">{{ cita.get_estado_display }}</span>
                        {% else %}
                        <span class="status status-rechazado">{{ cita.get_estado_display }}</span>
                        {% endif %}
                    </div>
                    <div class="acciones-container">
                        {% if cita.estado == 'no_asistio' %}
                            <button type="button" class="btn-accion btn-agendar btn-accion-small" onclick="abrirModalReagendar({{ cita.id }}, '{{ cita.solicitudes.asunto }}', '{{ cita.modalidad }}')">
                                <i class="fas fa-redo"></i> Reagendar
                            </button>
                        {% endif %}
                        <button type="button" class="btn-accion btn-accion-gray btn-accion-small" onclick="abrirModalEditarNotas({{ cita.id }}, '{{ cita.notas|escapejs }}', '{{ cita.solicitudes.asunto }}')">
                            <i class="fas fa-edit"></i> Ver/Editar Notas
                        </button>
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <div class="empty-state">
                <i class="fas fa-calendar-times"></i>
                <p>No hay historial de citas (realizadas o no asistidas) esta semana.</p>
            </div>
        {% endif %}
    </div>

    <div id="modalConfirmar" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h4><i class="fas fa-check-circle"></i> Confirmar Cita</h4>
                <button class="close" onclick="cerrarModalConfirmar()">&times;</button>
            </div>
            <form method="post" action="" id="formConfirmar">
                {% csrf_token %}
                <input type="hidden" name="accion" id="confirmar_accion">
                
                <div class="form-group">
                    <label>Caso:</label>
                    <input type="text" id="confirmar_caso_asunto" class="input-readonly" readonly>
                </div>
                
                <div class="form-group">
                    <label for="notas_adicionales">Notas Adicionales (opcional):</label>
                    <textarea name="notas_adicionales" id="notas_adicionales" placeholder="Agregar notas sobre la confirmación de la cita..."></textarea>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn-accion btn-accion-gray" onclick="cerrarModalConfirmar()">Cancelar</button>
                    <button type="submit" class="btn-accion btn-accion-green" id="btnConfirmarSubmit">
                        <i class="fas fa-check"></i> Confirmar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="modalEditarNotas" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h4><i class="fas fa-edit"></i> Editar Notas de la Cita</h4>
                <button class="close" onclick="cerrarModalEditarNotas()">&times;</button>
            </div>
            <form method="post" action="" id="formEditarNotas">
                {% csrf_token %}
                
                <div class="form-group">
                    <label>Caso:</label>
                    <input type="text" id="editar_notas_caso_asunto" class="input-readonly" readonly>
                </div>
                
                <div class="form-group">
                    <label for="notas">Notas:</label>
                    <textarea name="notas" id="editar_notas_textarea" required placeholder="Agregar o editar las notas de la cita..."></textarea>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn-accion btn-accion-gray" onclick="cerrarModalEditarNotas()">Cancelar</button>
                    <button type="submit" class="btn-accion btn-accion-gray">
                        <i class="fas fa-save"></i> Guardar Notas
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="modalReagendar" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h4><i class="fas fa-redo"></i> Reagendar Cita</h4>
                <button class="close" onclick="cerrarModalReagendar()">&times;</button>
            </div>
            <form method="post" action="" id="formReagendar">
                {% csrf_token %}
                
                <div class="form-group">
                    <label>Caso:</label>
                    <input type="text" id="reagendar_caso_asunto" class="input-readonly" readonly>
                </div>
                
                <div class="form-group">
                    <label for="nueva_fecha_entrevista">Nueva Fecha y Hora:</label>
                    <input type="datetime-local" name="nueva_fecha_entrevista" id="nueva_fecha_entrevista" required>
                </div>
                
                <div class="form-group">
                    <label for="nueva_modalidad">Modalidad:</label>
                    <select name="nueva_modalidad" id="nueva_modalidad">
                        <option value="">Seleccione una modalidad</option>
                        <option value="Presencial">Presencial</option>
                        <option value="Virtual">Virtual</option>
                        <option value="Híbrida">Híbrida</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="notas_reagendamiento">Notas (opcional):</label>
                    <textarea name="notas_reagendamiento" id="notas_reagendamiento" placeholder="Agregar notas sobre el reagendamiento..."></textarea>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn-accion btn-accion-gray" onclick="cerrarModalReagendar()">Cancelar</button>
                    <button type="submit" class="btn-accion btn-agendar">
                        <i class="fas fa-save"></i> Reagendar
                    </button>
                </div>
            </form>
        </div>
    </div>

</div>

<script>
    // --- Funciones de Modales (Limpiadas) ---
    
    function abrirModalConfirmar(entrevistaId, accion, asunto) {
        document.getElementById('confirmar_accion').value = accion;
        document.getElementById('confirmar_caso_asunto').value = asunto;
        // ***** URL ACTUALIZADA *****
        document.getElementById('formConfirmar').action = '{% url "coordinadora_confirmar_cita" 0 %}'.replace('0', entrevistaId);
        
        const btnSubmit = document.getElementById('btnConfirmarSubmit');
        if (accion === 'realizada') {
            btnSubmit.innerHTML = '<i class="fas fa-check"></i> Marcar como Realizada';
            btnSubmit.className = 'btn-accion btn-accion-green';
        } else {
            btnSubmit.innerHTML = '<i class="fas fa-times"></i> Marcar como No Asistió';
            btnSubmit.className = 'btn-accion btn-accion-red';
        }
        
        document.getElementById('modalConfirmar').style.display = 'block';
    }

    function cerrarModalConfirmar() {
        document.getElementById('modalConfirmar').style.display = 'none';
        document.getElementById('notas_adicionales').value = '';
    }

    function abrirModalEditarNotas(entrevistaId, notas, asunto) {
        document.getElementById('editar_notas_caso_asunto').value = asunto;
        document.getElementById('editar_notas_textarea').value = notas.replace(/\\n/g, '\n');
        // ***** URL ACTUALIZADA *****
        document.getElementById('formEditarNotas').action = '{% url "coordinadora_editar_notas_cita" 0 %}'.replace('0', entrevistaId);
        document.getElementById('modalEditarNotas').style.display = 'block';
    }

    function cerrarModalEditarNotas() {
        document.getElementById('modalEditarNotas').style.display = 'none';
    }

    function abrirModalReagendar(entrevistaId, asunto, modalidad) {
        document.getElementById('reagendar_caso_asunto').value = asunto;
        document.getElementById('nueva_modalidad').value = modalidad;
        // ***** URL ACTUALIZADA *****
        document.getElementById('formReagendar').action = '{% url "coordinadora_reagendar_cita" 0 %}'.replace('0', entrevistaId);
        document.getElementById('modalReagendar').style.display = 'block';
    }

    function cerrarModalReagendar() {
        document.getElementById('modalReagendar').style.display = 'none';
        document.getElementById('nueva_fecha_entrevista').value = '';
        document.getElementById('notas_reagendamiento').value = '';
    }

    // Cerrar modales al hacer clic fuera de ellos
    window.onclick = function(event) {
        const modalConfirmar = document.getElementById('modalConfirmar');
        const modalEditarNotas = document.getElementById('modalEditarNotas');
        const modalReagendar = document.getElementById('modalReagendar');
        
        if (event.target == modalConfirmar) { cerrarModalConfirmar(); }
        if (event.target == modalEditarNotas) { cerrarModalEditarNotas(); }
        if (event.target == modalReagendar) { cerrarModalReagendar(); }
    }

    // --- CÓDIGO DEL CALENDARIO (Sin cambios) ---
    document.addEventListener('DOMContentLoaded', function() {
        const fechasConCitas = JSON.parse('{{ fechas_citas_json|escapejs }}' || "[]");
        const todasLasCitas = JSON.parse('{{ citas_data_json|escapejs }}' || "[]");

        let navDate = new Date();
        const hoy = new Date();
        const hoyStr = `${hoy.getFullYear()}-${String(hoy.getMonth() + 1).padStart(2, '0')}-${String(hoy.getDate()).padStart(2, '0')}`;
        let diaSeleccionado = null; 
        let diaSeleccionadoStr = null;

        const calHeader = document.getElementById('cal-header');
        const calGridBody = document.getElementById('cal-grid-body');
        const btnPrev = document.getElementById('cal-prev');
        const btnNext = document.getElementById('cal-next');
        const btnToday = document.getElementById('cal-today');
        const citasDiaContainer = document.getElementById('cal-citas-dia');
        const citasDiaTitulo = document.getElementById('cal-citas-titulo');

        const meses = [
            "Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio",
            "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"
        ];
        
        const citasPorFecha = {};
        for (const cita of todasLasCitas) {
            if (!citasPorFecha[cita.fecha]) {
                citasPorFecha[cita.fecha] = [];
            }
            citasPorFecha[cita.fecha].push(cita);
        }

        function mostrarCitasDelDia(fechaStr, diaEl) {
            const [year, month, day] = fechaStr.split('-');
            citasDiaTitulo.innerText = `Citas para ${day}/${month}/${year}`;

            if (diaSeleccionado) {
                diaSeleccionado.classList.remove('cal-day-selected');
            }
            
            if(diaEl) {
                diaEl.classList.add('cal-day-selected');
                diaSeleccionado = diaEl;
                diaSeleccionadoStr = fechaStr;
            } else {
                diaSeleccionado = calGridBody.querySelector(`[data-fecha="${fechaStr}"]`);
                if (diaSeleccionado) {
                    diaSeleccionado.classList.add('cal-day-selected');
                }
            }

            const citas = citasPorFecha[fechaStr] || [];
            
            if (citas.length === 0) {
                citasDiaContainer.innerHTML = `
                    <div class="empty-state p-10">
                        <i class="fas fa-calendar-check empty-state-icon"></i>
                        <p class="empty-state-text">No hay citas programadas para este día.</p>
                    </div>
                `;
                return;
            }

            let html = '';
            for (const cita of citas) {
                html += `
                    <div class="cal-cita-item estado-${cita.estado_key}">
                        <span class="cal-cita-hora"><i class="fas fa-clock"></i> ${cita.hora}</span>
                        <strong class="cal-cita-estudiante">${cita.estudiante}</strong>
                        <span class="cal-cita-asunto">${cita.asunto}</span>
                        <span class="cal-cita-estado">Estado: ${cita.estado}</span>
                    </div>
                `;
            }
            citasDiaContainer.innerHTML = html;
        }

        function renderCalendar() {
            const year = navDate.getFullYear();
            const month = navDate.getMonth();
            calHeader.innerText = `${meses[month]} ${year}`;
            
            calGridBody.innerHTML = `
                <div class="cal-day-header">L</div>
                <div class="cal-day-header">M</div>
                <div class="cal-day-header">X</div>
                <div class="cal-day-header">J</div>
                <div class="cal-day-header">V</div>
                <div class="cal-day-header">S</div>
                <div class="cal-day-header">D</div>
            `;
            
            const primerDiaDelMes = new Date(year, month, 1);
            const ultimoDiaDelMes = new Date(year, month + 1, 0);
            const ultimoDiaNum = ultimoDiaDelMes.getDate();
            let diaInicioSemana = (primerDiaDelMes.getDay() + 6) % 7;
            const ultimoDiaMesAnterior = new Date(year, month, 0).getDate();

            for (let i = diaInicioSemana; i > 0; i--) {
                const dia = ultimoDiaMesAnterior - i + 1;
                const dayDiv = document.createElement('div');
                dayDiv.classList.add('cal-day', 'other-month');
                dayDiv.innerText = dia;
                calGridBody.appendChild(dayDiv);
            }

            for (let dia = 1; dia <= ultimoDiaNum; dia++) {
                const dayDiv = document.createElement('div');
                dayDiv.classList.add('cal-day');
                dayDiv.innerText = dia;

                const fechaStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(dia).padStart(2, '0')}`;
                dayDiv.dataset.fecha = fechaStr;

                if (fechaStr === hoyStr) {
                    dayDiv.classList.add('day-today');
                }

                if (fechasConCitas.includes(fechaStr)) {
                    dayDiv.classList.add('day-entrevista');
                }
                
                dayDiv.addEventListener('click', () => mostrarCitasDelDia(fechaStr, dayDiv));
                calGridBody.appendChild(dayDiv);
            }

            const totalDiasGrid = calGridBody.children.length;
            const diasSiguientes = (7 - (totalDiasGrid % 7)) % 7;
            for (let i = 1; i <= diasSiguientes; i++) {
                const dayDiv = document.createElement('div');
                dayDiv.classList.add('cal-day', 'other-month');
                dayDiv.innerText = i;
                calGridBody.appendChild(dayDiv);
            }
            
            if (diaSeleccionadoStr) {
                const [selYear, selMonth] = diaSeleccionadoStr.split('-');
                if (parseInt(selYear) === year && parseInt(selMonth) === (month + 1)) {
                    mostrarCitasDelDia(diaSeleccionadoStr, null);
                } else {
                    diaSeleccionado = null;
                    diaSeleccionadoStr = null;
                    citasDiaTitulo.innerText = `Citas del Día`;
                    citasDiaContainer.innerHTML = `
                        <div class="empty-state p-10">
                            <i class="fas fa-calendar-day empty-state-icon"></i>
                            <p class="empty-state-text">Seleccione un día del calendario para ver las citas programadas.</p>
                        </div>
                    `;
                }
            }
        }

        btnPrev.addEventListener('click', () => {
            navDate.setMonth(navDate.getMonth() - 1);
            renderCalendar();
        });

        btnNext.addEventListener('click', () => {
            navDate.setMonth(navDate.getMonth() + 1);
            renderCalendar();
        });

        btnToday.addEventListener('click', () => {
            navDate = new Date();
            renderCalendar();
        });

        renderCalendar();
    });
</script>
{% endblock %}