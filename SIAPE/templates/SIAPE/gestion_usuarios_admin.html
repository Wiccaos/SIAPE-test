{% extends "plantilla.html" %}
{% load static %}

{% block title %}
    Gestión de Usuarios y Roles | SIAPE
{% endblock %}

{% block extra_head %}
    <link rel="stylesheet" href="{% static 'CSS/dashboard.css' %}">
    <script src="{% static 'JS/rut_validator.js' %}"></script>
    <script src="{% static 'JS/password_validator.js' %}"></script>
    <script src="{% static 'JS/gestion_usuarios_admin.js' %}"></script>
{% endblock %}

{% block content %}
<div class="main-content"> 
    
    <nav class="dashboard-nav">
        <a href="{% url 'dashboard_admin' %}" class="nav-item">
            <i class="fas fa-shield-alt"></i>
            Panel Principal
        </a>
        <a href="{% url 'gestion_usuarios_admin' %}" class="nav-item active">
            <i class="fas fa-users-cog"></i>
            Gestión de Usuarios
        </a>
        <a href="{% url 'gestion_institucional_admin' %}" class="nav-item">
            <i class="fas fa-landmark"></i>
            Gestión Institucional
        </a>
    </nav>

    <!-- ======================= INICIO MODIFICACIÓN ======================= -->
    <!-- Contenedor cambiado a 'display: block' para apilar las tablas -->
    <div class="panel-control-container">

        <!-- Tabla de Usuarios (Arriba) -->
        <!-- Se añade 'margin-bottom: 30px' para separar de la siguiente tabla -->
        <section class="table-container" id="seccion-usuarios">
            {% csrf_token %}
            <div class="table-header">
                <h2 class="titulo-usuarios"><i class="fas fa-users-cog"></i> Listado de Usuarios</h2>
                <button type="button" class="btn-accion btn-asignar" onclick="abrirModalAgregar()">
                    <i class="fas fa-user-plus"></i> Agregar Usuario
                </button>
            </div>
            
            <!-- Barra de búsqueda y filtros -->
            <div class="search-filters-container">
                <form method="get" action="{% url 'gestion_usuarios_admin' %}" id="formBusqueda">
                    <div class="search-filters-grid">
                        <!-- Campo de búsqueda -->
                        <div class="form-group search-filter-group">
                            <label for="q" class="search-filter-label">
                                <i class="fas fa-search"></i> Buscar:
                            </label>
                            <input 
                                type="text" 
                                name="q" 
                                id="q" 
                                class="search-filter-input"
                                value="{{ filtros_aplicados.q }}"
                                placeholder="Nombre, Email o RUT..."
                                maxlength="100"
                            >
                        </div>
                        
                        <!-- Filtro por Rol -->
                        <div class="form-group search-filter-group">
                            <label for="rol" class="search-filter-label">
                                <i class="fas fa-user-tag"></i> Rol:
                            </label>
                            <select 
                                name="rol" 
                                id="rol" 
                                class="search-filter-select"
                            >
                                <option value="">Todos los roles</option>
                                {% for rol in roles_disponibles %}
                                    <option value="{{ rol.id }}" {% if filtros_aplicados.rol == rol.id|stringformat:"s" %}selected{% endif %}>
                                        {{ rol.nombre_rol }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <!-- Filtro por Área -->
                        <div class="form-group search-filter-group">
                            <label for="area" class="search-filter-label">
                                <i class="fas fa-building"></i> Área:
                            </label>
                            <select 
                                name="area" 
                                id="area" 
                                class="search-filter-select"
                            >
                                <option value="">Todas las áreas</option>
                                {% for area in areas_disponibles %}
                                    <option value="{{ area.id }}" {% if filtros_aplicados.area == area.id|stringformat:"s" %}selected{% endif %}>
                                        {{ area.nombre }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <!-- Botones de acción -->
                        <div class="search-filter-buttons">
                            <button type="submit" class="btn-accion btn-asignar search-filter-btn">
                                <i class="fas fa-search"></i> Buscar
                            </button>
                            {% if filtros_aplicados.q or filtros_aplicados.rol or filtros_aplicados.area %}
                                <a href="{% url 'gestion_usuarios_admin' %}" class="btn-accion btn-accion-gray search-filter-btn">
                                    <i class="fas fa-times"></i> Limpiar
                                </a>
                            {% endif %}
                        </div>
                    </div>
                </form>
            </div>
            
            <table class="custom-table table-users">
                <thead>
                    <tr>
                        <th>Nombre</th>
                        <th>Email</th>
                        <th>RUT</th>
                        <th>Rol Actual</th>
                        <th>Área</th>
                        <th>Estado</th>
                        <th>Acción</th>
                    </tr>
                </thead>
                <tbody>
                    {% for perfil in perfiles %}
                    <tr>
                        <td>{{ perfil.usuario.first_name }} {{ perfil.usuario.last_name }}</td>
                        <td>{{ perfil.usuario.email }}</td>
                        <td>{{ perfil.usuario.rut }}</td>
                        <td>
                            {% if perfil.rol %}
                                <span class="status status-en_proceso">{{ perfil.rol.nombre_rol }}</span>
                            {% else %}
                                <span class="status status-rechazado">Sin rol</span>
                            {% endif %}
                        </td>
                        <td>{{ perfil.area.nombre|default:'N/A' }}</td>
                        <td>
                            {% if perfil.usuario.is_active %}
                                <span class="status status-aprobado">
                                    <i class="fas fa-check-circle"></i> Activo
                                </span>
                            {% else %}
                                <span class="status status-rechazado">
                                    <i class="fas fa-times-circle"></i> Inactivo
                                </span>
                            {% endif %}
                        </td>
                        <td>
                            <button type="button" class="btn-accion btn-accion-gray btn-accion-small" 
                                    onclick="abrirModalEditar(
                                        {{ perfil.id }}, 
                                        '{{ perfil.usuario.email|escapejs }}', 
                                        '{{ perfil.usuario.first_name|escapejs }}',
                                        '{{ perfil.usuario.last_name|escapejs }}',
                                        '{{ perfil.usuario.rut|escapejs }}',
                                        '{{ perfil.rol.id|default:'' }}', 
                                        '{{ perfil.area.id|default:'' }}'
                                    )">
                                <i class="fas fa-edit"></i> Editar
                            </button>
                            {% if perfil.usuario.id != user.id and not perfil.usuario.is_superuser %}
                                {% if perfil.usuario.is_active %}
                                    <button type="button" class="btn-accion btn-accion-orange btn-accion-small" 
                                            onclick="confirmarDesactivarUsuario({{ perfil.id }}, '{{ perfil.usuario.email|escapejs }}')"
                                            title="Desactivar usuario">
                                        <i class="fas fa-user-slash"></i> Desactivar
                                    </button>
                                {% else %}
                                    <button type="button" class="btn-accion btn-accion-green btn-accion-small" 
                                            onclick="confirmarActivarUsuario({{ perfil.id }}, '{{ perfil.usuario.email|escapejs }}')"
                                            title="Activar usuario">
                                        <i class="fas fa-user-check"></i> Activar
                                    </button>
                                {% endif %}
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="7">
                            <div class="empty-state">
                                <i class="fas fa-users"></i>
                                <p>No hay usuarios en el sistema.</p>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            
            <div class="table-footer">
                <span>
                    Mostrando {{ perfiles.start_index }} - {{ perfiles.end_index }} de {{ perfiles.paginator.count }} usuario{{ perfiles.paginator.count|pluralize }}
                    {% if filtros_aplicados.q or filtros_aplicados.rol or filtros_aplicados.area %}
                        <span style="color: #666; font-size: 0.9em;">
                            (filtros aplicados)
                        </span>
                    {% endif %}
                </span>
            </div>
            
            <!-- Paginación de Usuarios -->
            {% if perfiles.has_other_pages %}
            <div class="pagination-container" style="margin-top: 15px; display: flex; justify-content: center; align-items: center; gap: 10px;">
                {% if perfiles.has_previous %}
                    <a href="?{% if filtros_aplicados.q %}q={{ filtros_aplicados.q }}&{% endif %}{% if filtros_aplicados.rol %}rol={{ filtros_aplicados.rol }}&{% endif %}{% if filtros_aplicados.area %}area={{ filtros_aplicados.area }}&{% endif %}page_usuarios=1" class="btn-accion btn-accion-gray btn-accion-small">
                        <i class="fas fa-angle-double-left"></i>
                    </a>
                    <a href="?{% if filtros_aplicados.q %}q={{ filtros_aplicados.q }}&{% endif %}{% if filtros_aplicados.rol %}rol={{ filtros_aplicados.rol }}&{% endif %}{% if filtros_aplicados.area %}area={{ filtros_aplicados.area }}&{% endif %}page_usuarios={{ perfiles.previous_page_number }}" class="btn-accion btn-accion-gray btn-accion-small">
                        <i class="fas fa-angle-left"></i> Anterior
                    </a>
                {% endif %}
                
                <span class="pagination-info">
                    Página {{ perfiles.number }} de {{ perfiles.paginator.num_pages }}
                </span>
                
                {% if perfiles.has_next %}
                    <a href="?{% if filtros_aplicados.q %}q={{ filtros_aplicados.q }}&{% endif %}{% if filtros_aplicados.rol %}rol={{ filtros_aplicados.rol }}&{% endif %}{% if filtros_aplicados.area %}area={{ filtros_aplicados.area }}&{% endif %}page_usuarios={{ perfiles.next_page_number }}" class="btn-accion btn-accion-gray btn-accion-small">
                        Siguiente <i class="fas fa-angle-right"></i>
                    </a>
                    <a href="?{% if filtros_aplicados.q %}q={{ filtros_aplicados.q }}&{% endif %}{% if filtros_aplicados.rol %}rol={{ filtros_aplicados.rol }}&{% endif %}{% if filtros_aplicados.area %}area={{ filtros_aplicados.area }}&{% endif %}page_usuarios={{ perfiles.paginator.num_pages }}" class="btn-accion btn-accion-gray btn-accion-small">
                        <i class="fas fa-angle-double-right"></i>
                    </a>
                {% endif %}
            </div>
            {% endif %}
            
            <!-- Mensajes de la sección Usuarios -->
            {% if messages %}
                {% for message in messages %}
                    {% if 'usuarios' in message.tags %}
                    <div class="alert alert-{% if message.level == 25 %}success{% elif message.level == 40 %}error{% else %}info{% endif %} custom-alert-{% if message.level == 25 %}success{% elif message.level == 40 %}error{% else %}info{% endif %}" style="margin-top: 15px;">
                        {{ message }}
                    </div>
                    {% endif %}
                {% endfor %}
            {% endif %}
        </section>

        <!-- Tabla de Roles (Abajo) -->
        <section class="table-container" id="seccion-roles">
            <div class="table-header">
                <h2 class="titulo-roles"><i class="fas fa-user-tag"></i> Gestión de Roles</h2>
                <button type="button" class="btn-accion btn-asignar" onclick="abrirModalAgregarRol()">
                    <i class="fas fa-plus"></i> Agregar
                </button>
            </div>
            
            <table class="custom-table table-roles">
                <thead>
                    <tr>
                        <th>Nombre del Rol</th>
                        <th>Usuarios</th>
                        <th>Acción</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Usamos la variable 'roles_list' del contexto -->
                    {% for rol in roles_list %}
                    <tr>
                        <td>{{ rol.nombre_rol }}</td>
                        <td>
                            <span class="badge-usuarios">
                                <i class="fas fa-users"></i> {{ rol.num_usuarios }} usuario{{ rol.num_usuarios|pluralize }}
                            </span>
                        </td>
                        <td>
                            <button type="button" class="btn-accion btn-accion-gray btn-accion-small" 
                                    onclick="abrirModalEditarRol({{ rol.id }}, '{{ rol.nombre_rol|escapejs }}')">
                                <i class="fas fa-edit"></i> Editar
                            </button>
                            <button type="button" class="btn-accion btn-accion-red btn-accion-small" 
                                    onclick="abrirModalEliminarRol({{ rol.id }}, '{{ rol.nombre_rol|escapejs }}')">
                                <i class="fas fa-trash"></i> Eliminar
                            </button>
                        </td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="3">No hay roles registrados.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
            
            <div class="table-footer">
                <span>
                    Mostrando {{ roles_list.start_index }} - {{ roles_list.end_index }} de {{ roles_list.paginator.count }} rol{{ roles_list.paginator.count|pluralize:"es" }}
                </span>
            </div>
            
            <!-- Paginación de Roles -->
            {% if roles_list.has_other_pages %}
            <div class="pagination-container" style="margin-top: 15px; display: flex; justify-content: center; align-items: center; gap: 10px;">
                {% if roles_list.has_previous %}
                    <a href="?{% if filtros_aplicados.q %}q={{ filtros_aplicados.q }}&{% endif %}{% if filtros_aplicados.rol %}rol={{ filtros_aplicados.rol }}&{% endif %}{% if filtros_aplicados.area %}area={{ filtros_aplicados.area }}&{% endif %}page_roles=1" class="btn-accion btn-accion-gray btn-accion-small">
                        <i class="fas fa-angle-double-left"></i>
                    </a>
                    <a href="?{% if filtros_aplicados.q %}q={{ filtros_aplicados.q }}&{% endif %}{% if filtros_aplicados.rol %}rol={{ filtros_aplicados.rol }}&{% endif %}{% if filtros_aplicados.area %}area={{ filtros_aplicados.area }}&{% endif %}page_roles={{ roles_list.previous_page_number }}" class="btn-accion btn-accion-gray btn-accion-small">
                        <i class="fas fa-angle-left"></i> Anterior
                    </a>
                {% endif %}
                
                <span class="pagination-info">
                    Página {{ roles_list.number }} de {{ roles_list.paginator.num_pages }}
                </span>
                
                {% if roles_list.has_next %}
                    <a href="?{% if filtros_aplicados.q %}q={{ filtros_aplicados.q }}&{% endif %}{% if filtros_aplicados.rol %}rol={{ filtros_aplicados.rol }}&{% endif %}{% if filtros_aplicados.area %}area={{ filtros_aplicados.area }}&{% endif %}page_roles={{ roles_list.next_page_number }}" class="btn-accion btn-accion-gray btn-accion-small">
                        Siguiente <i class="fas fa-angle-right"></i>
                    </a>
                    <a href="?{% if filtros_aplicados.q %}q={{ filtros_aplicados.q }}&{% endif %}{% if filtros_aplicados.rol %}rol={{ filtros_aplicados.rol }}&{% endif %}{% if filtros_aplicados.area %}area={{ filtros_aplicados.area }}&{% endif %}page_roles={{ roles_list.paginator.num_pages }}" class="btn-accion btn-accion-gray btn-accion-small">
                        <i class="fas fa-angle-double-right"></i>
                    </a>
                {% endif %}
            </div>
            {% endif %}
            
            <!-- Mensajes de la sección Roles -->
            {% if messages %}
                {% for message in messages %}
                    {% if 'roles' in message.tags %}
                    <div class="alert alert-{% if message.level == 25 %}success{% elif message.level == 40 %}error{% else %}info{% endif %} custom-alert-{% if message.level == 25 %}success{% elif message.level == 40 %}error{% else %}info{% endif %}" style="margin-top: 15px;">
                        {{ message }}
                    </div>
                    {% endif %}
                {% endfor %}
            {% endif %}
        </section>

    </div> <!-- Fin del .panel-control-container -->
    <!-- ======================= FIN MODIFICACIÓN ======================= -->

</div>

<!-- =================================================================
     MODALES DE USUARIOS
================================================================== -->

<!-- Modal para AGREGAR Usuario -->
<div id="modalAgregar" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h4><i class="fas fa-user-plus"></i> Agregar Nuevo Usuario</h4>
            <button class="close" onclick="cerrarModalAgregar()">&times;</button>
        </div>
        <form method="post" action="{% url 'agregar_usuario_admin' %}">
            {% csrf_token %}
            
            <div class="form-grid">
                <div class="form-group">
                    <label for="first_name">Nombres:</label>
                    <input type="text" name="first_name" id="first_name" required>
                </div>
                <div class="form-group">
                    <label for="last_name">Apellidos:</label>
                    <input type="text" name="last_name" id="last_name" required>
                </div>
                <div class="form-group">
                    <label for="email">Email:</label>
                    <input type="email" name="email" id="email" required>
                </div>
                <div class="form-group">
                    <label for="rut">RUT:</label>
                    <input type="text" name="rut" id="rut" placeholder="12345678-K" required>
                </div>
            </div>
            
            <div class="form-group">
                <label for="password">Contraseña Temporal:</label>
                <input type="password" name="password" id="password" required>
                <small id="password-error" class="password-error-message" style="display: none; color: #dc3545; margin-top: 0.25rem;"></small>
                <small class="form-hint" style="display: block; margin-top: 0.25rem; color: #666; font-size: 0.875rem;">
                    Mínimo 8 caracteres, debe incluir letras y números.
                </small>
            </div>
            
            <div class="form-group">
                <label for="rol_id">Asignar Rol:</label>
                <select name="rol_id" id="rol_id" required>
                    <option value="">-- Seleccione un rol --</option>
                    {% for rol in roles_disponibles %}
                        <option value="{{ rol.id }}">{{ rol.nombre_rol }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="form-group">
                <label for="area_id">Asignar Área (Opcional):</label>
                <select name="area_id" id="area_id">
                    <option value="">-- Ninguna --</option>
                    {% for area in areas_disponibles %}
                        <option value="{{ area.id }}">{{ area.nombre }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="form-actions">
                <button type="button" class="btn-accion btn-accion-gray" onclick="cerrarModalAgregar()">Cancelar</button>
                <button type="submit" class="btn-accion btn-asignar">
                    <i class="fas fa-save"></i> Guardar Usuario
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Modal para EDITAR Usuario -->
<div id="modalEditar" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h4><i class="fas fa-edit"></i> Editar Usuario</h4>
            <button class="close" onclick="cerrarModalEditar()">&times;</button>
        </div>
        <form method="post" action="" id="formEditar">
            {% csrf_token %}
            
            <div class="form-group">
                <label>Email (No se puede cambiar):</label>
                <input type="email" id="editar_email" class="input-readonly" readonly>
            </div>

            <div class="form-grid">
                <div class="form-group">
                    <label for="editar_first_name">Nombres:</label>
                    <input type="text" name="first_name" id="editar_first_name" required>
                </div>
                <div class="form-group">
                    <label for="editar_last_name">Apellidos:</label>
                    <input type="text" name="last_name" id="editar_last_name" required>
                </div>
            </div>

            <div class="form-group">
                <label for="editar_rut">RUT:</label>
                <input type="text" name="rut" id="editar_rut" placeholder="12345678-K" required>
            </div>

            <div class="form-group">
                <label for="editar_password">Nueva Contraseña:</label>
                <input type="password" name="password" id="editar_password">
                <small id="editar_password-error" class="password-error-message" style="display: none; color: #dc3545; margin-top: 0.25rem;"></small>
                <small class="nota-cambio-pass">Dejar en blanco para no cambiar la contraseña actual.</small>
                <small class="form-hint" style="display: block; margin-top: 0.25rem; color: #666; font-size: 0.875rem;">
                    Si desea cambiar la contraseña: mínimo 8 caracteres, debe incluir letras y números.
                </small>
            </div>
            
            <div class="form-group">
                <label for="editar_rol_id">Rol:</label>
                <select name="rol_id" id="editar_rol_id" required>
                    {% for rol in roles_disponibles %}
                        <option value="{{ rol.id }}">{{ rol.nombre_rol }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label for="editar_area_id">Área (Opcional):</label>
                <select name="area_id" id="editar_area_id">
                    <option value="">-- Ninguna --</option>
                    {% for area in areas_disponibles %}
                        <option value="{{ area.id }}">{{ area.nombre }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="form-actions">
                <button type="button" class="btn-accion btn-accion-gray" onclick="cerrarModalEditar()">Cancelar</button>
                <button type="submit" class="btn-accion btn-agendar">
                    <i class="fas fa-save"></i> Actualizar Usuario
                </button>
            </div>
        </form>
    </div>
</div>

<!-- =================================================================
     MODALES DE ROLES
================================================================== -->

<!-- Modal Agregar Rol -->
<div id="modalAgregarRol" class="modal">
    <div class="modal-content modal-500">
        <div class="modal-header">
            <h4><i class="fas fa-user-tag"></i> Agregar Nuevo Rol</h4>
            <button class="close" onclick="cerrarModalAgregarRol()">&times;</button>
        </div>
        <form method="post" action="{% url 'agregar_rol_admin' %}">
            {% csrf_token %}
            <div class="form-group">
                <label for="nombre_rol">Nombre del Rol:</label>
                <input type="text" name="nombre_rol" required>
            </div>
            <div class="form-actions">
                <button type="button" class="btn-accion btn-accion-gray" onclick="cerrarModalAgregarRol()">Cancelar</button>
                <button type="submit" class="btn-accion btn-asignar">Guardar Rol</button>
            </div>
        </form>
    </div>
</div>

<!-- Modal Editar Rol -->
<div id="modalEditarRol" class="modal">
    <div class="modal-content modal-500">
        <div class="modal-header">
            <h4><i class="fas fa-edit"></i> Editar Rol</h4>
            <button class="close" onclick="cerrarModalEditarRol()">&times;</button>
        </div>
        <form method="post" action="" id="formEditarRol">
            {% csrf_token %}
            <div class="form-group">
                <label for="nombre_rol">Nombre del Rol:</label>
                <input type="text" name="nombre_rol" id="editar_nombre_rol" required>
            </div>
            <div class="form-actions">
                <button type="button" class="btn-accion btn-accion-gray" onclick="cerrarModalEditarRol()">Cancelar</button>
                <button type="submit" class="btn-accion btn-agendar">Actualizar Rol</button>
            </div>
        </form>
    </div>
</div>

<!-- Modal Eliminar Rol -->
<div id="modalEliminarRol" class="modal">
    <div class="modal-content modal-500">
        <div class="modal-header">
            <h4><i class="fas fa-trash"></i> Eliminar Rol</h4>
            <button class="close" onclick="cerrarModalEliminarRol()">&times;</button>
        </div>
        <form method="post" action="" id="formEliminarRol">
            {% csrf_token %}
            <div class="form-group">
                <label>Rol a eliminar:</label>
                <input type="text" id="eliminar_rol_nombre" class="input-readonly" readonly>
            </div>
            <div class="form-group">
                <p class="text-danger font-weight-500">¿Está seguro de que desea eliminar este rol?</p>
                <p class="text-muted">Nota: No se puede eliminar un rol si hay usuarios asignados a él.</p>
            </div>
            <div class="form-actions">
                <button type="button" class="btn-accion btn-accion-gray" onclick="cerrarModalEliminarRol()">Cancelar</button>
                <button type="submit" class="btn-accion btn-accion-red">
                    <i class="fas fa-trash"></i> Eliminar Rol
                </button>
            </div>
        </form>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
    // Asegurar que las funciones estén disponibles cuando se cargue el DOM
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM cargado, verificando funciones de activar/desactivar usuario');
        
        // Verificar que las funciones estén disponibles
        if (typeof window.confirmarDesactivarUsuario === 'function') {
            console.log('confirmarDesactivarUsuario está disponible');
        } else {
            console.error('confirmarDesactivarUsuario NO está disponible');
        }
        
        if (typeof window.confirmarActivarUsuario === 'function') {
            console.log('confirmarActivarUsuario está disponible');
        } else {
            console.error('confirmarActivarUsuario NO está disponible');
        }
        
        // Verificar token CSRF
        const csrfToken = obtenerTokenCSRF();
        if (csrfToken) {
            console.log('Token CSRF encontrado');
        } else {
            console.error('Token CSRF NO encontrado');
        }
    });
</script>
{% endblock %}