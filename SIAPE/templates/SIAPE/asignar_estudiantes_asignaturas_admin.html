{% extends "plantilla.html" %}
{% load static %}

{% block title %}
    Asignar Estudiantes a Asignaturas | SIAPE
{% endblock %}

{% block extra_head %}
    <link rel="stylesheet" href="{% static 'CSS/dashboard.css' %}">
{% endblock %}

{% block content %}
<div class="main-content"> 
    
    <nav class="dashboard-nav">
        <a href="{% url 'dashboard_admin' %}" class="nav-item">
            <i class="fas fa-shield-alt"></i>
            Panel Principal
        </a>
        <a href="{% url 'gestion_usuarios_admin' %}" class="nav-item">
            <i class="fas fa-users-cog"></i>
            Gestión de Usuarios
        </a>
        <a href="{% url 'gestion_institucional_admin' %}" class="nav-item">
            <i class="fas fa-landmark"></i>
            Gestión Institucional
        </a>
        <a href="{% url 'asignar_estudiantes_asignaturas_admin' %}" class="nav-item active">
            <i class="fas fa-user-graduate"></i>
            Asignar Estudiantes a Asignaturas
        </a>
    </nav>

    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} custom-alert-{{ message.tags }}">
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}

    <!-- ======================= FORMULARIO DE ASIGNACIÓN ======================= -->
    <section class="panel-section">
        <h3><i class="fas fa-link"></i> Asignar Estudiante a Asignaturas</h3>
        
        <form method="POST" action="{% url 'asignar_estudiantes_asignaturas_admin' %}">
            {% csrf_token %}
            
            <div class="form-grid">
                <div class="form-group">
                    <label for="carrera">Filtrar por Carrera (Opcional):</label>
                    <select name="carrera" id="carrera" onchange="this.form.submit()" class="form-control">
                        <option value="">Todas las carreras</option>
                        {% for carrera in carreras_list %}
                            <option value="{{ carrera.id }}" {% if carrera_seleccionada and carrera_seleccionada.id == carrera.id %}selected{% endif %}>
                                {{ carrera.nombre }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div class="form-grid">
                <div class="form-group">
                    <label for="estudiante">Estudiante: <span style="color: #cc0000;">*</span></label>
                    <select name="estudiante" id="estudiante" required class="form-control">
                        <option value="">Seleccione un estudiante</option>
                        {% for estudiante in estudiantes_list %}
                            <option value="{{ estudiante.id }}">
                                {{ estudiante.nombres }} {{ estudiante.apellidos }} - {{ estudiante.rut }} ({{ estudiante.carreras.nombre }})
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label for="estado">Estado de la Asignación:</label>
                    <select name="estado" id="estado" class="form-control">
                        <option value="True" selected>Activo</option>
                        <option value="False">Inactivo</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label>Asignaturas: <span style="color: #cc0000;">*</span></label>
                <div style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; border-radius: 6px; padding: 10px; background-color: #f9f9f9;">
                    {% if asignaturas_list %}
                        {% for asignatura in asignaturas_list %}
                            <div style="padding: 8px; border-bottom: 1px solid #eee;">
                                <label style="display: flex; align-items: center; cursor: pointer; margin: 0;">
                                    <input type="checkbox" name="asignaturas" value="{{ asignatura.id }}" style="margin-right: 10px;">
                                    <div>
                                        <strong>{{ asignatura.nombre }} - {{ asignatura.seccion }}</strong>
                                        <br>
                                        <small style="color: #666;">
                                            Carrera: {{ asignatura.carreras.nombre }} | 
                                            Docente: {{ asignatura.docente.usuario.first_name }} {{ asignatura.docente.usuario.last_name }}
                                        </small>
                                    </div>
                                </label>
                            </div>
                        {% endfor %}
                    {% else %}
                        <p style="color: #777; padding: 10px; text-align: center;">
                            {% if carrera_seleccionada %}
                                No hay asignaturas disponibles para la carrera seleccionada.
                            {% else %}
                                No hay asignaturas disponibles. Por favor, filtre por una carrera.
                            {% endif %}
                        </p>
                    {% endif %}
                </div>
                <small style="color: #666; margin-top: 5px; display: block;">
                    Seleccione una o más asignaturas para asignar al estudiante.
                </small>
            </div>

            <div class="form-actions">
                <button type="submit" class="btn-accion btn-accion-green">
                    <i class="fas fa-save"></i> Asignar
                </button>
                <a href="{% url 'asignar_estudiantes_asignaturas_admin' %}" class="btn-accion btn-accion-gray">
                    <i class="fas fa-times"></i> Cancelar
                </a>
            </div>
        </form>
    </section>

    <!-- ======================= TABLA DE ASIGNACIONES RECIENTES ======================= -->
    <section class="table-container">
        <div class="table-header">
            <h2><i class="fas fa-list"></i> Asignaciones Recientes</h2>
        </div>
        
        <table class="custom-table">
            <thead>
                <tr>
                    <th>Estudiante</th>
                    <th>RUT</th>
                    <th>Carrera</th>
                    <th>Asignatura</th>
                    <th>Sección</th>
                    <th>Docente</th>
                    <th>Estado</th>
                    <th>Fecha Asignación</th>
                </tr>
            </thead>
            <tbody>
                {% for asignacion in asignaciones_list %}
                <tr>
                    <td>{{ asignacion.estudiantes.nombres }} {{ asignacion.estudiantes.apellidos }}</td>
                    <td>{{ asignacion.estudiantes.rut }}</td>
                    <td>{{ asignacion.estudiantes.carreras.nombre }}</td>
                    <td>{{ asignacion.asignaturas.nombre }}</td>
                    <td>{{ asignacion.asignaturas.seccion }}</td>
                    <td>{{ asignacion.asignaturas.docente.usuario.first_name }} {{ asignacion.asignaturas.docente.usuario.last_name }}</td>
                    <td>
                        {% if asignacion.estado %}
                            <span class="status status-aprobado">Activo</span>
                        {% else %}
                            <span class="status status-rechazado">Inactivo</span>
                        {% endif %}
                    </td>
                    <td>{{ asignacion.created_at|date:"d/m/Y H:i" }}</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="8">
                        <div class="empty-state">
                            <i class="fas fa-inbox"></i>
                            <p>No hay asignaciones registradas.</p>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </section>

</div>

<script>
    // Auto-submit del formulario cuando se cambia la carrera
    document.getElementById('carrera').addEventListener('change', function() {
        // El formulario se envía automáticamente con el onchange
    });
</script>

{% endblock %}

